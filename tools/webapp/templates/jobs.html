{% extends "layout.html" %}
{% load webapp_tags %}
{% block content %}
<h2>Your Jobs</h2>
<table>
  <thead>
    <tr><th>ID</th><th>Game</th><th>Dir</th><th>Slurm Job</th><th>Status</th><th>Created</th><th>Updated</th></tr>
  </thead>
  <tbody>
  {% for j in jobs %}
    <tr>
      <td>{{ j.id }}</td>
      <td>{{ j.game_id|default_if_none:"" }}</td>
      <td><code>{{ j.dir_path }}</code></td>
      <td>{{ j.slurm_job_id|default_if_none:"" }}</td>
      <td><span class="status-badge status-{{ j.status|default_if_none:""|upper }}">{{ j.status }}</span></td>
      <td>{{ j.created_at|fmt_date }}</td>
      <td>{{ j.updated_at|fmt_date }}</td>
    </tr>
  {% endfor %}
  </tbody>
</table>
<script>
  (function () {
    var finalStates = { 'COMPLETED':1, 'FAILED':1, 'CANCELLED':1, 'TIMEOUT':1 };
    var rows = document.querySelectorAll('table tbody tr');
    var needsRefresh = false;
    rows.forEach(function (tr) {
      var statusCell = tr.children[4];
      if (statusCell) {
        var st = (statusCell.textContent || '').trim().toUpperCase();
        if (!finalStates[st]) needsRefresh = true;
      }
    });
    if (needsRefresh) {
      var note = document.createElement('div');
      note.textContent = 'Auto-refreshing while jobs are pending/runningâ€¦';
      note.style.marginTop = '0.5rem';
      note.style.fontSize = '0.9rem';
      document.body.appendChild(note);
      setTimeout(function () { window.location.reload(); }, 5000);
    }
  })();
</script>
{% endblock %}

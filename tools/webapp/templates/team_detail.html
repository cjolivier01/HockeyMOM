{% extends 'layout.html' %}
{% block content %}
{% set base = ('/public/leagues/%s' % public_league_id) if public_league_id is defined else '' %}
<div style="display:flex;align-items:center;gap:1rem;">
  {% if team['logo_path'] %}
    <img src="{{ base }}/media/team_logo/{{ team['id'] }}" alt="logo" style="width:150px;height:150px;border-radius:14px;object-fit:cover;border:1px solid var(--border);" />
  {% else %}
    <div style="width:150px;height:150px;border-radius:14px;background:#1c212c;border:1px solid var(--border);"></div>
  {% endif %}
  <div>
    <h2 style="margin:0">{{ team['name'] }}</h2>
    {% if team['is_external'] %}<p class="muted" style="margin:.25rem 0 0">External team</p>{% endif %}
  </div>
</div>

{% if schedule_games is defined %}
  <h3 style="margin-top:1.25rem;">Schedule</h3>
  <div class="card">
    {% set show_division = (schedule_games and schedule_games[0].get('division_name') is not none) %}
    <div style="overflow-x:auto;">
      <table>
        <thead>
          <tr>
            {% if show_division %}<th>Division</th>{% endif %}
            <th>Date</th>
            <th>Time</th>
            <th>Matchup</th>
            <th>Location</th>
            <th>Score</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          {% for g in schedule_games %}
            <tr>
              {% if show_division %}<td>{{ g.get('division_name') or '' }}</td>{% endif %}
              <td>{{ (g.get('starts_at') or '')|fmt_date }}</td>
              <td>{{ (g.get('starts_at') or '')|fmt_time }}</td>
              <td>
                <span style="display:inline-flex;align-items:center;gap:8px;flex-wrap:wrap;">
                  <span style="display:inline-flex;align-items:center;gap:6px;">
                    <img src="{{ base }}/media/team_logo/{{ g['team1_id'] }}" alt="" style="width:22px;height:22px;border-radius:6px;object-fit:cover;" onerror="this.style.display='none'" />
                    <span>{{ g.get('team1_name') or '' }}</span>
                  </span>
                  <span class="muted">vs</span>
                  <span style="display:inline-flex;align-items:center;gap:6px;">
                    <img src="{{ base }}/media/team_logo/{{ g['team2_id'] }}" alt="" style="width:22px;height:22px;border-radius:6px;object-fit:cover;" onerror="this.style.display='none'" />
                    <span>{{ g.get('team2_name') or '' }}</span>
                  </span>
                </span>
              </td>
              <td>{{ g.get('location') or '' }}</td>
              <td>
                {% if g.get('team1_score') is not none and g.get('team2_score') is not none %}
                  {{ g.get('team1_score') }} - {{ g.get('team2_score') }}
                {% else %}
                  <span class="muted">â€”</span>
                {% endif %}
              </td>
              <td>
                {% if public_league_id is defined %}
                  <a class="btn" href="{{ base }}/hky/games/{{ g['id'] }}">View</a>
                {% else %}
                  <a class="btn" href="/hky/games/{{ g['id'] }}">Edit</a>
                {% endif %}
              </td>
            </tr>
          {% else %}
            <tr><td colspan="{{ 7 if show_division else 6 }}" class="muted">No games yet.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
{% endif %}

<div class="grid" style="margin-top:1rem;">
  <div class="card">
    <h3>Team Stats</h3>
    {% set s = tstats %}
    <p class="muted">Record: <strong>{{ s['wins'] }}-{{ s['losses'] }}-{{ s['ties'] }}</strong> | GF: {{ s['gf'] }} | GA: {{ s['ga'] }} | Pts: {{ s['points'] }}</p>
  </div>
  <div class="card">
    <h3>Manage</h3>
    {% if editable %}
      <p><a class="btn" href="/teams/{{ team['id'] }}/edit">Edit team</a> <a class="btn" href="/schedule/new">Add game</a></p>
    {% else %}
      <p class="muted">Read-only</p>
    {% endif %}
  </div>
</div>

<h3>Players</h3>
<div class="card">
  <div style="overflow-x:auto;">
    <table>
      <thead>
        <tr><th>#</th><th>Name</th><th>Pos</th><th>G</th><th>A</th><th>P</th><th>S</th><th>SOG</th><th>xG</th><th>TOI</th><th>Sh</th><th>+/-</th><th>PIM</th><th></th></tr>
      </thead>
      <tbody>
        {% for p in players %}
          {% set agg = player_totals.get(p['id'], {'goals':0,'assists':0,'points':0,'shots':0,'sog':0,'expected_goals':0,'toi_seconds':0,'shifts':0,'plus_minus':0,'pim':0}) %}
          <tr>
            <td>{{ p['jersey_number'] or '' }}</td>
            <td>{{ p['name'] }}</td>
            <td>{{ p['position'] or '' }}</td>
            <td>{{ agg['goals'] }}</td>
            <td>{{ agg['assists'] }}</td>
            <td>{{ agg['points'] }}</td>
            <td>{{ agg['shots'] }}</td>
            <td>{{ agg['sog'] }}</td>
            <td>{{ agg['expected_goals'] }}</td>
            <td>{{ agg['toi_seconds']|fmt_toi }}</td>
            <td>{{ agg['shifts'] }}</td>
            <td>{{ agg['plus_minus'] }}</td>
            <td>{{ agg['pim'] }}</td>
            <td>
              {% if editable %}
                <a class="btn" href="/teams/{{ team['id'] }}/players/{{ p['id'] }}/edit">Edit</a>
                <form style="display:inline" method="post" action="/teams/{{ team['id'] }}/players/{{ p['id'] }}/delete" onsubmit="return confirm('Delete player?');">
                  <button class="btn danger" type="submit">Delete</button>
                </form>
              {% endif %}
            </td>
          </tr>
        {% else %}
          <tr><td colspan="14" class="muted">No players yet.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% if editable %}
    <p><a class="btn primary" href="/teams/{{ team['id'] }}/players/new">Add player</a></p>
  {% endif %}
</div>
{% endblock %}

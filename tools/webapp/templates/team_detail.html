{% extends 'layout.html' %}
{% block content %}
{% set base = ('/public/leagues/%s' % public_league_id) if public_league_id is defined else '' %}
{% set return_to = request.full_path.rstrip('?') %}
{% set return_to_q = ('?return_to=' ~ (return_to|urlencode)) if return_to else '' %}
<div style="margin-bottom:.75rem;">
  <a class="btn" href="#" onclick="history.back(); return false;">Back</a>
</div>
<div style="display:flex;align-items:center;gap:1rem;">
  {% if team['logo_path'] %}
    <img src="{{ base }}/media/team_logo/{{ team['id'] }}" alt="logo" style="width:150px;height:150px;border-radius:14px;object-fit:cover;border:1px solid var(--border);" />
  {% else %}
    <div style="width:150px;height:150px;border-radius:14px;background:#1c212c;border:1px solid var(--border);"></div>
  {% endif %}
  <div>
    <h2 style="margin:0">{{ team['name'] }}</h2>
    {% if team['is_external'] %}<p class="muted" style="margin:.25rem 0 0">External team</p>{% endif %}
  </div>
</div>

{% set has_coaches = (head_coaches is defined and head_coaches) or (assistant_coaches is defined and assistant_coaches) %}
{% if has_coaches %}
  <div class="grid" style="margin-top:1rem; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));">
    <div class="card">
      <h3 style="margin:0 0 .5rem 0;">Coaches</h3>
      {% if head_coaches %}
        <p class="muted" style="margin:.25rem 0 .25rem 0;">Head Coach</p>
        <p style="margin:0">{{ head_coaches | map(attribute='name') | join(', ') }}</p>
      {% endif %}
      {% if assistant_coaches %}
        <p class="muted" style="margin:.75rem 0 .25rem 0;">Assistant Coaches</p>
        <p style="margin:0">{{ assistant_coaches | map(attribute='name') | join(', ') }}</p>
      {% endif %}
    </div>
  </div>
{% endif %}

{% if schedule_games is defined %}
  <h3 style="margin-top:1.25rem;">Schedule</h3>
  <div class="card">
    {% set show_division = (schedule_games and schedule_games[0].get('division_name') is not none) %}
    <div>
          <table class="table-no-scroll-mobile table-fit-always table-never-wrap">
            <thead>
              <tr>
                {% if show_division %}<th>Division</th>{% endif %}
                <th class="nowrap">Date</th>
                <th class="nowrap">Time</th>
                <th>Away</th>
                <th>Home</th>
                <th>Type</th>
                <th>Location</th>
                <th>Score</th>
                <th>Video</th>
                <th></th>
              </tr>
            </thead>
        <tbody>
          {% for g in schedule_games %}
            <tr>
              {% if show_division %}<td>{{ g.get('division_name') or '' }}</td>{% endif %}
              <td class="nowrap">{{ (g.get('starts_at') or '')|fmt_date }}</td>
              <td class="nowrap">{{ (g.get('starts_at') or '')|fmt_time }}</td>
              {% set game_href = base ~ '/hky/games/' ~ g['id'] ~ return_to_q %}
              {% set s1 = g.get('team1_score') %}
              {% set s2 = g.get('team2_score') %}
              {% set has_score = (s1 is not none and s2 is not none) %}
              <td>
                {% if g.get('can_view_summary', True) %}<a href="{{ game_href }}" style="text-decoration:none;color:inherit;">{% endif %}
                <span style="display:inline-flex;align-items:center;gap:6px;">
                  <img src="{{ base }}/media/team_logo/{{ g['team2_id'] }}" alt="" style="width:22px;height:22px;border-radius:6px;object-fit:cover;" onerror="this.style.display='none'" />
                  {% if has_score and s2 > s1 %}
                    <strong>{{ g.get('team2_name') or '' }}</strong>
                  {% else %}
                    <span>{{ g.get('team2_name') or '' }}</span>
                  {% endif %}
                </span>
                {% if g.get('can_view_summary', True) %}</a>{% endif %}
              </td>
              <td>
                {% if g.get('can_view_summary', True) %}<a href="{{ game_href }}" style="text-decoration:none;color:inherit;">{% endif %}
                <span style="display:inline-flex;align-items:center;gap:6px;">
                  <img src="{{ base }}/media/team_logo/{{ g['team1_id'] }}" alt="" style="width:22px;height:22px;border-radius:6px;object-fit:cover;" onerror="this.style.display='none'" />
                  {% if has_score and s1 > s2 %}
                    <strong>{{ g.get('team1_name') or '' }}</strong>
                  {% else %}
                    <span>{{ g.get('team1_name') or '' }}</span>
                  {% endif %}
                </span>
                {% if g.get('can_view_summary', True) %}</a>{% endif %}
              </td>
              {% set gt = g.get('game_type_name') %}
              {% if not gt and (g.get('division_name') or '')|lower == 'external' %}
                {% set gt = 'Tournament' %}
              {% endif %}
              <td>{{ gt or '' }}</td>
              <td>{{ g.get('location') or '' }}</td>
              <td>
                {% if g.get('team1_score') is not none and g.get('team2_score') is not none %}
                  {{ g.get('team1_score') }} - {{ g.get('team2_score') }}
                {% else %}
                  <span class="muted">—</span>
                {% endif %}
              </td>
              <td>
                {% if g.get('game_video_url') %}
                  <a href="{{ g.get('game_video_url')|youtube_best_quality_url }}" target="_blank" rel="noopener noreferrer">Video</a>
                {% else %}
                  <span class="muted">—</span>
                {% endif %}
              </td>
              <td>
                {% if g.get('can_view_summary', True) %}
                  {% if public_league_id is defined %}
                    <a class="btn" href="{{ game_href }}">View</a>
                  {% else %}
                    <a class="btn" href="{{ game_href }}">Edit</a>
                  {% endif %}
                {% else %}
                  <span class="muted">—</span>
                {% endif %}
              </td>
            </tr>
          {% else %}
            <tr><td colspan="{{ 9 if show_division else 8 }}" class="muted">No games yet.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
{% endif %}

<div class="grid" style="margin-top:1rem;">
  <div class="card">
    <h3>Team Stats</h3>
    {% set s = tstats %}
    <p class="muted">Record: <strong>{{ s['wins'] }}-{{ s['losses'] }}-{{ s['ties'] }}</strong> | GF: {{ s['gf'] }} | GA: {{ s['ga'] }} | Pts: {{ s['points'] }}</p>
  </div>
  <div class="card">
    <h3>Manage</h3>
    {% if editable %}
      <p><a class="btn" href="/teams/{{ team['id'] }}/edit">Edit team</a> <a class="btn" href="/schedule/new">Add game</a></p>
    {% else %}
      <p class="muted">Read-only</p>
    {% endif %}
  </div>
</div>

{% if roster_players is defined %}
  <h3 style="margin-top:1.25rem;">Roster</h3>
  <div class="card">
    <div class="table-scroll">
      <table class="table-nowrap table-grid table-sortable" data-sortable="1" data-freeze-cols="2">
        <thead>
          <tr>
            <th>#</th>
            <th>Name</th>
            <th>Pos</th>
            {% if editable %}<th></th>{% endif %}
          </tr>
        </thead>
        <tbody>
          {% for p in (roster_players or []) %}
            <tr>
              <td>{{ p.get('jersey_number') or '' }}</td>
              <td>{{ p.get('name') or '' }}</td>
              <td>{{ p.get('position') or '' }}</td>
              {% if editable %}
                <td>
                  <a class="btn" href="/teams/{{ team['id'] }}/players/{{ p.get('id') }}/edit">Edit</a>
                  <form style="display:inline" method="post" action="/teams/{{ team['id'] }}/players/{{ p.get('id') }}/delete" onsubmit="return confirm('Delete player?');">
                    <button class="btn danger" type="submit">Delete</button>
                  </form>
                </td>
              {% endif %}
            </tr>
          {% else %}
            <tr><td colspan="{{ 3 + (1 if editable else 0) }}" class="muted">No players yet.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% if editable %}
      <p><a class="btn primary" href="/teams/{{ team['id'] }}/players/new">Add player</a></p>
    {% endif %}
  </div>
{% endif %}

<h3>Player Stats (Skaters)</h3>
<div class="card">
  {% if game_type_filter_options is defined and (game_type_filter_options|length) %}
    <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:.5rem;">
      <details id="player-stats-game-type-filter" style="position:relative;">
        <summary class="btn">Game Types: {{ game_type_filter_label or 'All' }}</summary>
        <div style="position:absolute;z-index:50;top:calc(100% + 6px);left:0;min-width:240px;background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:.6rem;opacity:1;">
          <div class="muted" style="font-size:.85rem;margin-bottom:.35rem;">Filter player stats by game type</div>
          {% for opt in (game_type_filter_options or []) %}
            <label style="display:flex;align-items:center;gap:.5rem;padding:.2rem 0;">
              <input class="gt-filter-cb" type="checkbox" value="{{ opt.get('label') }}" {% if opt.get('checked') %}checked{% endif %} />
              <span>{{ opt.get('label') }}</span>
            </label>
          {% endfor %}
          <div style="display:flex;gap:.5rem;flex-wrap:wrap;margin-top:.5rem;">
            <button type="button" class="btn" id="gt-filter-apply">Apply</button>
            <button type="button" class="btn" id="gt-filter-all">All</button>
          </div>
        </div>
      </details>
      <span class="muted">Applies to player stats tables only</span>
    </div>
    <script>
      (function () {
        var root = document.getElementById("player-stats-game-type-filter");
        if (!root) return;
        var applyBtn = document.getElementById("gt-filter-apply");
        var allBtn = document.getElementById("gt-filter-all");
        function getCbs() {
          return Array.prototype.slice.call(root.querySelectorAll("input.gt-filter-cb") || []);
        }
        function applySelection(mode) {
          var cbs = getCbs();
          if (mode === "all") cbs.forEach(function (cb) { cb.checked = true; });
          var checked = cbs.filter(function (cb) { return !!cb.checked; }).map(function (cb) { return String(cb.value || "").trim(); }).filter(Boolean);
          var all = cbs.map(function (cb) { return String(cb.value || "").trim(); }).filter(Boolean);
          var u = new URL(window.location.href);
          u.searchParams.delete("gt");
          // None checked or all checked => default to "All" (no filter param).
          if (checked.length > 0 && checked.length < all.length) {
            checked.forEach(function (v) { u.searchParams.append("gt", v); });
          }
          window.location.href = u.toString();
        }
        if (applyBtn) applyBtn.addEventListener("click", function (e) { e.preventDefault(); applySelection("apply"); try { root.open = false; } catch (e2) {} });
        if (allBtn) allBtn.addEventListener("click", function (e) { e.preventDefault(); applySelection("all"); try { root.open = false; } catch (e2) {} });
      })();
    </script>
  {% endif %}

  {% if player_stats_sources is defined %}
    <p class="muted" style="margin:.25rem 0 0 0;">
      Sources: {% if player_stats_sources %}{{ ', '.join(player_stats_sources) }}{% else %}—{% endif %}
    </p>
  {% endif %}
  {% if player_stats_coverage_total_games is defined %}
    <p class="muted" style="margin:.35rem 0 .75rem 0;">
      Stats may be incomplete. This selection has <strong>{{ player_stats_coverage_total_games }}</strong> completed games; column headers show <strong>(N)</strong> when a stat is available for only <strong>N</strong> of those games.
      {% if player_stats_recent_coverage_total_games is defined and (recent_n is defined) %}
        Recent table counts are over the last <strong>{{ player_stats_recent_coverage_total_games }}</strong> completed games (requested {{ recent_n }}).
      {% endif %}
    </p>
  {% endif %}
  <div class="table-scroll">
    <table class="table-nowrap table-grid table-sortable" data-sortable="1" data-freeze-cols="2">
      <thead>
        <tr>
          <th>#</th>
          <th>Name</th>
          <th>Pos</th>
          {% for col in (player_stats_columns or []) %}
            {% if col is mapping %}
              {% set key = col.get('key') %}
              {% set label = col.get('label') %}
              {% set show_count = col.get('show_count') %}
              {% set n_games = col.get('n_games') %}
            {% else %}
              {% set key = col[0] %}
              {% set label = col[1] %}
              {% set show_count = false %}
              {% set n_games = 0 %}
            {% endif %}
            <th>
              <div>{{ label }}</div>
              {% if show_count %}
                <div class="th-subnote">({{ n_games }} Games)</div>
              {% endif %}
            </th>
          {% endfor %}
        </tr>
      </thead>
      <tbody>
        {% for r in (player_stats_rows or []) %}
          <tr>
            <td>{{ r.get('jersey_number') or '' }}</td>
            <td>{{ r.get('name') or '' }}</td>
            <td>{{ r.get('position') or '' }}</td>
            {% for col in (player_stats_columns or []) %}
              {% if col is mapping %}
                {% set key = col.get('key') %}
              {% else %}
                {% set key = col[0] %}
              {% endif %}
              <td>{{ r.get(key)|fmt_stat }}</td>
            {% endfor %}
          </tr>
        {% else %}
          <tr><td colspan="{{ 3 + (player_stats_columns|length) }}" class="muted">No player stats yet.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<h3 style="margin-top:1.25rem;">Recent Player Stats  -- Are They On a Roll?</h3>
<div class="card">
  {% set sort_key = (recent_sort or 'points') %}
  {% set sort_dir = (recent_dir or 'desc') %}
  {% macro _sort_label(col_key, label) -%}
    {%- if sort_key == col_key -%}
      {{ label }} {{ '▲' if sort_dir == 'asc' else '▼' }}
    {%- else -%}
      {{ label }}
    {%- endif -%}
  {%- endmacro %}
  {% macro _sort_href(col_key) -%}
    {%- set next_dir = 'asc' if (sort_key == col_key and sort_dir == 'desc') else 'desc' -%}
    {{ url_with_args(recent_sort=col_key, recent_dir=next_dir) }}
  {%- endmacro %}

  <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:.75rem;">
    <span class="muted">Last</span>
    <select onchange="window.location=this.value" style="max-width:170px;">
      {% for n in range(1, 11) %}
        <option value="{{ url_with_args(recent_n=n) }}" {% if (recent_n or 5) == n %}selected{% endif %}>{{ n }} games</option>
      {% endfor %}
    </select>
    <span class="muted">per player</span>
  </div>

  <div class="table-scroll">
    <table class="table-nowrap table-grid" data-freeze-cols="2">
      <thead>
        <tr>
          <th><a href="{{ _sort_href('jersey_number') }}" style="text-decoration:none;color:inherit;">{{ _sort_label('jersey_number', '#') }}</a></th>
          <th><a href="{{ _sort_href('name') }}" style="text-decoration:none;color:inherit;">{{ _sort_label('name', 'Name') }}</a></th>
          <th><a href="{{ _sort_href('position') }}" style="text-decoration:none;color:inherit;">{{ _sort_label('position', 'Pos') }}</a></th>
          {% for col in (recent_player_stats_columns or []) %}
            {% if col is mapping %}
              {% set key = col.get('key') %}
              {% set label = col.get('label') %}
              {% set show_count = col.get('show_count') %}
              {% set n_games = col.get('n_games') %}
            {% else %}
              {% set key = col[0] %}
              {% set label = col[1] %}
              {% set show_count = false %}
              {% set n_games = 0 %}
            {% endif %}
            <th>
              <a href="{{ _sort_href(key) }}" style="text-decoration:none;color:inherit;">{{ _sort_label(key, label) }}</a>
              {% if show_count %}
                <div class="th-subnote">({{ n_games }} Games)</div>
              {% endif %}
            </th>
          {% endfor %}
        </tr>
      </thead>
      <tbody>
        {% for r in (recent_player_stats_rows or []) %}
          <tr>
            <td>{{ r.get('jersey_number') or '' }}</td>
            <td>{{ r.get('name') or '' }}</td>
            <td>{{ r.get('position') or '' }}</td>
            {% for col in (recent_player_stats_columns or []) %}
              {% if col is mapping %}
                {% set key = col.get('key') %}
              {% else %}
                {% set key = col[0] %}
              {% endif %}
              <td>{{ r.get(key)|fmt_stat }}</td>
            {% endfor %}
          </tr>
        {% else %}
          <tr><td colspan="{{ 3 + (recent_player_stats_columns|length) }}" class="muted">No recent stats.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}

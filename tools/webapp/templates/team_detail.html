{% extends "layout.html" %}
{% load webapp_tags %}
{% block content %}
{% with return_to=request.get_full_path %}
<div style="margin-bottom:.75rem;">
  <a class="btn" href="#" onclick="history.back(); return false;">Back</a>
</div>

<div style="display:flex;align-items:center;gap:1rem;">
  {% if public_league_id %}
    {% url "public_media_team_logo" league_id=public_league_id team_id=team.id as team_logo_url %}
  {% else %}
    {% url "media_team_logo" team_id=team.id as team_logo_url %}
  {% endif %}
  {% if team.logo_path %}
    <img src="{{ team_logo_url }}" alt="logo" style="width:150px;height:150px;border-radius:14px;object-fit:cover;border:1px solid var(--border);" />
  {% else %}
    <div style="width:150px;height:150px;border-radius:14px;background:#1c212c;border:1px solid var(--border);"></div>
  {% endif %}
  <div>
    <h2 style="margin:0">{{ team.name }}</h2>
    {% if team.is_external %}<p class="muted" style="margin:.25rem 0 0">External team</p>{% endif %}
  </div>
  {% if league_page_views %}
    <div
      data-hm-league-pageviews="1"
      data-league-id="{{ league_page_views.league_id }}"
      data-kind="{{ league_page_views.kind }}"
      data-entity-id="{{ league_page_views.entity_id }}"
      class="muted"
      style="margin-left:auto;font-size:.85rem;white-space:nowrap;"
      title="Live page views (excluding your own views as league owner)"
    >
      Views: <span data-role="count">{{ league_page_views.count }}</span>
    </div>
  {% endif %}
</div>

{% if head_coaches or assistant_coaches %}
  <div class="grid" style="margin-top:1rem; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));">
    <div class="card">
      <h3 style="margin:0 0 .5rem 0;">Coaches</h3>
      {% if head_coaches %}
        <p class="muted" style="margin:.25rem 0 .25rem 0;">Head Coach</p>
        <p style="margin:0">
          {% for c in head_coaches %}
            {{ c.name }}{% if not forloop.last %}, {% endif %}
          {% endfor %}
        </p>
      {% endif %}
      {% if assistant_coaches %}
        <p class="muted" style="margin:.75rem 0 .25rem 0;">Assistant Coaches</p>
        <p style="margin:0">
          {% for c in assistant_coaches %}
            {{ c.name }}{% if not forloop.last %}, {% endif %}
          {% endfor %}
        </p>
      {% endif %}
    </div>
  </div>
{% endif %}

<h3 style="margin-top:1.25rem;">Schedule</h3>
<div class="card">
  <div>
    <table class="table-no-scroll-mobile table-fit-always table-never-wrap">
      <thead>
        <tr>
          {% if schedule_games and schedule_games.0.division_name %}<th>Division</th>{% endif %}
          <th class="nowrap">Date</th>
          <th class="nowrap">Time</th>
          <th>Away</th>
          <th>Home</th>
          <th>Type</th>
          <th>Location</th>
          <th>Score</th>
          <th>Video</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        {% for g in schedule_games %}
          {% if public_league_id %}
            {% url "public_hky_game_detail" league_id=public_league_id game_id=g.id as game_path %}
            {% url "public_media_team_logo" league_id=public_league_id team_id=g.team1_id as team1_logo %}
            {% url "public_media_team_logo" league_id=public_league_id team_id=g.team2_id as team2_logo %}
          {% else %}
            {% url "hky_game_detail" game_id=g.id as game_path %}
            {% url "media_team_logo" team_id=g.team1_id as team1_logo %}
            {% url "media_team_logo" team_id=g.team2_id as team2_logo %}
          {% endif %}
          {% with s1=g.team1_score s2=g.team2_score %}
          <tr>
            {% if schedule_games and schedule_games.0.division_name %}<td>{{ g.division_name|default_if_none:"" }}</td>{% endif %}
            <td class="nowrap">{{ g.starts_at|fmt_date }}</td>
            <td class="nowrap">{{ g.starts_at|fmt_time }}</td>
            <td>
              {% if g.can_view_summary %}<a href="{{ game_path }}?return_to={{ return_to|urlencode }}" style="text-decoration:none;color:inherit;">{% endif %}
              <span style="display:inline-flex;align-items:center;gap:6px;">
                <img src="{{ team2_logo }}" alt="" style="width:22px;height:22px;border-radius:6px;object-fit:cover;" onerror="this.style.display='none'" />
                {% if s1 != None and s2 != None and s2 > s1 %}
                  <strong>{{ g.team2_name }}</strong>
                {% else %}
                  <span>{{ g.team2_name }}</span>
                {% endif %}
              </span>
              {% if g.can_view_summary %}</a>{% endif %}
            </td>
            <td>
              {% if g.can_view_summary %}<a href="{{ game_path }}?return_to={{ return_to|urlencode }}" style="text-decoration:none;color:inherit;">{% endif %}
              <span style="display:inline-flex;align-items:center;gap:6px;">
                <img src="{{ team1_logo }}" alt="" style="width:22px;height:22px;border-radius:6px;object-fit:cover;" onerror="this.style.display='none'" />
                {% if s1 != None and s2 != None and s1 > s2 %}
                  <strong>{{ g.team1_name }}</strong>
                {% else %}
                  <span>{{ g.team1_name }}</span>
                {% endif %}
              </span>
              {% if g.can_view_summary %}</a>{% endif %}
            </td>
            <td>
              {% if g.game_type_name %}
                {{ g.game_type_name }}
              {% elif g.division_name|is_external_division %}
                Tournament
              {% endif %}
            </td>
            <td>{{ g.location|default_if_none:"" }}</td>
            <td>
              {% if s1 != None and s2 != None %}
                {{ s2 }} - {{ s1 }}
              {% else %}
                <span class="muted">—</span>
              {% endif %}
            </td>
            <td>
              {% if g.game_video_url %}
                <a href="{{ g.game_video_url|youtube_best_quality_url }}" target="_blank" rel="noopener noreferrer">Video</a>
              {% else %}
                <span class="muted">—</span>
              {% endif %}
            </td>
            <td>
              {% if g.can_view_summary %}
                {% if public_league_id %}
                  <a class="btn" href="{{ game_path }}?return_to={{ return_to|urlencode }}">View</a>
                {% else %}
                  {% if is_league_admin or g.user_id == request.session.user_id %}
                    <a class="btn" href="{{ game_path }}?return_to={{ return_to|urlencode }}&edit=1">Edit</a>
                  {% else %}
                    <a class="btn" href="{{ game_path }}?return_to={{ return_to|urlencode }}">View</a>
                  {% endif %}
                {% endif %}
              {% else %}
                <span class="muted">—</span>
              {% endif %}
            </td>
          </tr>
          {% endwith %}
        {% empty %}
          {% if schedule_games and schedule_games.0.division_name %}
            <tr><td colspan="9" class="muted">No games yet.</td></tr>
          {% else %}
            <tr><td colspan="8" class="muted">No games yet.</td></tr>
          {% endif %}
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<div class="grid" style="margin-top:1rem;">
  <div class="card">
    <h3>Team Stats</h3>
    <p class="muted">Record: <strong>{{ tstats.wins }}-{{ tstats.losses }}-{{ tstats.ties }}</strong> | GF: {{ tstats.gf }} | GA: {{ tstats.ga }} | Pts: {{ tstats.points }}</p>
  </div>
  <div class="card">
    <h3>Manage</h3>
    {% if editable %}
      <p><a class="btn" href="/teams/{{ team.id }}/edit">Edit team</a> <a class="btn" href="/schedule/new">Add game</a></p>
    {% else %}
      <p class="muted">Read-only</p>
    {% endif %}
  </div>
</div>

{% if roster_players %}
  <h3 style="margin-top:1.25rem;">Roster</h3>
  <div class="card">
    <div class="table-scroll">
      <table class="table-nowrap table-grid table-sortable" data-sortable="1" data-freeze-cols="2">
        <thead>
          <tr>
            <th>#</th>
            <th>Name</th>
            <th>Pos</th>
            {% if editable %}<th></th>{% endif %}
          </tr>
        </thead>
        <tbody>
          {% for p in roster_players %}
            <tr>
              <td>{{ p.jersey_number|default_if_none:"" }}</td>
              <td>{{ p.name|default_if_none:"" }}</td>
              <td>{{ p.position|default_if_none:"" }}</td>
              {% if editable %}
                <td>
                  <a class="btn" href="/teams/{{ team.id }}/players/{{ p.id }}/edit">Edit</a>
                  <form style="display:inline" method="post" action="/teams/{{ team.id }}/players/{{ p.id }}/delete" onsubmit="return confirm('Delete player?');">
                    {% csrf_token %}
                    <button class="btn danger" type="submit">Delete</button>
                  </form>
                </td>
              {% endif %}
            </tr>
          {% empty %}
            {% if editable %}
              <tr><td colspan="4" class="muted">No players yet.</td></tr>
            {% else %}
              <tr><td colspan="3" class="muted">No players yet.</td></tr>
            {% endif %}
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% if editable %}
      <p><a class="btn primary" href="/teams/{{ team.id }}/players/new">Add player</a></p>
    {% endif %}
  </div>
{% endif %}

<h3>Player Stats (Skaters)</h3>
<div class="card">
  {% if game_type_filter_options %}
    <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:.5rem;">
      <details id="player-stats-game-type-filter" style="position:relative;">
        <summary class="btn">Game Types: {{ game_type_filter_label|default:"All" }}</summary>
        <div style="position:absolute;z-index:50;top:calc(100% + 6px);left:0;min-width:240px;background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:.6rem;opacity:1;">
          <div class="muted" style="font-size:.85rem;margin-bottom:.35rem;">Filter player stats by game type</div>
          {% for opt in game_type_filter_options %}
            <label style="display:flex;align-items:center;gap:.5rem;padding:.2rem 0;">
              <input class="gt-filter-cb" type="checkbox" value="{{ opt.label }}" {% if opt.checked %}checked{% endif %} />
              <span>{{ opt.label }}</span>
            </label>
          {% endfor %}
          <div style="display:flex;gap:.5rem;flex-wrap:wrap;margin-top:.5rem;">
            <button type="button" class="btn" id="gt-filter-apply">Apply</button>
            <button type="button" class="btn" id="gt-filter-all">All</button>
          </div>
        </div>
      </details>
      <span class="muted">Applies to player stats tables only</span>
    </div>
    <script>
      (function () {
        var root = document.getElementById("player-stats-game-type-filter");
        if (!root) return;
        var applyBtn = document.getElementById("gt-filter-apply");
        var allBtn = document.getElementById("gt-filter-all");
        function getCbs() {
          return Array.prototype.slice.call(root.querySelectorAll("input.gt-filter-cb") || []);
        }
        function applySelection(mode) {
          var cbs = getCbs();
          if (mode === "all") cbs.forEach(function (cb) { cb.checked = true; });
          var checked = cbs.filter(function (cb) { return !!cb.checked; }).map(function (cb) { return String(cb.value || "").trim(); }).filter(Boolean);
          var all = cbs.map(function (cb) { return String(cb.value || "").trim(); }).filter(Boolean);
          var u = new URL(window.location.href);
          u.searchParams.delete("gt");
          // None checked or all checked => default to "All" (no filter param).
          if (checked.length > 0 && checked.length < all.length) {
            checked.forEach(function (v) { u.searchParams.append("gt", v); });
          }
          window.location.href = u.toString();
        }
        if (applyBtn) applyBtn.addEventListener("click", function (e) { e.preventDefault(); applySelection("apply"); try { root.open = false; } catch (e2) {} });
        if (allBtn) allBtn.addEventListener("click", function (e) { e.preventDefault(); applySelection("all"); try { root.open = false; } catch (e2) {} });
      })();
    </script>
  {% endif %}

  <p class="muted" style="margin:.25rem 0 0 0;">
    Sources: {% if player_stats_sources %}{{ player_stats_sources|join:", " }}{% else %}—{% endif %}
  </p>
  {% if player_stats_coverage_total_games != None %}
    <p class="muted" style="margin:.35rem 0 .75rem 0;">
      Stats may be incomplete. This selection has <strong>{{ player_stats_coverage_total_games }}</strong> completed games; column headers show <strong>(N)</strong> when a stat is available for only <strong>N</strong> of those games.
      {% if player_stats_recent_coverage_total_games != None and recent_n != None %}
        Recent table counts are over the last <strong>{{ player_stats_recent_coverage_total_games }}</strong> completed games (requested {{ recent_n }}).
      {% endif %}
    </p>
  {% endif %}

  <div class="table-scroll">
    <table class="table-nowrap table-grid table-sortable" data-sortable="1" data-freeze-cols="2">
      <thead>
        <tr>
          <th>#</th>
          <th>Name</th>
          <th>Pos</th>
          {% for col in player_stats_columns %}
            <th>
              <div>{{ col.label }}</div>
              {% if col.show_count %}
                <div class="th-subnote">({{ col.n_games }} Games)</div>
              {% endif %}
            </th>
          {% endfor %}
        </tr>
      </thead>
      <tbody>
        {% for r in player_stats_rows %}
          <tr>
            <td>{{ r.jersey_number|default_if_none:"" }}</td>
            <td>
              {% if r.has_events %}
                <button
                  type="button"
                  class="btn secondary player-events-link"
                  data-player-id="{{ r.player_id }}"
                  data-scope="all"
                  data-scope-label="{{ game_type_filter_label|default:'All' }}"
                  title="Show underlying events"
                >{{ r.name|default_if_none:"" }}</button>
              {% else %}
                {{ r.name|default_if_none:"" }}
              {% endif %}
            </td>
            <td>{{ r.position|default_if_none:"" }}</td>
            {% for col in player_stats_columns %}
              {% with denom=r|get_item:"_per_game_denoms"|get_item:col.key %}
                {% if col.key == "toi_seconds" or col.key == "toi_seconds_per_game" %}
                  <td>
                    {{ r|get_item:col.key|fmt_toi }}
                    {% if col.show_count and denom and denom < col.n_games %}
                      {% if col.key == "ppg" or col.key|slice:"-9:" == "_per_game" %}
                        <span class="muted">({{ denom }} games)</span>
                      {% endif %}
                    {% endif %}
                  </td>
                {% else %}
                  <td>
                    {{ r|get_item:col.key|fmt_stat }}
                    {% if col.show_count and denom and denom < col.n_games %}
                      {% if col.key == "ppg" or col.key|slice:"-9:" == "_per_game" %}
                        <span class="muted">({{ denom }} games)</span>
                      {% endif %}
                    {% endif %}
                  </td>
                {% endif %}
              {% endwith %}
            {% endfor %}
          </tr>
        {% empty %}
          <tr><td colspan="{{ player_stats_columns|length|add:'3' }}" class="muted">No player stats yet.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<h3 style="margin-top:1.25rem;">Recent Player Stats  -- Are They On a Roll?</h3>
<div class="card">
  <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:.75rem;">
    <span class="muted">Last</span>
    <select onchange="window.location=this.value" style="max-width:170px;">
      <option value="{% url_with_args recent_n=1 %}" {% if recent_n == 1 %}selected{% endif %}>1 games</option>
      <option value="{% url_with_args recent_n=2 %}" {% if recent_n == 2 %}selected{% endif %}>2 games</option>
      <option value="{% url_with_args recent_n=3 %}" {% if recent_n == 3 %}selected{% endif %}>3 games</option>
      <option value="{% url_with_args recent_n=4 %}" {% if recent_n == 4 %}selected{% endif %}>4 games</option>
      <option value="{% url_with_args recent_n=5 %}" {% if recent_n == 5 %}selected{% endif %}>5 games</option>
      <option value="{% url_with_args recent_n=6 %}" {% if recent_n == 6 %}selected{% endif %}>6 games</option>
      <option value="{% url_with_args recent_n=7 %}" {% if recent_n == 7 %}selected{% endif %}>7 games</option>
      <option value="{% url_with_args recent_n=8 %}" {% if recent_n == 8 %}selected{% endif %}>8 games</option>
      <option value="{% url_with_args recent_n=9 %}" {% if recent_n == 9 %}selected{% endif %}>9 games</option>
      <option value="{% url_with_args recent_n=10 %}" {% if recent_n == 10 %}selected{% endif %}>10 games</option>
    </select>
    <span class="muted">per player</span>
  </div>

  <div class="table-scroll">
    <table class="table-nowrap table-grid" data-freeze-cols="2">
      <thead>
        <tr>
          {% sort_toggle_url "jersey_number" sort_key=recent_sort sort_dir=recent_dir as sort_href %}
          {% sort_label recent_sort recent_dir "jersey_number" "#" as sort_txt %}
          <th><a href="{{ sort_href }}" style="text-decoration:none;color:inherit;">{{ sort_txt }}</a></th>

          {% sort_toggle_url "name" sort_key=recent_sort sort_dir=recent_dir as sort_href %}
          {% sort_label recent_sort recent_dir "name" "Name" as sort_txt %}
          <th><a href="{{ sort_href }}" style="text-decoration:none;color:inherit;">{{ sort_txt }}</a></th>

          {% sort_toggle_url "position" sort_key=recent_sort sort_dir=recent_dir as sort_href %}
          {% sort_label recent_sort recent_dir "position" "Pos" as sort_txt %}
          <th><a href="{{ sort_href }}" style="text-decoration:none;color:inherit;">{{ sort_txt }}</a></th>

          {% for col in recent_player_stats_columns %}
            {% sort_toggle_url col.key sort_key=recent_sort sort_dir=recent_dir as sort_href %}
            {% sort_label recent_sort recent_dir col.key col.label as sort_txt %}
            <th>
              <a href="{{ sort_href }}" style="text-decoration:none;color:inherit;">{{ sort_txt }}</a>
              {% if col.show_count %}
                <div class="th-subnote">({{ col.n_games }} Games)</div>
              {% endif %}
            </th>
          {% endfor %}
        </tr>
      </thead>
      <tbody>
        {% for r in recent_player_stats_rows %}
          <tr>
            <td>{{ r.jersey_number|default_if_none:"" }}</td>
            <td>
              {% if r.has_events %}
                <button
                  type="button"
                  class="btn secondary player-events-link"
                  data-player-id="{{ r.player_id }}"
                  data-scope="recent"
                  data-recent-n="{{ recent_n|default:'5' }}"
                  data-scope-label="Last {{ recent_n|default:'5' }} Games"
                  title="Show underlying events"
                >{{ r.name|default_if_none:"" }}</button>
              {% else %}
                {{ r.name|default_if_none:"" }}
              {% endif %}
            </td>
            <td>{{ r.position|default_if_none:"" }}</td>
            {% for col in recent_player_stats_columns %}
              {% with denom=r|get_item:"_per_game_denoms"|get_item:col.key %}
                {% if col.key == "toi_seconds" or col.key == "toi_seconds_per_game" %}
                  <td>
                    {{ r|get_item:col.key|fmt_toi }}
                    {% if col.show_count and denom and denom < col.n_games %}
                      {% if col.key == "ppg" or col.key|slice:"-9:" == "_per_game" %}
                        <span class="muted">({{ denom }} games)</span>
                      {% endif %}
                    {% endif %}
                  </td>
                {% else %}
                  <td>
                    {{ r|get_item:col.key|fmt_stat }}
                    {% if col.show_count and denom and denom < col.n_games %}
                      {% if col.key == "ppg" or col.key|slice:"-9:" == "_per_game" %}
                        <span class="muted">({{ denom }} games)</span>
                      {% endif %}
                    {% endif %}
                  </td>
                {% endif %}
              {% endwith %}
            {% endfor %}
          </tr>
        {% empty %}
          <tr><td colspan="{{ recent_player_stats_columns|length|add:'3' }}" class="muted">No recent stats.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

{% if recent_goalie_stats_has_sog %}
<h3 style="margin-top:1.25rem;">Goalie Stats (Last {{ recent_n|default:"5" }} Games)</h3>
<div class="card">
  <div class="table-scroll">
    <table class="table-nowrap table-grid" data-freeze-cols="2">
      <thead>
        <tr>
          <th>#</th><th>Name</th><th>GP</th><th>TOI</th><th>GA</th>
          {% if recent_goalie_stats_has_xg %}
            <th>xGA</th><th>xGSV</th><th>xGSV%</th>
          {% endif %}
          <th>SA</th><th>SV</th><th>SV%</th>
          <th>GAA</th>
        </tr>
      </thead>
      <tbody>
        {% for g in recent_goalie_stats_rows %}
          <tr>
            <td>{{ g.jersey_number|default_if_none:"" }}</td>
            <td>
              {% if g.gp %}
                <button
                  type="button"
                  class="btn secondary goalie-stats-link"
                  data-player-id="{{ g.player_id }}"
                  data-scope="recent"
                  data-recent-n="{{ recent_n|default:'5' }}"
                  data-scope-label="Last {{ recent_n|default:'5' }} Games"
                  title="Show underlying games"
                >{{ g.name|default_if_none:"" }}</button>
              {% else %}
                {{ g.name|default_if_none:"" }}
              {% endif %}
            </td>
            <td>{{ g.gp|fmt_stat }}</td>
            <td>{{ g.toi_seconds|fmt_toi }}</td>
            <td>{{ g.ga|fmt_stat }}</td>
            {% if recent_goalie_stats_has_xg %}
              <td>{{ g.xga|fmt_stat }}</td>
              <td>{{ g.xg_saves|fmt_stat }}</td>
              <td>{{ g.xg_sv_pct|fmt_stat }}</td>
            {% endif %}
            <td>{{ g.sa|fmt_stat }}</td>
            <td>{{ g.saves|fmt_stat }}</td>
            <td>{{ g.sv_pct|fmt_stat }}</td>
            <td>{{ g.gaa|fmt_stat }}</td>
          </tr>
        {% empty %}
          <tr><td colspan="{% if recent_goalie_stats_has_xg %}12{% else %}9{% endif %}" class="muted">No recent goalie stats.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endif %}

{% if goalie_stats_has_sog %}
<h3 style="margin-top:1.25rem;">Goalie Stats</h3>
<div class="card">
  <div class="table-scroll">
    <table class="table-nowrap table-grid" data-freeze-cols="2">
      <thead>
        <tr>
          <th>#</th><th>Name</th><th>GP</th><th>TOI</th><th>GA</th>
          {% if goalie_stats_has_xg %}
            <th>xGA</th><th>xGSV</th><th>xGSV%</th>
          {% endif %}
          <th>SA</th><th>SV</th><th>SV%</th>
          <th>GAA</th>
        </tr>
      </thead>
      <tbody>
        {% for g in goalie_stats_rows %}
          <tr>
            <td>{{ g.jersey_number|default_if_none:"" }}</td>
            <td>
              {% if g.gp %}
                <button
                  type="button"
                  class="btn secondary goalie-stats-link"
                  data-player-id="{{ g.player_id }}"
                  data-scope="all"
                  data-scope-label="All Games"
                  title="Show underlying games"
                >{{ g.name|default_if_none:"" }}</button>
              {% else %}
                {{ g.name|default_if_none:"" }}
              {% endif %}
            </td>
            <td>{{ g.gp|fmt_stat }}</td>
            <td>{{ g.toi_seconds|fmt_toi }}</td>
            <td>{{ g.ga|fmt_stat }}</td>
            {% if goalie_stats_has_xg %}
              <td>{{ g.xga|fmt_stat }}</td>
              <td>{{ g.xg_saves|fmt_stat }}</td>
              <td>{{ g.xg_sv_pct|fmt_stat }}</td>
            {% endif %}
            <td>{{ g.sa|fmt_stat }}</td>
            <td>{{ g.saves|fmt_stat }}</td>
            <td>{{ g.sv_pct|fmt_stat }}</td>
            <td>{{ g.gaa|fmt_stat }}</td>
          </tr>
        {% empty %}
          <tr><td colspan="{% if goalie_stats_has_xg %}12{% else %}9{% endif %}" class="muted">No goalie stats yet.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<dialog id="team-goalie-stats-modal" style="max-width:960px;width:96vw;border:none;border-radius:16px;padding:0;box-shadow:0 20px 80px rgba(0,0,0,.35);">
  <div style="padding:12px 14px;border-bottom:1px solid rgba(255,255,255,.08);display:flex;align-items:center;justify-content:space-between;gap:12px;background:rgba(0,0,0,.18);">
    <div>
      <div id="team-goalie-stats-title" style="font-weight:700;"></div>
      <div id="team-goalie-stats-subtitle" class="muted" style="font-size:.9rem;"></div>
    </div>
    <button id="team-goalie-stats-close" class="btn" type="button">Close</button>
  </div>
  <div id="team-goalie-stats-body" style="padding:12px 14px;max-height:70vh;overflow:auto;"></div>
</dialog>
{% endif %}

<dialog id="team-player-events-modal" style="max-width:960px;width:96vw;border:none;border-radius:16px;padding:0;box-shadow:0 20px 80px rgba(0,0,0,.35);">
  <div style="padding:12px 14px;border-bottom:1px solid rgba(255,255,255,.08);display:flex;align-items:center;justify-content:space-between;gap:12px;background:rgba(0,0,0,.18);">
    <div>
      <div id="team-player-events-title" style="font-weight:700;"></div>
      <div id="team-player-events-subtitle" class="muted" style="font-size:.9rem;"></div>
    </div>
    <button id="team-player-events-close" class="btn" type="button">Close</button>
  </div>
  <div id="team-player-events-video-pane" style="display:none;padding:12px 14px;border-bottom:1px solid rgba(255,255,255,.08);background:rgba(0,0,0,.10);">
    <div style="display:flex; align-items:center; justify-content:space-between; gap:1rem; flex-wrap:wrap;">
      <div>
        <strong>Video Clip</strong>
        <span id="team-player-events-video-meta" class="muted" style="margin-left:.5rem;"></span>
      </div>
      <div style="display:flex; align-items:center; gap:.5rem;">
        <a
          id="team-player-events-video-open-link"
          class="btn"
          href=""
          target="_blank"
          rel="noopener noreferrer"
          style="display:none;"
        >Open on YouTube</a>
        <button type="button" class="btn" id="team-player-events-video-close">Close</button>
      </div>
    </div>
    <div style="margin-top:.75rem; width:100%; max-width: 900px;">
      <div style="position:relative; width:100%; aspect-ratio:16/9; background:#0b1220; border-radius:12px; overflow:hidden;">
        <iframe
          id="team-player-events-video-iframe"
          title="Game video clip"
          src=""
          style="position:absolute; inset:0; width:100%; height:100%; border:0;"
          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
          allowfullscreen
        ></iframe>
      </div>
    </div>
    <p class="muted" style="margin:.75rem 0 0 0;">Tip: goals/assists show 20s before and 10s after; other events show 10s before and 10s after.</p>
  </div>
  <div id="team-player-events-body" style="padding:12px 14px;max-height:70vh;overflow:auto;"></div>
</dialog>

<style>
  #team-player-events-body table.team-player-events-table th,
  #team-player-events-body table.team-player-events-table td {
    padding: .45rem .65rem;
    font-size: .88rem;
  }
</style>

<script>
    (function () {
      function normTypeKey(s) {
        return String(s || "").trim().toLowerCase().replace(/[^a-z0-9]+/g, "");
      }
      function parseTimeToSeconds(s) {
        s = String(s || "").trim();
        if (!s) return null;
        var m = s.match(/^(\d+):(\d{2})(?::(\d{2}))?$/);
      if (!m) return null;
      var a = parseInt(m[1], 10);
      var b = parseInt(m[2], 10);
      var c = m[3] ? parseInt(m[3], 10) : null;
      if (!isFinite(a) || !isFinite(b)) return null;
      if (c === null) return a * 60 + b;
      if (!isFinite(c)) return null;
        return a * 3600 + b * 60 + c;
      }

      function fmtSecondsToTime(seconds) {
        var sec = parseInt(String(seconds), 10);
        if (!isFinite(sec) || sec < 0) return "";
        var h = Math.floor(sec / 3600);
        var m = Math.floor((sec % 3600) / 60);
        var s = sec % 60;
        if (h > 0) return String(h) + ":" + (m < 10 ? "0" + String(m) : String(m)) + ":" + (s < 10 ? "0" + String(s) : String(s));
        return String(m) + ":" + (s < 10 ? "0" + String(s) : String(s));
      }

      function fmtDate(value) {
        var s = String(value || "").trim();
        if (!s) return "";
        var m = s.match(/^(\d{4}-\d{2}-\d{2})/);
      return m ? m[1] : s;
    }

      function urlWithTime(url, seconds) {
        if (!url) return "";
        if (seconds === null || seconds === undefined) return String(url);
        var sec = parseInt(String(seconds), 10);
        if (!isFinite(sec) || sec < 0) return String(url);
        try {
          var u = new URL(String(url), window.location.origin);
          var host = String(u.hostname || "").toLowerCase();
          var isYouTube = host.indexOf("youtube.com") >= 0 || host.indexOf("youtu.be") >= 0 || host.indexOf("youtube-nocookie.com") >= 0;
          if (isYouTube) {
            // Prefer a standard watch URL so it plays reliably in a new tab, even if embed URLs are stored.
            var id = null;
            if (host === "youtu.be") {
              var p = String(u.pathname || "").replace(/^\//, "");
              id = p ? p.split("/")[0] : null;
            } else {
              id = u.searchParams.get("v");
              if (!id) {
                var path = String(u.pathname || "");
                var m = path.match(/\/embed\/([^/?#]+)/) || path.match(/\/shorts\/([^/?#]+)/);
                id = m ? m[1] : null;
              }
            }
            if (id) {
              var w = new URL("https://www.youtube.com/watch");
              w.searchParams.set("v", String(id));
              w.searchParams.set("t", String(sec) + "s");
              w.searchParams.set("autoplay", "1");
              w.searchParams.set("vq", "hd1080");
              return w.toString();
            }
            u.searchParams.set("t", String(sec) + "s");
            u.searchParams.set("autoplay", "1");
            u.searchParams.set("vq", "hd1080");
            return u.toString();
          }
          u.hash = "t=" + String(sec);
          return u.toString();
        } catch (e) {
          return String(url);
        }
      }

    function el(tag, attrs, text) {
      var node = document.createElement(tag);
      if (attrs) {
        Object.keys(attrs).forEach(function (k) {
          if (k === "className") node.className = attrs[k];
          else if (k === "text") node.textContent = String(attrs[k] || "");
          else node.setAttribute(k, String(attrs[k]));
        });
      }
      if (text !== undefined && text !== null) node.textContent = String(text);
      return node;
    }

    function addRow(tbody, cols) {
      var tr = document.createElement("tr");
      cols.forEach(function (c) {
        var td = document.createElement("td");
        if (c && c.nodeType) td.appendChild(c);
        else td.textContent = String(c || "");
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    }

    var _tableFitQueued = false;
    function queueTableFit() {
      if (_tableFitQueued) return;
      _tableFitQueued = true;
      window.requestAnimationFrame(function () {
        _tableFitQueued = false;
        try {
          window.dispatchEvent(new Event("resize"));
        } catch (e) {}
      });
    }

    function renderEventsTable(container, rows, opts) {
      var wrap = document.createElement("div");
      wrap.className = "table-fit-wrap";
      var table = document.createElement("table");
      table.className =
        "table-no-scroll-mobile table-fit-force table-never-wrap table-grid team-player-events-table";
      var thead = document.createElement("thead");
      var trh = document.createElement("tr");
      (opts.headers || []).forEach(function (h) {
        trh.appendChild(el("th", null, h));
      });
      thead.appendChild(trh);
      table.appendChild(thead);
      var tbody = document.createElement("tbody");
      (rows || []).forEach(function (r) {
        var dateText = fmtDate(r.game_starts_at) || "";
        var opponentLabel = String(r.opponent || "").trim();
        if (!opponentLabel) opponentLabel = "—";
        var opponentCell =
          r.game_url
            ? el("a", { href: r.game_url, target: "_blank", rel: "noopener noreferrer" }, opponentLabel)
            : el("span", null, opponentLabel);
        var typeText = String(r.game_type || "").trim();

        var videoSeconds =
          r.video_seconds !== undefined && r.video_seconds !== null ? r.video_seconds : parseTimeToSeconds(r.video_time);
        var hasVideoTime =
          videoSeconds !== null && videoSeconds !== undefined && isFinite(parseInt(String(videoSeconds), 10));
        var videoLabel = hasVideoTime ? (String(r.video_time || "").trim() || fmtSecondsToTime(videoSeconds)) : "";
        var videoCell = el("span", { className: "muted" }, "");
        if (r.video_url && hasVideoTime) {
          var btn = el(
            "button",
            { type: "button", className: "btn secondary", style: "padding:.25rem .55rem;font-size:.85rem;" },
            videoLabel
          );
          btn.addEventListener("click", function () {
            openVideoClipForEventRow(r);
          });
          videoCell = btn;
        }

        addRow(
          tbody,
          opts.rowCells(r, {
            dateText: dateText,
            opponentCell: opponentCell,
            typeText: typeText,
            videoCell: videoCell,
          })
        );
      });
      table.appendChild(tbody);
      wrap.appendChild(table);
      container.appendChild(wrap);
      queueTableFit();
    }

      function groupRows(rows, keyFn) {
        var order = [];
        var groups = {};
        (rows || []).forEach(function (r) {
          var label = String(keyFn(r) || "").trim() || "Unknown";
        var k = label.toLowerCase();
        if (!Object.prototype.hasOwnProperty.call(groups, k)) {
          groups[k] = { label: label, rows: [] };
          order.push(k);
        }
        groups[k].rows.push(r);
      });
        return { order: order, groups: groups };
      }

      function withDetailsTag(r, tag) {
        var copy = Object.assign({}, r);
        var base = String(r.details || "").trim();
        var t = String(tag || "").trim();
        if (!t) return copy;
        copy.details = base ? (t + " — " + base) : t;
        return copy;
      }

      function extractYoutubeId(url) {
        if (!url) return null;
        try {
          var u = new URL(String(url), window.location.origin);
          var host = String(u.hostname || "").toLowerCase();
          if (host === "youtu.be") {
            var p = String(u.pathname || "").replace(/^\//, "");
            return p ? p.split("/")[0] : null;
          }
          var v = u.searchParams.get("v");
          if (v) return v;
          var path = String(u.pathname || "");
          var m = path.match(/\/embed\/([^/?#]+)/) || path.match(/\/shorts\/([^/?#]+)/);
          return m ? m[1] : null;
        } catch (e) {}
        return null;
      }

      function buildYoutubeWatchUrl(url, startSec) {
        var id = extractYoutubeId(url);
        if (!id) return null;
        var start = Math.max(0, Math.floor(startSec || 0));
        try {
          var w = new URL("https://www.youtube.com/watch");
          w.searchParams.set("v", String(id));
          w.searchParams.set("t", String(start) + "s");
          w.searchParams.set("autoplay", "1");
          w.searchParams.set("vq", "hd1080");
          return w.toString();
        } catch (e) {
          return null;
        }
      }

      function buildYoutubeEmbedUrl(url, startSec, endSec) {
        var id = extractYoutubeId(url);
        if (!id) return null;
        var start = Math.max(0, Math.floor(startSec || 0));
        var end = Math.max(start + 1, Math.floor(endSec || 0));
        var params = new URLSearchParams();
        params.set("autoplay", "1");
        params.set("mute", "1");
        params.set("enablejsapi", "1");
        params.set("origin", String(window.location.origin || ""));
        params.set("start", String(start));
        params.set("end", String(end));
        params.set("vq", "hd1080");
        params.set("rel", "0");
        params.set("modestbranding", "1");
        params.set("playsinline", "1");
        return "https://www.youtube-nocookie.com/embed/" + encodeURIComponent(id) + "?" + params.toString();
      }

      function clipTimingForEvent(r) {
        var kindKey = normTypeKey(r.event_type_key || r.event_type || r.kind || "");
        if (kindKey === "onicegoal") kindKey = "goal";
        var isGoalOrAssist = kindKey === "goal" || kindKey === "assist";
        // `pre` is seconds before the event; `dur` (totalDuration) is the total clip length (pre + post).
        var pre = isGoalOrAssist ? 20 : 10;
        var totalDuration = isGoalOrAssist ? 30 : 20;
        return { pre: pre, dur: totalDuration, kindKey: kindKey };
      }

      function openVideoClipForEventRow(r) {
        if (!videoPane || !videoIframe) return false;
        if (!r || !r.video_url) return false;
        var vs2 = r.video_seconds !== undefined && r.video_seconds !== null ? r.video_seconds : parseTimeToSeconds(r.video_time);
        if (vs2 === null || vs2 === undefined) return false;
        var vs = parseInt(String(vs2), 10);
        if (!isFinite(vs) || vs < 0) return false;

        var timing = clipTimingForEvent(r);
        var start2 = Math.max(0, Math.floor(vs - timing.pre));
        var end2 = Math.max(start2 + 1, start2 + timing.dur);

        var watchUrl = buildYoutubeWatchUrl(r.video_url, start2);
        if (videoOpen) {
          videoOpen.href = watchUrl || "";
          videoOpen.style.display = watchUrl ? "" : "none";
        }
        var embed = buildYoutubeEmbedUrl(r.video_url, start2, end2);
        if (!embed) {
          try {
            window.open(urlWithTime(r.video_url, start2), "_blank", "noopener");
          } catch (e) {}
          return true;
        }
        videoIframe.src = embed;
        videoIframe.setAttribute("src", embed);
        if (videoMeta) {
          var tLabel = timing.kindKey ? timing.kindKey.toUpperCase() : "";
          var at = (String(r.video_time || "").trim() || fmtSecondsToTime(vs));
          videoMeta.textContent = (tLabel ? (tLabel + " • ") : "") + at + " • " + timing.dur + "s clip";
        }
        videoPane.style.display = "block";
        return true;
      }

      var teamId = {{ team.id|default:"0" }};
      var publicLeagueId = {{ public_league_id|default:"null" }};
      var dlg = document.getElementById("team-player-events-modal");
      var titleEl = document.getElementById("team-player-events-title");
      var subtitleEl = document.getElementById("team-player-events-subtitle");
    var bodyEl = document.getElementById("team-player-events-body");
    var videoPane = document.getElementById("team-player-events-video-pane");
    var videoIframe = document.getElementById("team-player-events-video-iframe");
    var videoMeta = document.getElementById("team-player-events-video-meta");
    var videoOpen = document.getElementById("team-player-events-video-open-link");
    var videoClose = document.getElementById("team-player-events-video-close");
    var closeBtn = document.getElementById("team-player-events-close");
    if (!dlg || !titleEl || !subtitleEl || !bodyEl) return;

    function closeVideo() {
      if (videoIframe) videoIframe.src = "";
      if (videoOpen) {
        videoOpen.href = "";
        videoOpen.style.display = "none";
      }
      if (videoPane) videoPane.style.display = "none";
      if (videoMeta) videoMeta.textContent = "";
    }
    if (videoClose) videoClose.addEventListener("click", closeVideo);

    function closeModal() {
      closeVideo();
      try { dlg.close(); } catch (e) { dlg.open = false; }
    }
    if (closeBtn) closeBtn.addEventListener("click", closeModal);

    function showModal() {
      try { dlg.showModal(); } catch (e) { dlg.open = true; }
    }

    function showError(msg) {
      bodyEl.innerHTML = "";
      var p = el("p", { className: "muted" }, msg || "Error");
      bodyEl.appendChild(p);
    }

    function buildApiUrl(playerId, opts) {
      opts = opts || {};
      var api = new URL("/api/hky/teams/" + String(teamId) + "/players/" + String(playerId) + "/events", window.location.origin);
      var cur = new URL(window.location.href);
      cur.searchParams.getAll("gt").forEach(function (v) { api.searchParams.append("gt", v); });
      var rn = null;
      try { rn = parseInt(String(opts.recentN || "").trim(), 10); } catch (e) { rn = null; }
      if (rn !== null && isFinite(rn) && rn > 0) {
        rn = Math.max(1, Math.min(10, rn));
        api.searchParams.set("recent_n", String(rn));
      }
      if (publicLeagueId !== null && publicLeagueId !== undefined) api.searchParams.set("league_id", String(publicLeagueId));
      return api;
    }

    function normScopeLabel(s) {
      var t = String(s || "").trim();
      if (!t) return "All";
      if (t === "Tournament") return "Tournaments";
      return t;
    }

    function loadPlayer(playerId, opts) {
      opts = opts || {};
      var scopeLabel = normScopeLabel(opts.scopeLabel);
      titleEl.textContent = "Player Events — " + scopeLabel;
      subtitleEl.textContent = "";
      bodyEl.innerHTML = "<p class=\"muted\">Loading events…</p>";
      closeVideo();
      showModal();
      var api = buildApiUrl(playerId, opts);
      fetch(api.toString(), { credentials: "same-origin" }).then(function (resp) {
        return resp.json().then(function (data) {
          if (!resp.ok || !data || !data.ok) {
            var err = (data && data.error) ? String(data.error) : ("HTTP " + String(resp.status || ""));
            showError("Unable to load events (" + err + ").");
            return;
          }
          titleEl.textContent = "Player Events — " + scopeLabel;
          subtitleEl.textContent =
            String(data.player_name || "Player") +
            (data.jersey_number ? (" (#" + String(data.jersey_number) + ")") : "") +
            " • Eligible games: " + String(data.eligible_games || 0);
          bodyEl.innerHTML = "";

          var onIce = Array.isArray(data.on_ice_goals) ? data.on_ice_goals : [];
          var attributed = Array.isArray(data.events) ? data.events : [];

          if (!onIce.length && !attributed.length) {
            bodyEl.appendChild(el("p", { className: "muted" }, "No matching events for this player in the selected games."));
            return;
          }

            if (attributed.length) {
              bodyEl.appendChild(el("h4", { style: "margin:1rem 0 .5rem 0;" }, "Attributed Events"));
              var filtered = attributed.filter(function (r) {
                var k = normTypeKey(r.event_type_key || r.event_type);
                // Completed Passes are per-game shift-sheet events; don't include them in multi-game views.
                return k !== "penaltyexpired" && k !== "completedpass";
              });

              var goals = [];
              var assists = [];
              var xg = [];
              var sog = [];
              var shot = [];
              filtered.forEach(function (r) {
                var k = normTypeKey(r.event_type_key || r.event_type);
                if (k === "goal") {
                  goals.push(r);
                  xg.push(withDetailsTag(r, "Goal"));
                  sog.push(withDetailsTag(r, "Goal"));
                  shot.push(withDetailsTag(r, "Goal"));
                } else if (k === "assist") {
                  assists.push(r);
                } else if (k === "xg" || k === "expectedgoal") {
                  xg.push(withDetailsTag(r, "xG"));
                  sog.push(withDetailsTag(r, "xG"));
                  shot.push(withDetailsTag(r, "xG"));
                } else if (k === "sog") {
                  sog.push(withDetailsTag(r, "SOG"));
                  shot.push(withDetailsTag(r, "SOG"));
                } else if (k === "shot") {
                  shot.push(r);
                }
              });

              [
                ["Goals", goals],
                ["xG (Expected Goal)", xg],
                ["SOG", sog],
                ["Shot", shot],
                ["Assists", assists],
              ].forEach(function (pair) {
                var label = pair[0];
                var rows = pair[1] || [];
                if (!rows.length) return;
                bodyEl.appendChild(el("h5", { style: "margin:.75rem 0 .35rem 0;" }, label));
                renderEventsTable(bodyEl, rows, {
                  headers: ["Date", "Opponent", "Type", "P", "Time", "Video", "Details", "Source"],
                  rowCells: function (r, ctx) {
                    return [
                      ctx.dateText,
                      ctx.opponentCell,
                      ctx.typeText,
                      String(r.period || ""),
                      String(r.game_time || ""),
                      ctx.videoCell,
                      String(r.details || ""),
                      String(r.source || ""),
                    ];
                  },
                });
              });

              var chainKeys = { goal: true, assist: true, expectedgoal: true, xg: true, sog: true, shot: true };
              var remaining = filtered.filter(function (r) {
                var k = normTypeKey(r.event_type_key || r.event_type);
                return !chainKeys[k];
              });
              if (remaining.length) {
                var eg = groupRows(remaining, function (r) { return r.event_type; });
                eg.order.forEach(function (k) {
                  var g = eg.groups[k];
                  bodyEl.appendChild(el("h5", { style: "margin:.75rem 0 .35rem 0;" }, g.label));
                  renderEventsTable(bodyEl, g.rows, {
                  headers: ["Date", "Opponent", "Type", "P", "Time", "Video", "Details", "Source"],
                    rowCells: function (r, ctx) {
                      return [
                        ctx.dateText,
                        ctx.opponentCell,
                        ctx.typeText,
                        String(r.period || ""),
                        String(r.game_time || ""),
                        ctx.videoCell,
                        String(r.details || ""),
                        String(r.source || ""),
                      ];
                    },
                  });
                });
              }
            }

          // Keep derived On-Ice Goals (For/Against) at the bottom.
          if (onIce.length) {
            bodyEl.appendChild(
              el("h4", { style: "margin:1rem 0 .5rem 0;" }, "On-Ice Goals (For/Against)")
            );
            var og = groupRows(onIce, function (r) {
              var fa = String(r.for_against || "").trim();
              return fa ? ("Goals " + fa) : "Goals";
            });
            og.order.forEach(function (k) {
              var g = og.groups[k];
              bodyEl.appendChild(el("h5", { style: "margin:.75rem 0 .35rem 0;" }, g.label));
              renderEventsTable(bodyEl, g.rows, {
                headers: ["Date", "Opponent", "Type", "P", "Time", "Video", "Details", "Source"],
                rowCells: function (r, ctx) {
                  return [
                    ctx.dateText,
                    ctx.opponentCell,
                    ctx.typeText,
                    String(r.period || ""),
                    String(r.game_time || ""),
                    ctx.videoCell,
                    String(r.details || ""),
                    String(r.source || ""),
                  ];
                },
              });
            });
          }
          });
        }).catch(function (e) {
          showError("Unable to load events (" + String(e || "error") + ").");
        });
    }

    document.querySelectorAll(".player-events-link").forEach(function (a) {
      a.style.cursor = "pointer";
      a.addEventListener("click", function (e) {
        e.preventDefault();
        var pid = a.getAttribute("data-player-id");
        if (!pid) return;
        loadPlayer(pid, {
          recentN: a.getAttribute("data-recent-n"),
          scopeLabel: a.getAttribute("data-scope-label"),
          scope: a.getAttribute("data-scope"),
        });
      });
    });

    // ----------------------------
    // Goalie stats breakdown modal
    // ----------------------------
    var goalieDlg = document.getElementById("team-goalie-stats-modal");
    var goalieTitleEl = document.getElementById("team-goalie-stats-title");
    var goalieSubtitleEl = document.getElementById("team-goalie-stats-subtitle");
    var goalieBodyEl = document.getElementById("team-goalie-stats-body");
    var goalieCloseBtn = document.getElementById("team-goalie-stats-close");

    function fmtStat(v) {
      if (v === null || v === undefined) return "";
      if (typeof v === "boolean") return v ? "1" : "0";
      var n = Number(v);
      if (!isFinite(n)) return String(v);
      if (Math.floor(n) === n) return String(n);
      var s = n.toFixed(2);
      s = s.replace(/0+$/, "").replace(/\.$/, "");
      return s;
    }

    function showGoalieModal() {
      if (!goalieDlg) return;
      try { goalieDlg.showModal(); } catch (e) { goalieDlg.open = true; }
    }
    function closeGoalieModal() {
      if (!goalieDlg) return;
      try { goalieDlg.close(); } catch (e) { goalieDlg.open = false; }
    }
    if (goalieCloseBtn) goalieCloseBtn.addEventListener("click", closeGoalieModal);

    function buildGoalieApiUrl(goalieId, opts) {
      opts = opts || {};
      var api = new URL("/api/hky/teams/" + String(teamId) + "/goalies/" + String(goalieId) + "/stats", window.location.origin);
      var cur = new URL(window.location.href);
      cur.searchParams.getAll("gt").forEach(function (v) { api.searchParams.append("gt", v); });
      var rn = null;
      try { rn = parseInt(String(opts.recentN || "").trim(), 10); } catch (e) { rn = null; }
      if (rn !== null && isFinite(rn) && rn > 0) {
        rn = Math.max(1, Math.min(10, rn));
        api.searchParams.set("recent_n", String(rn));
      }
      if (publicLeagueId !== null && publicLeagueId !== undefined) api.searchParams.set("league_id", String(publicLeagueId));
      return api;
    }

    function renderGoalieGamesTable(rows, opts) {
      opts = opts || {};
      var hasSog = !!opts.hasSog;
      var hasXg = !!opts.hasXg;

      var wrap = document.createElement("div");
      wrap.className = "table-scroll";
      var table = document.createElement("table");
      table.className = "table-nowrap table-grid";
      var thead = document.createElement("thead");
      var trh = document.createElement("tr");

      function th(label) { trh.appendChild(el("th", null, label)); }
      th("Game");
      th("Result");
      th("TOI");
      th("GA");
      if (hasXg) { th("xGA"); th("xGSV"); th("xGSV%"); }
      if (hasSog) { th("SA"); th("SV"); th("SV%"); }
      th("GAA");
      thead.appendChild(trh);
      table.appendChild(thead);

      var tbody = document.createElement("tbody");
      (rows || []).forEach(function (r) {
        var tr = document.createElement("tr");

        var opp = String(r.opponent || "").trim();
        var side = String(r.our_side || "").trim();
        var homeAway = side === "away" ? "@" : "vs";
        var gameLabel = (fmtDate(r.game_starts_at) || "Game") + " " + homeAway + (opp ? (" " + opp) : "");
        if (String(r.game_type || "").trim()) gameLabel += " (" + String(r.game_type || "").trim() + ")";
        var gameCell = r.game_url ? el("a", { href: r.game_url, target: "_blank", rel: "noopener noreferrer" }, gameLabel) : el("span", null, gameLabel);
        tr.appendChild(el("td", null, gameCell));

        var res = "";
        if (r.score_for !== null && r.score_for !== undefined && r.score_against !== null && r.score_against !== undefined) {
          var sf = parseInt(String(r.score_for), 10);
          var sa = parseInt(String(r.score_against), 10);
          var tag = (sf > sa) ? "W" : ((sf < sa) ? "L" : "T");
          if (isFinite(sf) && isFinite(sa)) res = tag + " " + String(sf) + "-" + String(sa);
        }
        tr.appendChild(el("td", { className: "muted" }, res));

        tr.appendChild(el("td", null, fmtSecondsToTime(r.toi_seconds)));
        tr.appendChild(el("td", null, fmtStat(r.ga)));
        if (hasXg) {
          tr.appendChild(el("td", null, fmtStat(r.xga)));
          tr.appendChild(el("td", null, fmtStat(r.xg_saves)));
          tr.appendChild(el("td", null, fmtStat(r.xg_sv_pct)));
        }
        if (hasSog) {
          tr.appendChild(el("td", null, fmtStat(r.sa)));
          tr.appendChild(el("td", null, fmtStat(r.saves)));
          tr.appendChild(el("td", null, fmtStat(r.sv_pct)));
        }
        tr.appendChild(el("td", null, fmtStat(r.gaa)));

        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
      wrap.appendChild(table);
      return wrap;
    }

    function loadGoalieStats(goalieId, opts) {
      opts = opts || {};
      if (!goalieDlg || !goalieTitleEl || !goalieSubtitleEl || !goalieBodyEl) return;
      var scopeLabel = normScopeLabel(opts.scopeLabel);
      goalieTitleEl.textContent = "Goalie Stats — " + scopeLabel;
      goalieSubtitleEl.textContent = "";
      goalieBodyEl.innerHTML = "<p class=\"muted\">Loading…</p>";
      showGoalieModal();

      var api = buildGoalieApiUrl(goalieId, opts);
      fetch(api.toString(), { credentials: "same-origin" }).then(function (resp) {
        return resp.json().then(function (data) {
          if (!resp.ok || !data || !data.ok) {
            var err = (data && data.error) ? String(data.error) : ("HTTP " + String(resp.status || ""));
            goalieBodyEl.innerHTML = "";
            goalieBodyEl.appendChild(el("p", { className: "muted" }, "Unable to load goalie stats (" + err + ")."));
            return;
          }

          var games = Array.isArray(data.games) ? data.games : [];
          var totals = data.totals || {};
          var hasSog = !!(data.meta && data.meta.has_sog);
          var hasXg = !!(data.meta && data.meta.has_xg);

          goalieTitleEl.textContent = "Goalie Stats — " + scopeLabel;
          goalieSubtitleEl.textContent =
            String(data.player_name || "Goalie") +
            (data.jersey_number ? (" (#" + String(data.jersey_number) + ")") : "") +
            " • Eligible games: " + String(data.eligible_games || 0) +
            " • GP: " + String(totals.gp || 0);

          goalieBodyEl.innerHTML = "";
          if (!games.length) {
            goalieBodyEl.appendChild(el("p", { className: "muted" }, "No goalie games found in this scope."));
            return;
          }

          var parts = [];
          parts.push("TOI: " + fmtSecondsToTime(totals.toi_seconds || 0));
          parts.push("GA: " + fmtStat(totals.ga));
          if (hasXg) parts.push("xGA: " + fmtStat(totals.xga) + " • xGSV%: " + fmtStat(totals.xg_sv_pct));
          if (hasSog) parts.push("SA: " + fmtStat(totals.sa) + " • SV%: " + fmtStat(totals.sv_pct));
          parts.push("GAA: " + fmtStat(totals.gaa));
          goalieBodyEl.appendChild(el("p", { className: "muted" }, parts.join(" • ")));

          goalieBodyEl.appendChild(renderGoalieGamesTable(games, { hasSog: hasSog, hasXg: hasXg }));
        });
      }).catch(function (e) {
        if (!goalieBodyEl) return;
        goalieBodyEl.innerHTML = "";
        goalieBodyEl.appendChild(el("p", { className: "muted" }, "Unable to load goalie stats (" + String(e || "error") + ")."));
      });
    }

    document.querySelectorAll(".goalie-stats-link").forEach(function (a) {
      a.style.cursor = "pointer";
      a.addEventListener("click", function (e) {
        e.preventDefault();
        var pid = a.getAttribute("data-player-id");
        if (!pid) return;
        loadGoalieStats(pid, {
          recentN: (a.getAttribute("data-scope") === "recent") ? a.getAttribute("data-recent-n") : null,
          scopeLabel: a.getAttribute("data-scope-label"),
        });
      });
    });
  })();
</script>

{% endwith %}
{% endblock %}

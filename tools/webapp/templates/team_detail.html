{% extends "layout.html" %}
{% load webapp_tags %}
{% block content %}
{% with return_to=request.get_full_path %}
<div style="margin-bottom:.75rem;">
  <a class="btn" href="#" onclick="history.back(); return false;">Back</a>
</div>

<div style="display:flex;align-items:center;gap:1rem;">
  {% if public_league_id %}
    {% url "public_media_team_logo" league_id=public_league_id team_id=team.id as team_logo_url %}
  {% else %}
    {% url "media_team_logo" team_id=team.id as team_logo_url %}
  {% endif %}
  {% if team.logo_path %}
    <img src="{{ team_logo_url }}" alt="logo" style="width:150px;height:150px;border-radius:14px;object-fit:cover;border:1px solid var(--border);" />
  {% else %}
    <div style="width:150px;height:150px;border-radius:14px;background:#1c212c;border:1px solid var(--border);"></div>
  {% endif %}
  <div>
    <h2 style="margin:0">{{ team.name }}</h2>
    {% if team.is_external %}<p class="muted" style="margin:.25rem 0 0">External team</p>{% endif %}
  </div>
  {% if league_page_views %}
    <div
      data-hm-league-pageviews="1"
      data-league-id="{{ league_page_views.league_id }}"
      data-kind="{{ league_page_views.kind }}"
      data-entity-id="{{ league_page_views.entity_id }}"
      class="muted"
      style="margin-left:auto;font-size:.85rem;white-space:nowrap;"
      title="Live page views (excluding your own views as league owner)"
    >
      Views: <span data-role="count">{{ league_page_views.count }}</span>
    </div>
  {% endif %}
</div>

{% if head_coaches or assistant_coaches %}
  <div class="grid" style="margin-top:1rem; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));">
    <div class="card">
      <h3 style="margin:0 0 .5rem 0;">Coaches</h3>
      {% if head_coaches %}
        <p class="muted" style="margin:.25rem 0 .25rem 0;">Head Coach</p>
        <p style="margin:0">
          {% for c in head_coaches %}
            {{ c.name }}{% if not forloop.last %}, {% endif %}
          {% endfor %}
        </p>
      {% endif %}
      {% if assistant_coaches %}
        <p class="muted" style="margin:.75rem 0 .25rem 0;">Assistant Coaches</p>
        <p style="margin:0">
          {% for c in assistant_coaches %}
            {{ c.name }}{% if not forloop.last %}, {% endif %}
          {% endfor %}
        </p>
      {% endif %}
    </div>
  </div>
{% endif %}

<h3 style="margin-top:1.25rem;">Schedule</h3>
<div class="card">
  <div>
    <table class="table-no-scroll-mobile table-fit-always table-never-wrap">
      <thead>
        <tr>
          {% if schedule_games and schedule_games.0.division_name %}<th>Division</th>{% endif %}
          <th class="nowrap">Date</th>
          <th class="nowrap">Time</th>
          <th>Away</th>
          <th>Home</th>
          <th>Type</th>
          <th>Location</th>
          <th>Score</th>
          <th>Video</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        {% for g in schedule_games %}
          {% if public_league_id %}
            {% url "public_hky_game_detail" league_id=public_league_id game_id=g.id as game_path %}
            {% url "public_media_team_logo" league_id=public_league_id team_id=g.team1_id as team1_logo %}
            {% url "public_media_team_logo" league_id=public_league_id team_id=g.team2_id as team2_logo %}
          {% else %}
            {% url "hky_game_detail" game_id=g.id as game_path %}
            {% url "media_team_logo" team_id=g.team1_id as team1_logo %}
            {% url "media_team_logo" team_id=g.team2_id as team2_logo %}
          {% endif %}
          {% with s1=g.team1_score s2=g.team2_score %}
          <tr>
            {% if schedule_games and schedule_games.0.division_name %}<td>{{ g.division_name|default_if_none:"" }}</td>{% endif %}
            <td class="nowrap">{{ g.starts_at|fmt_date }}</td>
            <td class="nowrap">{{ g.starts_at|fmt_time }}</td>
            <td>
              {% if g.can_view_summary %}<a href="{{ game_path }}?return_to={{ return_to|urlencode }}" style="text-decoration:none;color:inherit;">{% endif %}
              <span style="display:inline-flex;align-items:center;gap:6px;">
                <img src="{{ team2_logo }}" alt="" style="width:22px;height:22px;border-radius:6px;object-fit:cover;" onerror="this.style.display='none'" />
                {% if s1 != None and s2 != None and s2 > s1 %}
                  <strong>{{ g.team2_name }}</strong>
                {% else %}
                  <span>{{ g.team2_name }}</span>
                {% endif %}
              </span>
              {% if g.can_view_summary %}</a>{% endif %}
            </td>
            <td>
              {% if g.can_view_summary %}<a href="{{ game_path }}?return_to={{ return_to|urlencode }}" style="text-decoration:none;color:inherit;">{% endif %}
              <span style="display:inline-flex;align-items:center;gap:6px;">
                <img src="{{ team1_logo }}" alt="" style="width:22px;height:22px;border-radius:6px;object-fit:cover;" onerror="this.style.display='none'" />
                {% if s1 != None and s2 != None and s1 > s2 %}
                  <strong>{{ g.team1_name }}</strong>
                {% else %}
                  <span>{{ g.team1_name }}</span>
                {% endif %}
              </span>
              {% if g.can_view_summary %}</a>{% endif %}
            </td>
            <td>
              {% if g.game_type_name %}
                {{ g.game_type_name }}
              {% elif g.division_name|lower == "external" %}
                Tournament
              {% endif %}
            </td>
            <td>{{ g.location|default_if_none:"" }}</td>
            <td>
              {% if s1 != None and s2 != None %}
                {{ s1 }} - {{ s2 }}
              {% else %}
                <span class="muted">—</span>
              {% endif %}
            </td>
            <td>
              {% if g.game_video_url %}
                <a href="{{ g.game_video_url|youtube_best_quality_url }}" target="_blank" rel="noopener noreferrer">Video</a>
              {% else %}
                <span class="muted">—</span>
              {% endif %}
            </td>
            <td>
              {% if g.can_view_summary %}
                {% if public_league_id %}
                  <a class="btn" href="{{ game_path }}?return_to={{ return_to|urlencode }}">View</a>
                {% else %}
                  {% if is_league_admin or g.user_id == request.session.user_id %}
                    <a class="btn" href="{{ game_path }}?return_to={{ return_to|urlencode }}&edit=1">Edit</a>
                  {% else %}
                    <a class="btn" href="{{ game_path }}?return_to={{ return_to|urlencode }}">View</a>
                  {% endif %}
                {% endif %}
              {% else %}
                <span class="muted">—</span>
              {% endif %}
            </td>
          </tr>
          {% endwith %}
        {% empty %}
          {% if schedule_games and schedule_games.0.division_name %}
            <tr><td colspan="9" class="muted">No games yet.</td></tr>
          {% else %}
            <tr><td colspan="8" class="muted">No games yet.</td></tr>
          {% endif %}
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<div class="grid" style="margin-top:1rem;">
  <div class="card">
    <h3>Team Stats</h3>
    <p class="muted">Record: <strong>{{ tstats.wins }}-{{ tstats.losses }}-{{ tstats.ties }}</strong> | GF: {{ tstats.gf }} | GA: {{ tstats.ga }} | Pts: {{ tstats.points }}</p>
  </div>
  <div class="card">
    <h3>Manage</h3>
    {% if editable %}
      <p><a class="btn" href="/teams/{{ team.id }}/edit">Edit team</a> <a class="btn" href="/schedule/new">Add game</a></p>
    {% else %}
      <p class="muted">Read-only</p>
    {% endif %}
  </div>
</div>

{% if roster_players %}
  <h3 style="margin-top:1.25rem;">Roster</h3>
  <div class="card">
    <div class="table-scroll">
      <table class="table-nowrap table-grid table-sortable" data-sortable="1" data-freeze-cols="2">
        <thead>
          <tr>
            <th>#</th>
            <th>Name</th>
            <th>Pos</th>
            {% if editable %}<th></th>{% endif %}
          </tr>
        </thead>
        <tbody>
          {% for p in roster_players %}
            <tr>
              <td>{{ p.jersey_number|default_if_none:"" }}</td>
              <td>{{ p.name|default_if_none:"" }}</td>
              <td>{{ p.position|default_if_none:"" }}</td>
              {% if editable %}
                <td>
                  <a class="btn" href="/teams/{{ team.id }}/players/{{ p.id }}/edit">Edit</a>
                  <form style="display:inline" method="post" action="/teams/{{ team.id }}/players/{{ p.id }}/delete" onsubmit="return confirm('Delete player?');">
                    {% csrf_token %}
                    <button class="btn danger" type="submit">Delete</button>
                  </form>
                </td>
              {% endif %}
            </tr>
          {% empty %}
            {% if editable %}
              <tr><td colspan="4" class="muted">No players yet.</td></tr>
            {% else %}
              <tr><td colspan="3" class="muted">No players yet.</td></tr>
            {% endif %}
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% if editable %}
      <p><a class="btn primary" href="/teams/{{ team.id }}/players/new">Add player</a></p>
    {% endif %}
  </div>
{% endif %}

<h3>Player Stats (Skaters)</h3>
<div class="card">
  {% if game_type_filter_options %}
    <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:.5rem;">
      <details id="player-stats-game-type-filter" style="position:relative;">
        <summary class="btn">Game Types: {{ game_type_filter_label|default:"All" }}</summary>
        <div style="position:absolute;z-index:50;top:calc(100% + 6px);left:0;min-width:240px;background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:.6rem;opacity:1;">
          <div class="muted" style="font-size:.85rem;margin-bottom:.35rem;">Filter player stats by game type</div>
          {% for opt in game_type_filter_options %}
            <label style="display:flex;align-items:center;gap:.5rem;padding:.2rem 0;">
              <input class="gt-filter-cb" type="checkbox" value="{{ opt.label }}" {% if opt.checked %}checked{% endif %} />
              <span>{{ opt.label }}</span>
            </label>
          {% endfor %}
          <div style="display:flex;gap:.5rem;flex-wrap:wrap;margin-top:.5rem;">
            <button type="button" class="btn" id="gt-filter-apply">Apply</button>
            <button type="button" class="btn" id="gt-filter-all">All</button>
          </div>
        </div>
      </details>
      <span class="muted">Applies to player stats tables only</span>
    </div>
    <script>
      (function () {
        var root = document.getElementById("player-stats-game-type-filter");
        if (!root) return;
        var applyBtn = document.getElementById("gt-filter-apply");
        var allBtn = document.getElementById("gt-filter-all");
        function getCbs() {
          return Array.prototype.slice.call(root.querySelectorAll("input.gt-filter-cb") || []);
        }
        function applySelection(mode) {
          var cbs = getCbs();
          if (mode === "all") cbs.forEach(function (cb) { cb.checked = true; });
          var checked = cbs.filter(function (cb) { return !!cb.checked; }).map(function (cb) { return String(cb.value || "").trim(); }).filter(Boolean);
          var all = cbs.map(function (cb) { return String(cb.value || "").trim(); }).filter(Boolean);
          var u = new URL(window.location.href);
          u.searchParams.delete("gt");
          // None checked or all checked => default to "All" (no filter param).
          if (checked.length > 0 && checked.length < all.length) {
            checked.forEach(function (v) { u.searchParams.append("gt", v); });
          }
          window.location.href = u.toString();
        }
        if (applyBtn) applyBtn.addEventListener("click", function (e) { e.preventDefault(); applySelection("apply"); try { root.open = false; } catch (e2) {} });
        if (allBtn) allBtn.addEventListener("click", function (e) { e.preventDefault(); applySelection("all"); try { root.open = false; } catch (e2) {} });
      })();
    </script>
  {% endif %}

  <p class="muted" style="margin:.25rem 0 0 0;">
    Sources: {% if player_stats_sources %}{{ player_stats_sources|join:", " }}{% else %}—{% endif %}
  </p>
  {% if player_stats_coverage_total_games != None %}
    <p class="muted" style="margin:.35rem 0 .75rem 0;">
      Stats may be incomplete. This selection has <strong>{{ player_stats_coverage_total_games }}</strong> completed games; column headers show <strong>(N)</strong> when a stat is available for only <strong>N</strong> of those games.
      {% if player_stats_recent_coverage_total_games != None and recent_n != None %}
        Recent table counts are over the last <strong>{{ player_stats_recent_coverage_total_games }}</strong> completed games (requested {{ recent_n }}).
      {% endif %}
    </p>
  {% endif %}

  <div class="table-scroll">
    <table class="table-nowrap table-grid table-sortable" data-sortable="1" data-freeze-cols="2">
      <thead>
        <tr>
          <th>#</th>
          <th>Name</th>
          <th>Pos</th>
          {% for col in player_stats_columns %}
            <th>
              <div>{{ col.label }}</div>
              {% if col.show_count %}
                <div class="th-subnote">({{ col.n_games }} Games)</div>
              {% endif %}
            </th>
          {% endfor %}
        </tr>
      </thead>
      <tbody>
        {% for r in player_stats_rows %}
          <tr>
            <td>{{ r.jersey_number|default_if_none:"" }}</td>
            <td>{{ r.name|default_if_none:"" }}</td>
            <td>{{ r.position|default_if_none:"" }}</td>
            {% for col in player_stats_columns %}
              <td>{{ r|get_item:col.key|fmt_stat }}</td>
            {% endfor %}
          </tr>
        {% empty %}
          <tr><td colspan="{{ player_stats_columns|length|add:'3' }}" class="muted">No player stats yet.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<h3 style="margin-top:1.25rem;">Recent Player Stats  -- Are They On a Roll?</h3>
<div class="card">
  <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:.75rem;">
    <span class="muted">Last</span>
    <select onchange="window.location=this.value" style="max-width:170px;">
      <option value="{% url_with_args recent_n=1 %}" {% if recent_n == 1 %}selected{% endif %}>1 games</option>
      <option value="{% url_with_args recent_n=2 %}" {% if recent_n == 2 %}selected{% endif %}>2 games</option>
      <option value="{% url_with_args recent_n=3 %}" {% if recent_n == 3 %}selected{% endif %}>3 games</option>
      <option value="{% url_with_args recent_n=4 %}" {% if recent_n == 4 %}selected{% endif %}>4 games</option>
      <option value="{% url_with_args recent_n=5 %}" {% if recent_n == 5 %}selected{% endif %}>5 games</option>
      <option value="{% url_with_args recent_n=6 %}" {% if recent_n == 6 %}selected{% endif %}>6 games</option>
      <option value="{% url_with_args recent_n=7 %}" {% if recent_n == 7 %}selected{% endif %}>7 games</option>
      <option value="{% url_with_args recent_n=8 %}" {% if recent_n == 8 %}selected{% endif %}>8 games</option>
      <option value="{% url_with_args recent_n=9 %}" {% if recent_n == 9 %}selected{% endif %}>9 games</option>
      <option value="{% url_with_args recent_n=10 %}" {% if recent_n == 10 %}selected{% endif %}>10 games</option>
    </select>
    <span class="muted">per player</span>
  </div>

  <div class="table-scroll">
    <table class="table-nowrap table-grid" data-freeze-cols="2">
      <thead>
        <tr>
          {% sort_toggle_url "jersey_number" sort_key=recent_sort sort_dir=recent_dir as sort_href %}
          {% sort_label recent_sort recent_dir "jersey_number" "#" as sort_txt %}
          <th><a href="{{ sort_href }}" style="text-decoration:none;color:inherit;">{{ sort_txt }}</a></th>

          {% sort_toggle_url "name" sort_key=recent_sort sort_dir=recent_dir as sort_href %}
          {% sort_label recent_sort recent_dir "name" "Name" as sort_txt %}
          <th><a href="{{ sort_href }}" style="text-decoration:none;color:inherit;">{{ sort_txt }}</a></th>

          {% sort_toggle_url "position" sort_key=recent_sort sort_dir=recent_dir as sort_href %}
          {% sort_label recent_sort recent_dir "position" "Pos" as sort_txt %}
          <th><a href="{{ sort_href }}" style="text-decoration:none;color:inherit;">{{ sort_txt }}</a></th>

          {% for col in recent_player_stats_columns %}
            {% sort_toggle_url col.key sort_key=recent_sort sort_dir=recent_dir as sort_href %}
            {% sort_label recent_sort recent_dir col.key col.label as sort_txt %}
            <th>
              <a href="{{ sort_href }}" style="text-decoration:none;color:inherit;">{{ sort_txt }}</a>
              {% if col.show_count %}
                <div class="th-subnote">({{ col.n_games }} Games)</div>
              {% endif %}
            </th>
          {% endfor %}
        </tr>
      </thead>
      <tbody>
        {% for r in recent_player_stats_rows %}
          <tr>
            <td>{{ r.jersey_number|default_if_none:"" }}</td>
            <td>{{ r.name|default_if_none:"" }}</td>
            <td>{{ r.position|default_if_none:"" }}</td>
            {% for col in recent_player_stats_columns %}
              <td>{{ r|get_item:col.key|fmt_stat }}</td>
            {% endfor %}
          </tr>
        {% empty %}
          <tr><td colspan="{{ recent_player_stats_columns|length|add:'3' }}" class="muted">No recent stats.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

{% endwith %}
{% endblock %}

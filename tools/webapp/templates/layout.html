<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HockeyMOM</title>
  <link rel="stylesheet" href="/static/styles.css" />
  {% block head %}{% endblock %}
</head>
<body>
  <header class="site-header">
    <div class="nav-wrap">
      <a class="brand" href="/">
        <span class="brand-badge"></span>
        <span class="brand-title">HockeyMOM</span>
      </a>
      <nav class="nav-links">
        <a href="/public/leagues">Public Leagues</a>
        {% if session.get('user_id') %}
          <a href="/games">Jobs: Upload</a>
          <a href="/teams">Teams</a>
          <a href="/schedule">Schedule</a>
          <a href="/leagues">Leagues</a>
          <a href="/jobs">Jobs</a>
          <a href="/logout">Logout</a>
        {% else %}
          <a href="/login">Login</a>
          <a href="/register" class="btn primary" style="margin-left:1rem">Get Started</a>
        {% endif %}
      </nav>
    </div>
  </header>
  <div class="container">
    {% if session.get('user_id') and user_leagues %}
      <form method="post" action="/league/select" style="margin:0 0 12px 0; display:flex; align-items:center; gap:8px;">
        <label for="league_id">League:</label>
        <select name="league_id" id="league_id" onchange="this.form.submit()">
          <option value="">(My Data)</option>
          {% for L in user_leagues %}
            <option value="{{ L.id }}" {% if selected_league_id==L.id %}selected{% endif %}>{{ L.name }}{% if L.is_shared %} (shared){% endif %}</option>
          {% endfor %}
        </select>
      </form>
    {% endif %}
    {% for m in get_flashed_messages(category_filter=['error']) %}
      <div class="flash error">{{ m }}</div>
    {% endfor %}
    {% for m in get_flashed_messages(category_filter=['success']) %}
      <div class="flash success">{{ m }}</div>
    {% endfor %}
    {% block content %}{% endblock %}
  </div>
  <script>
    (function() {
      function parseTimeToSeconds(s) {
        s = (s || "").trim();
        if (!s) return null;
        var m = s.match(/^(\d+):(\d{2})(?::(\d{2}))?$/);
        if (!m) return null;
        var a = parseInt(m[1], 10);
        var b = parseInt(m[2], 10);
        var c = m[3] ? parseInt(m[3], 10) : null;
        if (c === null) return a * 60 + b; // mm:ss
        return a * 3600 + b * 60 + c; // h:mm:ss
      }

      function inferType(values) {
        var seen = 0;
        var allNum = true;
        var allTime = true;
        var allDate = true;
        for (var i = 0; i < values.length; i++) {
          var v = (values[i] || "").trim();
          if (!v) continue;
          seen++;

          var t = parseTimeToSeconds(v);
          if (t === null) allTime = false;

          var n = Number(v.replace(/[, ]+/g, ""));
          if (!isFinite(n) || v.match(/[a-zA-Z]/)) allNum = false;

          var d = Date.parse(v);
          if (!isFinite(d)) allDate = false;

          if (seen >= 25) break;
        }
        if (seen === 0) return "text";
        if (allTime) return "time";
        if (allNum) return "num";
        if (allDate) return "date";
        return "text";
      }

      function getCellText(cell) {
        if (!cell) return "";
        return (cell.innerText || cell.textContent || "").trim();
      }

      function setupTable(table) {
        if (!table) return;
        var thead = table.tHead;
        var tbody = table.tBodies && table.tBodies[0];
        if (!thead || !tbody) return;
        var headers = thead.rows[0] ? Array.from(thead.rows[0].cells) : [];
        if (!headers.length) return;

        headers.forEach(function(th, colIdx) {
          th.addEventListener("click", function() {
            var rows = Array.from(tbody.rows);
            if (!rows.length) return;

            headers.forEach(function(h) { h.classList.remove("sorted-asc", "sorted-desc"); });
            var asc = !(th.dataset.sortDir === "asc");
            th.dataset.sortDir = asc ? "asc" : "desc";
            th.classList.add(asc ? "sorted-asc" : "sorted-desc");

            var sample = rows.map(function(r) { return getCellText(r.cells[colIdx]); });
            var type = inferType(sample);

            var mapped = rows.map(function(r, idx) {
              var txt = getCellText(r.cells[colIdx]);
              var key = txt;
              if (type === "time") {
                var t = parseTimeToSeconds(txt);
                key = (t === null ? Number.POSITIVE_INFINITY : t);
              } else if (type === "num") {
                var n = Number(txt.replace(/[, ]+/g, ""));
                key = isFinite(n) ? n : Number.POSITIVE_INFINITY;
              } else if (type === "date") {
                var d = Date.parse(txt);
                key = isFinite(d) ? d : Number.POSITIVE_INFINITY;
              } else {
                key = txt.toLowerCase();
              }
              return { row: r, idx: idx, key: key, txt: txt };
            });

            mapped.sort(function(a, b) {
              if (a.key < b.key) return asc ? -1 : 1;
              if (a.key > b.key) return asc ? 1 : -1;
              return a.idx - b.idx;
            });

            mapped.forEach(function(m) { tbody.appendChild(m.row); });
          });
        });
      }

      function setupFrozenColumns(table) {
        if (!table) return;
        var n = parseInt(table.getAttribute("data-freeze-cols") || "0", 10);
        if (!n || n <= 0) return;
        var rows = [];
        if (table.tHead && table.tHead.rows) rows = rows.concat(Array.from(table.tHead.rows));
        if (table.tBodies) rows = rows.concat(Array.from(table.tBodies).flatMap(function(tb){ return Array.from(tb.rows); }));
        if (!rows.length) return;

        // Measure widths from header row (fallback to first body row).
        var refRow = (table.tHead && table.tHead.rows && table.tHead.rows[0]) ? table.tHead.rows[0] : (table.tBodies[0] && table.tBodies[0].rows[0]);
        if (!refRow) return;
        var refCells = Array.from(refRow.cells);
        var widths = [];
        for (var i = 0; i < Math.min(n, refCells.length); i++) {
          widths.push(refCells[i].getBoundingClientRect().width);
        }
        // Compute left offsets.
        var lefts = [];
        var acc = 0;
        for (var j = 0; j < widths.length; j++) {
          lefts.push(acc);
          acc += widths[j];
        }

        rows.forEach(function(r) {
          var cells = Array.from(r.cells);
          for (var c = 0; c < Math.min(n, cells.length); c++) {
            cells[c].classList.add("sticky-col");
            cells[c].style.left = lefts[c] + "px";
            // Ensure sticky cells are above non-sticky cells.
            cells[c].style.zIndex = (r.parentElement && r.parentElement.tagName === "THEAD") ? (10 + (n - c)) : (5 + (n - c));
          }
        });
      }

      function init() {
        document.querySelectorAll("table[data-sortable='1']").forEach(function(t) { setupTable(t); });
        document.querySelectorAll("table[data-freeze-cols]").forEach(function(t) { setupFrozenColumns(t); });
        // Clamp table header labels to at most 2 lines (avoid very tall header rows).
        (function clampTableHeaders() {
          document.querySelectorAll("table thead th").forEach(function(th) {
            if (!th || !th.childNodes || th.childNodes.length === 0) return;
            // Avoid double-wrapping.
            if (th.firstElementChild && th.firstElementChild.classList && th.firstElementChild.classList.contains("th-clamp")) return;
            var wrap = document.createElement("div");
            wrap.className = "th-clamp";
            // Move all children into wrapper.
            while (th.firstChild) wrap.appendChild(th.firstChild);
            th.appendChild(wrap);
          });
        })();

        // On mobile, scale down tables explicitly marked as non-scrollable so they fit
        // horizontally without wrapping.
        (function() {
          function isMobile() {
            return window.matchMedia && window.matchMedia("(max-width: 720px)").matches;
          }

          function shouldFitAlways(table) {
            if (!table || !table.classList || !table.classList.contains("table-fit-always")) return false;
            // Apply on mobile + small landscape tablets/phones; avoid shrinking on large desktops.
            var coarse = window.matchMedia && window.matchMedia("(pointer: coarse)").matches;
            return coarse || (window.innerWidth && window.innerWidth <= 980);
          }

          function isMobileish() {
            var coarse = window.matchMedia && window.matchMedia("(pointer: coarse)").matches;
            return isMobile() || (coarse && (window.innerWidth && window.innerWidth <= 980));
          }

          function ensureWrap(table) {
            if (!table || !table.parentElement) return null;
            if (table.parentElement && table.parentElement.classList && table.parentElement.classList.contains("table-fit-wrap")) {
              return table.parentElement;
            }
            var wrap = document.createElement("div");
            wrap.className = "table-fit-wrap";
            table.parentNode.insertBefore(wrap, table);
            wrap.appendChild(table);
            return wrap;
          }

          function resetFit(table, wrap) {
            if (!table || !wrap) return;
            wrap.style.position = "";
            wrap.style.overflowX = "";
            wrap.style.overflowY = "";
            wrap.style.height = "";
            table.style.position = "";
            table.style.left = "";
            table.style.top = "";
            table.style.transformOrigin = "";
            table.style.transform = "";
          }

          function applyFit(table, wrap) {
            if (!table || !wrap) return;
            // Clear old fit first so measurements are stable.
            resetFit(table, wrap);
            var avail = wrap.clientWidth || 0;
            var needed = table.scrollWidth || 0;
            if (!avail || !needed) return;
            var scale = avail / needed;
            if (scale >= 0.999) return;
            var h = table.offsetHeight || 0;
            wrap.style.position = "relative";
            wrap.style.overflowX = "hidden";
            wrap.style.overflowY = "hidden";
            wrap.style.height = (h * scale) + "px";
            table.style.position = "absolute";
            table.style.left = "0";
            table.style.top = "0";
            table.style.transformOrigin = "top left";
            table.style.transform = "scale(" + scale + ")";
          }

          var raf = null;
          function run() {
            if (raf) window.cancelAnimationFrame(raf);
            raf = window.requestAnimationFrame(function() {
              var mobile = isMobile();
              var mobileish = isMobileish();
              document.querySelectorAll("table.table-no-scroll-mobile").forEach(function(t) {
                var wrap = ensureWrap(t);
                if (!wrap) return;
                var fitAlways = shouldFitAlways(t);
                if (!mobile && !fitAlways) {
                  resetFit(t, wrap);
                } else {
                  applyFit(t, wrap);
                }
              });

              // For tables that remain horizontally scrollable on mobile, still scale down the
              // font/padding proportionally (without using transforms) so they remain readable.
              document.querySelectorAll("table").forEach(function(t) {
                if (!t || !t.classList) return;
                if (t.classList.contains("table-no-scroll-mobile")) return; // handled above
                if (!mobileish) {
                  t.classList.remove("table-mobile-scale");
                  try { t.style.removeProperty("--mobile-table-scale"); } catch (e) {}
                  return;
                }
                // Reset scale before measuring.
                t.classList.add("table-mobile-scale");
                try { t.style.setProperty("--mobile-table-scale", "1"); } catch (e) {}
                var parent = t.parentElement;
                var avail = (parent && parent.clientWidth) ? parent.clientWidth : (t.clientWidth || 0);
                var needed = t.scrollWidth || 0;
                if (!avail || !needed) return;
                var s = avail / needed;
                if (s > 1) s = 1;
                var minS = 0.72;
                if (s < minS) s = minS;
                try { t.style.setProperty("--mobile-table-scale", String(s)); } catch (e) {}
              });

              // Recompute frozen column offsets after any layout-affecting scaling/resizes.
              document.querySelectorAll("table[data-freeze-cols]").forEach(function(t) { setupFrozenColumns(t); });
            });
          }

          run();
          window.addEventListener("resize", run);
          window.addEventListener("load", run);
        })();
      }
      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", init);
      } else {
        init();
      }
    })();
  </script>
</body>
</html>

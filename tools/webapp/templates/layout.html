<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HockeyMOM</title>
  <link rel="stylesheet" href="/static/styles.css?v={{ styles_css_version|default:'0' }}" />
  {% block head %}{% endblock %}
</head>
<body>
  <header class="site-header">
    <div class="nav-wrap">
      <a class="brand" href="/">
        <span class="brand-badge"></span>
        <span class="brand-title">HockeyMOM</span>
      </a>
      <nav class="nav-links">
        <a href="/public/leagues">Public Leagues</a>
        {% if request.session.user_id %}
          <a href="/games">Jobs: Upload</a>
          <a href="/teams">Teams</a>
          <a href="/schedule">Schedule</a>
          <a href="/leagues">Leagues</a>
          <a href="/jobs">Jobs</a>
          <a href="/logout">Logout</a>
        {% else %}
          <a href="/login">Login</a>
          <a href="/register" class="btn primary" style="margin-left:1rem">Get Started</a>
        {% endif %}
      </nav>
    </div>
  </header>
  <div class="container">
    {% if request.session.user_id and user_leagues %}
      <form method="post" action="/league/select" style="margin:0 0 12px 0; display:flex; align-items:center; gap:8px;">
        {% csrf_token %}
        <label for="league_id">League:</label>
        <select name="league_id" id="league_id" onchange="this.form.submit()">
          <option value="">(My Data)</option>
          {% for L in user_leagues %}
            <option value="{{ L.id }}" {% if selected_league_id == L.id %}selected{% endif %}>{{ L.name }}{% if L.is_shared %} (shared){% endif %}</option>
          {% endfor %}
        </select>
      </form>
    {% endif %}
    {% if messages %}
      {% for message in messages %}
        {% if "error" in message.tags %}
          <div class="flash error">{{ message }}</div>
        {% elif "success" in message.tags %}
          <div class="flash success">{{ message }}</div>
        {% else %}
          <div class="flash">{{ message }}</div>
        {% endif %}
      {% endfor %}
    {% endif %}
    {% block content %}{% endblock %}
  </div>
  <script>
    (function() {
      function parseTimeToSeconds(s) {
        s = (s || "").trim();
        if (!s) return null;
        var m = s.match(/^(\d+):(\d{2})(?::(\d{2}))?$/);
        if (!m) return null;
        var a = parseInt(m[1], 10);
        var b = parseInt(m[2], 10);
        var c = m[3] ? parseInt(m[3], 10) : null;
        if (c === null) return a * 60 + b; // mm:ss
        return a * 3600 + b * 60 + c; // h:mm:ss
      }

      function inferType(values) {
        var seen = 0;
        var allNum = true;
        var allTime = true;
        var allDate = true;
        for (var i = 0; i < values.length; i++) {
          var v = (values[i] || "").trim();
          if (!v) continue;
          seen++;

          var t = parseTimeToSeconds(v);
          if (t === null) allTime = false;

          var n = Number(v.replace(/[, ]+/g, ""));
          if (!isFinite(n) || v.match(/[a-zA-Z]/)) allNum = false;

          var d = Date.parse(v);
          if (!isFinite(d)) allDate = false;

          if (seen >= 25) break;
        }
        if (seen === 0) return "text";
        if (allTime) return "time";
        if (allNum) return "num";
        if (allDate) return "date";
        return "text";
      }

      function getCellText(cell) {
        if (!cell) return "";
        return (cell.innerText || cell.textContent || "").trim();
      }

      function inferTableTitle(table) {
        if (!table) return document.title || "Table";
        var explicit = String(table.getAttribute("data-xlsx-title") || "").trim();
        if (explicit) return explicit;

        // Walk up the DOM, scanning previous siblings for a heading.
        var node = table;
        while (node && node !== document.body) {
          var cur = node;
          while (cur && cur.previousElementSibling) {
            cur = cur.previousElementSibling;
            if (!cur) break;
            if (cur.tagName && String(cur.tagName).match(/^H[2-5]$/)) {
              var txt = (cur.innerText || cur.textContent || "").trim();
              if (txt) return txt;
            }
            var h = cur.querySelector && cur.querySelector("h2,h3,h4,h5");
            if (h) {
              var txt2 = (h.innerText || h.textContent || "").trim();
              if (txt2) return txt2;
            }
          }
          node = node.parentElement;
        }

        // Fallback: first page h2/h3.
        var top = document.querySelector("h2,h3");
        if (top) {
          var t = (top.innerText || top.textContent || "").trim();
          if (t) return t;
        }
        return document.title || "Table";
      }

      function sanitizeFilename(name) {
        var s = String(name || "").trim() || "table";
        s = s.replace(/[^\w\-. ]+/g, "_");
        s = s.replace(/\s+/g, " ").trim().replace(/ /g, "_");
        if (!s) s = "table";
        if (s.toLowerCase().slice(-5) !== ".xlsx") s = s + ".xlsx";
        return s;
      }

      function extractTableData(table) {
        var thead = table && table.tHead;
        var tbody = table && table.tBodies && table.tBodies[0];
        if (!thead || !tbody || !thead.rows || !thead.rows[0]) return null;
        var headerCells = Array.from(thead.rows[0].cells || []);
        var headers = headerCells.map(function (th) {
          return (th.innerText || th.textContent || "").trim();
        });
        var colKeys = headerCells.map(function (th) {
          var k = String(th.getAttribute("data-stat-key") || "").trim();
          return k ? k : null;
        });

        var rows = Array.from(tbody.rows || []).map(function (tr) {
          return Array.from(tr.cells || []).map(function (td) {
            if (!td) return "";
            var inp = td.querySelector && td.querySelector("input,select,textarea");
            if (inp) {
              if (inp.tagName === "SELECT") {
                var opt = inp.options && inp.selectedIndex >= 0 ? inp.options[inp.selectedIndex] : null;
                return opt ? String(opt.textContent || "").trim() : String(inp.value || "").trim();
              }
              return String(inp.value || "").trim();
            }
            return (td.innerText || td.textContent || "").trim();
          });
        });

        var freezeCols = 0;
        try { freezeCols = parseInt(String(table.getAttribute("data-freeze-cols") || "0"), 10) || 0; } catch (e) { freezeCols = 0; }

        var title = inferTableTitle(table);
        return { title: title, headers: headers, rows: rows, colKeys: colKeys, freezeCols: freezeCols };
      }

      function downloadTableAsXlsx(table) {
        var data = extractTableData(table);
        if (!data || !data.headers || !data.headers.length) return;
        var filename = sanitizeFilename(data.title);
        var payload = {
          title: data.title,
          sheet_name: data.title,
          filename: filename,
          headers: data.headers,
          col_keys: data.colKeys,
          rows: data.rows,
          freeze_cols: data.freezeCols,
        };

        fetch("/api/xlsx/table", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          credentials: "same-origin",
          body: JSON.stringify(payload),
        })
          .then(function (resp) {
            if (!resp.ok) {
              return resp.json().catch(function () { return {}; }).then(function (j) {
                var err = (j && j.error) ? String(j.error) : ("HTTP " + String(resp.status || ""));
                throw new Error(err);
              });
            }
            return resp.blob();
          })
          .then(function (blob) {
            var url = window.URL.createObjectURL(blob);
            var a = document.createElement("a");
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            window.setTimeout(function () {
              try { window.URL.revokeObjectURL(url); } catch (e) {}
              try { a.remove(); } catch (e) {}
            }, 0);
          })
          .catch(function (e) {
            try { window.alert("Unable to export XLSX (" + String(e && e.message || e || "error") + ")."); } catch (e2) {}
          });
      }

      function tableAnchorEl(table) {
        if (!table) return table;
        var p = table.parentElement;
        if (p && p.classList) {
          if (p.classList.contains("table-scroll") || p.classList.contains("table-scroll-y") || p.classList.contains("table-fit-wrap")) {
            return p;
          }
        }
        return table;
      }

      function ensureTableExportLink(table) {
        if (!table || table.getAttribute("data-no-export-xlsx") === "1") return;
        if (table.getAttribute("data-xlsx-export-ready") === "1") return;
        if (!table.tHead || !table.tBodies || !table.tBodies.length) return;
        if (!table.tHead.rows || !table.tHead.rows.length) return;
        if (!table.tBodies[0] || !table.tBodies[0].rows) return;

        table.setAttribute("data-xlsx-export-ready", "1");
        var anchor = tableAnchorEl(table);
        if (!anchor || !anchor.parentNode) return;

        var row = document.createElement("div");
        row.className = "table-export-row";
        var link = document.createElement("a");
        link.href = "#";
        link.className = "table-export-link";
        link.textContent = "Download XLSX";
        link.addEventListener("click", function (e) {
          e.preventDefault();
          downloadTableAsXlsx(table);
        });
        row.appendChild(link);
        anchor.parentNode.insertBefore(row, anchor);
      }

      function setupTableExportLinks(root) {
        (root || document).querySelectorAll("table").forEach(function (t) {
          ensureTableExportLink(t);
        });
      }

      function setupTable(table) {
        if (!table) return;
        if (table.getAttribute("data-sortable-ready") === "1") return;
        table.setAttribute("data-sortable-ready", "1");
        var thead = table.tHead;
        var tbody = table.tBodies && table.tBodies[0];
        if (!thead || !tbody) return;
        var headers = thead.rows[0] ? Array.from(thead.rows[0].cells) : [];
        if (!headers.length) return;

        headers.forEach(function(th, colIdx) {
          th.addEventListener("click", function() {
            var rows = Array.from(tbody.rows);
            if (!rows.length) return;

            headers.forEach(function(h) { h.classList.remove("sorted-asc", "sorted-desc"); });
            var asc = !(th.dataset.sortDir === "asc");
            th.dataset.sortDir = asc ? "asc" : "desc";
            th.classList.add(asc ? "sorted-asc" : "sorted-desc");

            var sample = rows.map(function(r) { return getCellText(r.cells[colIdx]); });
            var type = inferType(sample);

            var mapped = rows.map(function(r, idx) {
              var txt = getCellText(r.cells[colIdx]);
              var key = txt;
              if (type === "time") {
                var t = parseTimeToSeconds(txt);
                key = (t === null ? Number.POSITIVE_INFINITY : t);
              } else if (type === "num") {
                var n = Number(txt.replace(/[, ]+/g, ""));
                key = isFinite(n) ? n : Number.POSITIVE_INFINITY;
              } else if (type === "date") {
                var d = Date.parse(txt);
                key = isFinite(d) ? d : Number.POSITIVE_INFINITY;
              } else {
                key = txt.toLowerCase();
              }
              return { row: r, idx: idx, key: key, txt: txt };
            });

            mapped.sort(function(a, b) {
              if (a.key < b.key) return asc ? -1 : 1;
              if (a.key > b.key) return asc ? 1 : -1;
              return a.idx - b.idx;
            });

            mapped.forEach(function(m) { tbody.appendChild(m.row); });
          });
        });
      }

      function clampTableHeaders(root) {
        (root || document).querySelectorAll("table thead th").forEach(function(th) {
          if (!th || !th.childNodes || th.childNodes.length === 0) return;
          // Avoid double-wrapping.
          if (
            th.firstElementChild &&
            th.firstElementChild.classList &&
            th.firstElementChild.classList.contains("th-clamp")
          ) {
            return;
          }
          var wrap = document.createElement("div");
          wrap.className = "th-clamp";
          // Move all children into wrapper.
          while (th.firstChild) wrap.appendChild(th.firstChild);
          th.appendChild(wrap);
        });
      }

      function wrapTableHeaderLabels(root) {
        function normalize(s) {
          return String(s || "").replace(/\s+/g, " ").trim();
        }

        function trailingParenGroup(s) {
          var m = normalize(s).match(/^(.*?)(\s*\([^)]*\)\s*)$/);
          if (!m) return { main: normalize(s), paren: "" };
          return { main: normalize(m[1]), paren: normalize(m[2]) };
        }

        function shouldSplitParen(paren) {
          var p = normalize(paren);
          if (!p) return false;
          // Keep "(N)" inline, but split wider parenthetical descriptors.
          if (p.length <= 4) return false;
          return (p.length >= 6) || (p.indexOf(" ") >= 0) || (p.indexOf("-") >= 0);
        }

        function splitLines(text) {
          var norm = normalize(text);
          if (!norm) return [];

          var parts = trailingParenGroup(norm);
          var main = parts.main;
          var paren = parts.paren;

          var words = main ? main.split(" ") : [];
          var lines = [];
          if (words.length > 2) {
            lines.push(words.slice(0, 2).join(" "));
            lines.push(words.slice(2).join(" "));
          } else {
            lines.push(main);
          }
          lines = lines.filter(function(x) { return normalize(x); });
          if (paren) {
            if (shouldSplitParen(paren)) {
              lines.push(paren);
            } else if (lines.length) {
              lines[lines.length - 1] = normalize(lines[lines.length - 1] + " " + paren);
            } else {
              lines.push(paren);
            }
          }
          return lines.filter(function(x) { return normalize(x); });
        }

        function maybeWrap(el) {
          if (!el) return;
          if (el.getAttribute && el.getAttribute("data-hm-th-wrapped") === "1") return;
          // Skip complex labels that include nested markup; preserve their explicit structure.
          if (el.children && el.children.length > 0) return;
          var txt = (el.textContent || "");
          if (!txt) return;
          if (String(txt).indexOf("\n") >= 0) return;
          var lines = splitLines(txt);
          if (!lines || lines.length < 2) return;
          el.textContent = lines.join("\n");
          if (el.classList) el.classList.add("hm-th-wrap");
          if (el.setAttribute) el.setAttribute("data-hm-th-wrapped", "1");
        }

        (root || document).querySelectorAll("table thead th").forEach(function(th) {
          if (!th) return;
          var clamp = (
            th.firstElementChild &&
            th.firstElementChild.classList &&
            th.firstElementChild.classList.contains("th-clamp")
          ) ? th.firstElementChild : null;

          if (clamp) {
            var labelDivs = Array.from(clamp.children || []).filter(function(el) {
              return (
                el &&
                el.tagName === "DIV" &&
                !(el.classList && el.classList.contains("th-subnote"))
              );
            });
            if (labelDivs.length) {
              labelDivs.forEach(maybeWrap);
            } else {
              maybeWrap(clamp);
            }
          } else {
            maybeWrap(th);
          }
        });
      }

      function setupFrozenColumns(table) {
        if (!table) return;
        var n = parseInt(table.getAttribute("data-freeze-cols") || "0", 10);
        if (!n || n <= 0) return;
        var rows = [];
        if (table.tHead && table.tHead.rows) rows = rows.concat(Array.from(table.tHead.rows));
        if (table.tBodies) rows = rows.concat(Array.from(table.tBodies).flatMap(function(tb){ return Array.from(tb.rows); }));
        if (!rows.length) return;

        // Measure widths from header row (fallback to first body row).
        var refRow = (table.tHead && table.tHead.rows && table.tHead.rows[0]) ? table.tHead.rows[0] : (table.tBodies[0] && table.tBodies[0].rows[0]);
        if (!refRow) return;
        var refCells = Array.from(refRow.cells);
        var widths = [];
        for (var i = 0; i < Math.min(n, refCells.length); i++) {
          widths.push(refCells[i].getBoundingClientRect().width);
        }
        // Compute left offsets.
        var lefts = [];
        var acc = 0;
        for (var j = 0; j < widths.length; j++) {
          lefts.push(acc);
          acc += widths[j];
        }

        rows.forEach(function(r) {
          var cells = Array.from(r.cells);
          for (var c = 0; c < Math.min(n, cells.length); c++) {
            cells[c].classList.add("sticky-col");
            cells[c].style.left = lefts[c] + "px";
            // Ensure sticky cells are above non-sticky cells.
            cells[c].style.zIndex = (r.parentElement && r.parentElement.tagName === "THEAD") ? (10 + (n - c)) : (5 + (n - c));
          }
        });
      }

      function init() {
        // Ensure header wrapping is applied before measuring frozen column widths.
        clampTableHeaders(document);
        wrapTableHeaderLabels(document);

        document.querySelectorAll("table[data-sortable='1']").forEach(function(t) { setupTable(t); });
        document.querySelectorAll("table[data-freeze-cols]").forEach(function(t) { setupFrozenColumns(t); });
        setupTableExportLinks(document);

        // On mobile, scale down tables explicitly marked as non-scrollable so they fit
        // horizontally without wrapping.
        (function() {
          function isMobile() {
            return window.matchMedia && window.matchMedia("(max-width: 720px)").matches;
          }

          function shouldFitAlways(table) {
            if (!table || !table.classList) return false;
            // Force-fit for specific UI surfaces (e.g., popups) where horizontal scrolling is undesirable.
            if (table.classList.contains("table-fit-force")) return true;
            if (!table.classList.contains("table-fit-always")) return false;
            // Apply on mobile + small landscape tablets/phones; avoid shrinking on large desktops.
            var coarse = window.matchMedia && window.matchMedia("(pointer: coarse)").matches;
            return coarse || (window.innerWidth && window.innerWidth <= 980);
          }

          function isMobileish() {
            var coarse = window.matchMedia && window.matchMedia("(pointer: coarse)").matches;
            return isMobile() || (coarse && (window.innerWidth && window.innerWidth <= 980));
          }

          function ensureWrap(table) {
            if (!table || !table.parentElement) return null;
            if (table.parentElement && table.parentElement.classList && table.parentElement.classList.contains("table-fit-wrap")) {
              return table.parentElement;
            }
            var wrap = document.createElement("div");
            wrap.className = "table-fit-wrap";
            table.parentNode.insertBefore(wrap, table);
            wrap.appendChild(table);
            return wrap;
          }

          function resetFit(table, wrap) {
            if (!table || !wrap) return;
            wrap.style.position = "";
            wrap.style.overflowX = "";
            wrap.style.overflowY = "";
            wrap.style.height = "";
            table.style.position = "";
            table.style.left = "";
            table.style.top = "";
            table.style.transformOrigin = "";
            table.style.transform = "";
          }

          function applyFit(table, wrap) {
            if (!table || !wrap) return;
            // Clear old fit first so measurements are stable.
            resetFit(table, wrap);
            var avail = wrap.clientWidth || 0;
            var needed = table.scrollWidth || 0;
            if (!avail || !needed) return;
            var scale = avail / needed;
            if (scale >= 0.999) return;
            var h = table.offsetHeight || 0;
            wrap.style.position = "relative";
            wrap.style.overflowX = "hidden";
            wrap.style.overflowY = "hidden";
            wrap.style.height = (h * scale) + "px";
            table.style.position = "absolute";
            table.style.left = "0";
            table.style.top = "0";
            table.style.transformOrigin = "top left";
            table.style.transform = "scale(" + scale + ")";
          }

          var raf = null;
          function run() {
            if (raf) window.cancelAnimationFrame(raf);
            raf = window.requestAnimationFrame(function() {
              var mobile = isMobile();
              var mobileish = isMobileish();
              document.querySelectorAll("table.table-no-scroll-mobile").forEach(function(t) {
                var wrap = ensureWrap(t);
                if (!wrap) return;
                var fitAlways = shouldFitAlways(t);
                if (!mobile && !fitAlways) {
                  resetFit(t, wrap);
                } else {
                  applyFit(t, wrap);
                }
              });

              // For tables that remain horizontally scrollable on mobile, still scale down the
              // font/padding proportionally (without using transforms) so they remain readable.
              document.querySelectorAll("table").forEach(function(t) {
                if (!t || !t.classList) return;
                if (t.classList.contains("table-no-scroll-mobile")) return; // handled above
                if (!mobileish) {
                  t.classList.remove("table-mobile-scale");
                  try { t.style.removeProperty("--mobile-table-scale"); } catch (e) {}
                  return;
                }
                // Reset scale before measuring.
                t.classList.add("table-mobile-scale");
                try { t.style.setProperty("--mobile-table-scale", "1"); } catch (e) {}
                var parent = t.parentElement;
                var avail = (parent && parent.clientWidth) ? parent.clientWidth : (t.clientWidth || 0);
                var needed = t.scrollWidth || 0;
                if (!avail || !needed) return;
                var s = avail / needed;
                if (s > 1) s = 1;
                var minS = 0.72;
                if (s < minS) s = minS;
                try { t.style.setProperty("--mobile-table-scale", String(s)); } catch (e) {}
              });

              // Recompute frozen column offsets after any layout-affecting scaling/resizes.
              document.querySelectorAll("table[data-freeze-cols]").forEach(function(t) { setupFrozenColumns(t); });
            });
          }

          run();
          window.addEventListener("resize", run);
          window.addEventListener("load", run);
        })();

        // Best-effort: if pages dynamically insert tables (e.g., drilldown dialogs), attach exports.
        (function () {
          var queued = false;
          var obs = null;
          try {
            obs = new MutationObserver(function () {
              if (queued) return;
              queued = true;
              window.requestAnimationFrame(function () {
                queued = false;
                clampTableHeaders(document);
                wrapTableHeaderLabels(document);
                document
                  .querySelectorAll("table[data-sortable='1']")
                  .forEach(function (t) {
                    setupTable(t);
                  });
                document
                  .querySelectorAll("table[data-freeze-cols]")
                  .forEach(function (t) {
                    setupFrozenColumns(t);
                  });
                setupTableExportLinks(document);
              });
            });
          } catch (e) {
            obs = null;
          }
          if (obs) {
            try {
              obs.observe(document.body, { childList: true, subtree: true });
            } catch (e) {}
          }
        })();
      }
      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", init);
      } else {
        init();
      }
    })();
  </script>
  <script>
    (function () {
      var _hmPvInit = (typeof WeakSet !== "undefined") ? new WeakSet() : null;

      function initLeaguePageViews(root) {
        var scope = root || document;
        var els = [];
        try {
          els = Array.from(scope.querySelectorAll("[data-hm-league-pageviews='1']"));
        } catch (e) {
          els = [];
        }
        if (!els.length) return;

        function getCookie(name) {
          try {
            var v = ("; " + document.cookie).split("; " + name + "=");
            if (v.length === 2) return v.pop().split(";").shift();
          } catch (e) {}
          return null;
        }

        function initWidget(el) {
          if (!el) return;
          if (_hmPvInit) {
            try {
              if (_hmPvInit.has(el)) return;
              _hmPvInit.add(el);
            } catch (e) {}
          } else {
            if (String(el.getAttribute("data-hm-pv-init") || "") === "1") return;
            el.setAttribute("data-hm-pv-init", "1");
          }

          var leagueId = String(el.getAttribute("data-league-id") || "").trim();
          var kind = String(el.getAttribute("data-kind") || "").trim();
          var entityId = String(el.getAttribute("data-entity-id") || "0").trim() || "0";
          var countEl = el.querySelector("[data-role='count']");
          var deltaEl = el.querySelector("[data-role='delta']");
          var markBtn = el.querySelector("[data-role='mark']");
          if (!leagueId || !kind || !countEl) return;

          function applyCounts(j) {
            if (!j || !j.ok) return;
            if (typeof j.count !== "undefined") {
              countEl.textContent = String(j.count);
            }
            if (!deltaEl) return;
            if (j.delta_count === null || typeof j.delta_count === "undefined") {
              deltaEl.textContent = "";
              deltaEl.style.display = "none";
              return;
            }
            deltaEl.textContent = "(+" + String(j.delta_count) + ")";
            deltaEl.style.display = "";
          }

          function refresh() {
            var url =
              "/api/leagues/" +
              encodeURIComponent(leagueId) +
              "/page_views?kind=" +
              encodeURIComponent(kind) +
              "&entity_id=" +
              encodeURIComponent(entityId);
            try {
              fetch(url, { credentials: "same-origin" })
                .then(function (r) {
                  return r.json().catch(function () {
                    return {};
                  });
                })
                .then(function (j) {
                  applyCounts(j);
                })
                .catch(function () {});
            } catch (e) {}
          }

          function markBaseline() {
            if (!markBtn) return;
            var csrf = getCookie("csrftoken");
            if (!csrf) return;
            var url =
              "/api/leagues/" + encodeURIComponent(leagueId) + "/page_views/mark";
            var body =
              "kind=" +
              encodeURIComponent(kind) +
              "&entity_id=" +
              encodeURIComponent(entityId);
            try {
              markBtn.disabled = true;
              fetch(url, {
                method: "POST",
                credentials: "same-origin",
                headers: {
                  "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8",
                  "X-CSRFToken": csrf,
                },
                body: body,
              })
                .then(function (r) {
                  return r.json().catch(function () {
                    return {};
                  });
                })
                .then(function (j) {
                  applyCounts(j);
                  refresh();
                })
                .catch(function () {})
                .finally(function () {
                  markBtn.disabled = false;
                });
            } catch (e) {
              markBtn.disabled = false;
            }
          }

          refresh();
          var refreshMs = null;
          try {
            refreshMs = parseInt(String(el.getAttribute("data-refresh-ms") || "5000"), 10);
          } catch (e) {
            refreshMs = 5000;
          }
          if (refreshMs !== null && isFinite(refreshMs) && refreshMs > 0) {
            try { window.setInterval(refresh, refreshMs); } catch (e) {}
          }

          if (markBtn) {
            try {
              markBtn.addEventListener("click", function (e) {
                try { e.preventDefault(); } catch (e2) {}
                markBaseline();
              });
            } catch (e) {}
          }
        }

        els.forEach(function (el) { initWidget(el); });
      }

      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", function () { initLeaguePageViews(document); });
      } else {
        initLeaguePageViews(document);
      }

      try { window.hmInitLeaguePageViews = initLeaguePageViews; } catch (e) {}
    })();
  </script>
  <script>
    (function () {
      function intOrNull(v) {
        var n = null;
        try { n = parseInt(String(v || "").trim(), 10); } catch (e) { n = null; }
        return (n !== null && isFinite(n)) ? n : null;
      }

      function getCookie(name) {
        try {
          var v = ("; " + document.cookie).split("; " + name + "=");
          if (v.length === 2) return v.pop().split(";").shift();
        } catch (e) {}
        return null;
      }

      function activeLeagueId(opts) {
        opts = opts || {};
        function normLeagueId(v) {
          if (v === null || v === undefined) return null;
          if (typeof v === "string") {
            var s = String(v || "").trim();
            var sLower = s.toLowerCase();
            if (!s || sLower === "null" || sLower === "none" || sLower === "undefined") return null;
            // Coerce integer-like strings to numbers so callers can rely on truthiness checks.
            try {
              var n = parseInt(s, 10);
              if (isFinite(n) && String(n) === s) return n;
            } catch (e) {}
            return s;
          }
          return v;
        }
        var pl = normLeagueId(opts.publicLeagueId);
        var sl = normLeagueId(opts.selectedLeagueId);
        if (pl !== null && pl !== undefined) return pl;
        if (sl !== null && sl !== undefined) return sl;
        return null;
      }

      function record(leagueId, kind, entityId) {
        if (leagueId === null || leagueId === undefined) return;
        var eid = intOrNull(entityId);
        if (eid === null || eid <= 0) return;
        var url = "/api/leagues/" + encodeURIComponent(String(leagueId)) + "/page_views/record";
        var payload = null;
        try { payload = JSON.stringify({ kind: String(kind || ""), entity_id: eid }); } catch (e) { payload = null; }
        if (!payload) return;
        try {
          if (navigator && typeof navigator.sendBeacon === "function") {
            var blob = null;
            try { blob = new Blob([payload], { type: "application/json" }); } catch (e) { blob = null; }
            if (blob && navigator.sendBeacon(url, blob)) return;
          }
        } catch (e) {}
        try {
          fetch(url, {
            method: "POST",
            credentials: "same-origin",
            headers: { "Content-Type": "application/json" },
            body: payload,
            keepalive: true,
          }).catch(function () {});
        } catch (e) {}
      }

      function renderPlayerEventsPageViews(containerEl, leagueId, playerId) {
        if (!containerEl) return;
        containerEl.innerHTML = "";
        if (leagueId === null || leagueId === undefined) return;
        var pid = intOrNull(playerId);
        if (pid === null || pid <= 0) return;

        var w = document.createElement("div");
        w.setAttribute("data-hm-league-pageviews", "1");
        w.setAttribute("data-league-id", String(leagueId));
        w.setAttribute("data-kind", "player_events");
        w.setAttribute("data-entity-id", String(pid));
        w.setAttribute("data-refresh-ms", "5000");
        w.className = "muted";
        w.style.fontSize = ".85rem";
        w.style.whiteSpace = "nowrap";
        w.style.display = "inline-flex";
        w.style.alignItems = "center";
        w.style.gap = ".35rem";
        w.title = "Live views (excluding your own views as league owner)";

        var label = document.createElement("span");
        label.textContent = "Views: ";
        w.appendChild(label);
        var c = document.createElement("span");
        c.setAttribute("data-role", "count");
        c.textContent = "0";
        w.appendChild(c);
        var d = document.createElement("span");
        d.setAttribute("data-role", "delta");
        d.className = "muted";
        d.style.display = "none";
        w.appendChild(d);
        var b = document.createElement("button");
        b.type = "button";
        b.setAttribute("data-role", "mark");
        b.className = "btn secondary";
        b.style.padding = ".18rem .45rem";
        b.style.fontSize = ".75rem";
        b.style.lineHeight = "1";
        b.style.boxShadow = "none";
        b.title = "Mark current views as baseline";
        b.textContent = "Mark";
        w.appendChild(b);

        containerEl.appendChild(w);
        try { if (typeof window.hmInitLeaguePageViews === "function") window.hmInitLeaguePageViews(containerEl); } catch (e) {}
      }

      function clipEntityIdsInContainer(container) {
        if (!container) return [];
        var out = [];
        try {
          container.querySelectorAll("[data-hm-clip-views='1'][data-event-row-id]").forEach(function (el0) {
            var v = intOrNull(el0.getAttribute("data-event-row-id"));
            if (v !== null && v > 0) out.push(v);
          });
        } catch (e) {
          out = [];
        }
        var seen = {};
        var uniq = [];
        for (var i = 0; i < out.length; i++) {
          var k = String(out[i]);
          if (seen[k]) continue;
          seen[k] = true;
          uniq.push(out[i]);
        }
        return uniq;
      }

      function _applyClipCounts(container, results) {
        if (!container || !results) return;
        try {
          container.querySelectorAll("[data-hm-clip-views='1'][data-event-row-id]").forEach(function (el0) {
            var s = String(el0.getAttribute("data-event-row-id") || "").trim();
            var info = results[s];
            if (!info) return;
            var count = intOrNull(info.count);
            if (count === null || count < 0) count = 0;
            var delta = (info.delta_count !== undefined) ? info.delta_count : null;
            var txt = String(count);
            if (delta !== null && delta !== undefined) {
              var d = intOrNull(delta);
              if (d !== null) txt += " (+" + String(d) + ")";
            }
            el0.textContent = txt;
          });
        } catch (e) {}
      }

      function refreshClipViewCounts(container, leagueId, opts) {
        opts = opts || {};
        if (leagueId === null || leagueId === undefined) return;
        var ids = clipEntityIdsInContainer(container);
        var markBtn = opts.markButton || null;
        if (markBtn) {
          try { markBtn.style.display = ids.length ? "" : "none"; } catch (e) {}
        }
        if (!ids.length) return;
        var url =
          "/api/leagues/" +
          encodeURIComponent(String(leagueId)) +
          "/page_views/batch?kind=event_clip&entity_ids=" +
          encodeURIComponent(ids.join(","));
        try {
          fetch(url, { credentials: "same-origin" })
            .then(function (r) { return r.json().catch(function () { return {}; }); })
            .then(function (j) {
              if (!j || !j.ok || !j.results) return;
              _applyClipCounts(container, j.results);
            })
            .catch(function () {});
        } catch (e) {}
      }

      function markClipBaselines(container, leagueId, opts) {
        opts = opts || {};
        if (leagueId === null || leagueId === undefined) return;
        var markBtn = opts.markButton || null;
        var csrf = getCookie("csrftoken");
        if (!csrf) return;
        var ids = clipEntityIdsInContainer(container);
        if (!ids.length) return;
        var url = "/api/leagues/" + encodeURIComponent(String(leagueId)) + "/page_views/mark_batch";
        var body = "kind=event_clip&entity_ids=" + encodeURIComponent(ids.join(","));
        try {
          if (markBtn) markBtn.disabled = true;
          fetch(url, {
            method: "POST",
            credentials: "same-origin",
            headers: {
              "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8",
              "X-CSRFToken": csrf,
            },
            body: body,
          })
            .then(function (r) { return r.json().catch(function () { return {}; }); })
            .then(function (j) {
              if (!j || !j.ok) return;
              refreshClipViewCounts(container, leagueId, { markButton: markBtn });
            })
            .catch(function () {})
            .finally(function () {
              if (markBtn) markBtn.disabled = false;
            });
        } catch (e) {
          if (markBtn) markBtn.disabled = false;
        }
      }

      function eventRowIdFromRow(row) {
        if (!row) return null;
        var raw = null;
        try { raw = row["__hm_event_row_id"]; } catch (e) { raw = null; }
        var v = intOrNull(raw);
        return (v !== null && v > 0) ? v : null;
      }

      try {
        window.hmLeaguePageViews = {
          intOrNull: intOrNull,
          getCookie: getCookie,
          activeLeagueId: activeLeagueId,
          record: record,
          renderPlayerEventsPageViews: renderPlayerEventsPageViews,
          clipEntityIdsInContainer: clipEntityIdsInContainer,
          refreshClipViewCounts: refreshClipViewCounts,
          markClipBaselines: markClipBaselines,
          eventRowIdFromRow: eventRowIdFromRow,
        };
      } catch (e) {}
    })();
  </script>
</body>
</html>

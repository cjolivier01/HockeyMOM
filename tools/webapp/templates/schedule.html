{% extends "layout.html" %}
{% load webapp_tags %}
{% block content %}
{% with return_to=request.get_full_path %}
<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem;">
  <h2>Games Schedule</h2>
  <div style="display:flex;flex-direction:column;align-items:flex-end;gap:.35rem;">
	    {% if league_page_views %}
	      <div
	        data-hm-league-pageviews="1"
	        data-league-id="{{ league_page_views.league_id }}"
	        data-kind="{{ league_page_views.kind }}"
	        data-entity-id="{{ league_page_views.entity_id }}"
	        class="muted"
	        style="font-size:.85rem;white-space:nowrap;display:inline-flex;align-items:center;gap:.35rem;"
	        title="Live page views (excluding your own views as league owner)"
	      >
	        <span>Views: <span data-role="count">{{ league_page_views.count }}</span></span>
	        <span
	          data-role="delta"
	          class="muted"
	          {% if league_page_views.delta_count != None %}style="display:inline;"{% else %}style="display:none;"{% endif %}
	        >{% if league_page_views.delta_count != None %}(+{{ league_page_views.delta_count }}){% endif %}</span>
	        <button
	          type="button"
	          data-role="mark"
	          class="btn secondary"
	          style="padding:.18rem .45rem;font-size:.75rem;line-height:1;box-shadow:none;"
	          title="Mark current views as baseline"
	        >Mark</button>
	      </div>
	    {% endif %}
	    <div>
	      {% if not public_league_id %}
        <a class="btn primary" href="/schedule/new">Add game</a>
      {% endif %}
    </div>
  </div>
</div>

{% if public_league_id %}
  {% url "public_league_schedule" league_id=public_league_id as schedule_path %}
{% else %}
  {% url "schedule" as schedule_path %}
{% endif %}

{% if league_view %}
  <div class="card" style="margin-bottom:1rem;">
    <form method="get" action="{{ schedule_path }}" style="display:flex;gap:1rem;flex-wrap:wrap;align-items:end;">
      <div class="form-row">
        <label class="muted">Division</label>
        <select name="division" id="division_select">
          <option value="">(All)</option>
          {% for d in divisions %}
            <option value="{{ d }}" {% if selected_division == d %}selected{% endif %}>{{ d }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="form-row">
        <label class="muted">Team</label>
        <select name="team_id" id="team_select">
          <option value="">(All)</option>
          {% for t in league_teams %}
            <option value="{{ t.id }}" {% if selected_team_id == t.id|stringformat:"s" %}selected{% endif %}>{{ t.name }}</option>
          {% endfor %}
        </select>
      </div>
      <button class="btn" type="submit">Filter</button>
      <a class="btn" href="{{ schedule_path }}">Clear</a>
    </form>
    <script>
      (function() {
        var divSel = document.getElementById('division_select');
        var teamSel = document.getElementById('team_select');
        if (!divSel || !teamSel) return;
        divSel.addEventListener('change', function() {
          teamSel.value = '';
          divSel.form.submit();
        });
      })();
    </script>
  </div>
{% endif %}

<table id="league-schedule-table" class="table-no-scroll-mobile table-fit-always table-never-wrap table-schedule">
  <thead>
    <tr>
      {% if league_view %}<th>Division</th>{% endif %}
      <th class="nowrap">Date</th>
      <th class="nowrap">Time</th>
      <th>Away</th>
      <th>Home</th>
      <th>Type</th>
      <th>Location</th>
      <th>Score</th>
      <th class="schedule-src-col">Src</th>
      <th>Video</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    {% for g in games %}
      {% with s1=g.team1_score s2=g.team2_score %}
      <tr>
        {% if league_view %}<td>{{ g.division_name|default_if_none:"" }}</td>{% endif %}
        <td class="nowrap">{{ g.starts_at|fmt_date }}</td>
        <td class="nowrap">{{ g.starts_at|fmt_time }}</td>

        {% if public_league_id %}
          {% url "public_hky_game_detail" league_id=public_league_id game_id=g.id as game_path %}
          {% url "public_media_team_logo" league_id=public_league_id team_id=g.team1_id as team1_logo %}
          {% url "public_media_team_logo" league_id=public_league_id team_id=g.team2_id as team2_logo %}
        {% else %}
          {% url "hky_game_detail" game_id=g.id as game_path %}
          {% url "media_team_logo" team_id=g.team1_id as team1_logo %}
          {% url "media_team_logo" team_id=g.team2_id as team2_logo %}
        {% endif %}

        <td>
          {% if g.can_view_summary %}<a href="{{ game_path }}?return_to={{ return_to|urlencode }}" style="text-decoration:none;color:inherit;">{% endif %}
          <span style="display:inline-flex;align-items:center;gap:4px;">
            <img src="{{ team2_logo }}" alt="" style="width:22px;height:22px;border-radius:6px;object-fit:cover;" onerror="this.style.display='none'" />
            {% if s1 != None and s2 != None and s2 > s1 %}
              <strong>{{ g.team2_name }}</strong>
            {% else %}
              <span>{{ g.team2_name }}</span>
            {% endif %}
          </span>
          {% if g.can_view_summary %}</a>{% endif %}
        </td>

        <td>
          {% if g.can_view_summary %}<a href="{{ game_path }}?return_to={{ return_to|urlencode }}" style="text-decoration:none;color:inherit;">{% endif %}
          <span style="display:inline-flex;align-items:center;gap:4px;">
            <img src="{{ team1_logo }}" alt="" style="width:22px;height:22px;border-radius:6px;object-fit:cover;" onerror="this.style.display='none'" />
            {% if s1 != None and s2 != None and s1 > s2 %}
              <strong>{{ g.team1_name }}</strong>
            {% else %}
              <span>{{ g.team1_name }}</span>
            {% endif %}
          </span>
          {% if g.can_view_summary %}</a>{% endif %}
        </td>

        <td>{% if g.game_type_name %}{{ g.game_type_name }}{% elif g.division_name|is_external_division %}Tournament{% endif %}</td>
        <td>{{ g.location|default_if_none:"" }}</td>
        <td>
          {% if s1 != None and s2 != None %}
            {{ s2 }} - {{ s1 }}
          {% else %}
            <span class="muted">—</span>
          {% endif %}
        </td>
        <td class="schedule-src-col">
          {% if g.stats_icons %}
            <div class="schedule-stats-icons">
              {% for ic in g.stats_icons %}
                <span class="schedule-stats-icon schedule-stats-icon-{{ ic.key }}" title="{{ ic.title }}">{{ ic.text }}</span>
              {% endfor %}
            </div>
          {% else %}
            <span class="muted">—</span>
          {% endif %}
        </td>
        <td>
          {% if g.game_video_url %}
            <a href="{{ g.game_video_url|youtube_best_quality_url }}" target="_blank" rel="noopener noreferrer">Video</a>
          {% else %}
            <span class="muted">—</span>
          {% endif %}
        </td>
        <td>
          {% if g.can_view_summary %}
            {% if public_league_id %}
              <a class="btn" href="{{ game_path }}?return_to={{ return_to|urlencode }}">View</a>
            {% else %}
              {% if g.can_edit %}
                <a class="btn" href="{{ game_path }}?return_to={{ return_to|urlencode }}&edit=1">Edit</a>
              {% else %}
                <a class="btn" href="{{ game_path }}?return_to={{ return_to|urlencode }}">View</a>
              {% endif %}
            {% endif %}
          {% else %}
            <span class="muted">—</span>
          {% endif %}
        </td>
      </tr>
      {% endwith %}
    {% empty %}
      <tr><td colspan="{% if league_view %}11{% else %}10{% endif %}" class="muted">No games yet.</td></tr>
    {% endfor %}
  </tbody>
</table>
{% endwith %}
{% endblock %}

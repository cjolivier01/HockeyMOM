{% extends 'layout.html' %}
{% block content %}
{% set base = ('/public/leagues/%s' % public_league_id) if public_league_id is defined else '' %}
<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem;">
  <h2>Games Schedule</h2>
  {% if can_add_game|default(True) %}
    <a class="btn primary" href="/schedule/new">Add game</a>
  {% endif %}
</div>

{% if league_view %}
  <div class="card" style="margin-bottom:1rem;">
    <form method="get" action="{{ base }}/schedule" style="display:flex;gap:1rem;flex-wrap:wrap;align-items:end;">
      <div class="form-row">
        <label class="muted">Division</label>
        <select name="division" id="division_select">
          <option value="">(All)</option>
          {% for d in divisions %}
            <option value="{{ d }}" {% if selected_division==d %}selected{% endif %}>{{ d }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="form-row">
        <label class="muted">Team</label>
        <select name="team_id" id="team_select">
          <option value="">(All)</option>
          {% for t in league_teams %}
            <option value="{{ t.id }}" {% if selected_team_id==(t.id|string) %}selected{% endif %}>{{ t.name }}</option>
          {% endfor %}
        </select>
      </div>
      <button class="btn" type="submit">Filter</button>
      <a class="btn" href="{{ base }}/schedule">Clear</a>
    </form>
    <script>
      (function() {
        var divSel = document.getElementById('division_select');
        var teamSel = document.getElementById('team_select');
        if (!divSel || !teamSel) return;
        divSel.addEventListener('change', function() {
          teamSel.value = '';
          divSel.form.submit();
        });
      })();
    </script>
  </div>
{% endif %}

<table>
  <thead>
    <tr>
      {% if league_view %}<th>Division</th>{% endif %}
      <th class="nowrap">Date</th>
      <th class="nowrap">Time</th>
      <th>Matchup</th>
      <th>Type</th>
      <th>Location</th>
      <th>Score</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    {% for g in games %}
      <tr>
        {% if league_view %}<td>{{ g.get('division_name') or '' }}</td>{% endif %}
        <td class="nowrap">{{ (g['starts_at'] or '')|fmt_date }}</td>
        <td class="nowrap">{{ (g['starts_at'] or '')|fmt_time }}</td>
      <td>
        {% if public_league_id is defined %}
          <a href="{{ base }}/hky/games/{{ g['id'] }}" style="text-decoration:none;color:inherit;">
        {% else %}
          <a href="/hky/games/{{ g['id'] }}" style="text-decoration:none;color:inherit;">
        {% endif %}
        {% set s1 = g.get('team1_score') %}
        {% set s2 = g.get('team2_score') %}
        {% set has_score = (s1 is not none and s2 is not none) %}
        <span style="display:inline-flex;align-items:center;gap:8px;flex-wrap:wrap;">
          <span style="display:inline-flex;align-items:center;gap:6px;">
            <img src="{{ base }}/media/team_logo/{{ g['team1_id'] }}" alt="" style="width:22px;height:22px;border-radius:6px;object-fit:cover;" onerror="this.style.display='none'" />
            {% if has_score and s1 > s2 %}
              <strong>{{ g['team1_name'] }}</strong>
            {% else %}
              <span>{{ g['team1_name'] }}</span>
            {% endif %}
          </span>
          <span class="muted">vs</span>
          <span style="display:inline-flex;align-items:center;gap:6px;">
            <img src="{{ base }}/media/team_logo/{{ g['team2_id'] }}" alt="" style="width:22px;height:22px;border-radius:6px;object-fit:cover;" onerror="this.style.display='none'" />
            {% if has_score and s2 > s1 %}
              <strong>{{ g['team2_name'] }}</strong>
            {% else %}
              <span>{{ g['team2_name'] }}</span>
            {% endif %}
          </span>
        </span>
        </a>
      </td>
      <td>{{ g['game_type_name'] or '' }}</td>
      <td>{{ g['location'] or '' }}</td>
      <td>{% if g['team1_score'] is not none and g['team2_score'] is not none %}{{ g['team1_score'] }} - {{ g['team2_score'] }}{% else %}<span class="muted">â€”</span>{% endif %}</td>
      <td>
        {% if public_league_id is defined %}
          <a class="btn" href="{{ base }}/hky/games/{{ g['id'] }}">View</a>
        {% else %}
          {% if g.get('can_edit') %}
            <a class="btn" href="/hky/games/{{ g['id'] }}?edit=1">Edit</a>
          {% else %}
            <a class="btn" href="/hky/games/{{ g['id'] }}">View</a>
          {% endif %}
        {% endif %}
      </td>
      </tr>
    {% else %}
      <tr><td colspan="{% if league_view %}8{% else %}7{% endif %}" class="muted">No games yet.</td></tr>
    {% endfor %}
  </tbody>
</table>
{% endblock %}

{% extends 'layout.html' %}
{% block content %}
{% set base = ('/public/leagues/%s' % public_league_id) if public_league_id is defined else '' %}
{% set return_to = request.full_path.rstrip('?') %}
{% set return_to_q = ('?return_to=' ~ (return_to|urlencode)) if return_to else '' %}
{% set return_to_amp = ('&return_to=' ~ (return_to|urlencode)) if return_to else '' %}
<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem;">
  <h2>Games Schedule</h2>
  <div style="display:flex;flex-direction:column;align-items:flex-end;gap:.35rem;">
    {% if league_page_views %}
      <div
        data-hm-league-pageviews="1"
        data-league-id="{{ league_page_views.league_id }}"
        data-kind="{{ league_page_views.kind }}"
        data-entity-id="{{ league_page_views.entity_id }}"
        class="muted"
        style="font-size:.85rem;white-space:nowrap;"
        title="Live page views (excluding your own views as league owner)"
      >
        Views: <span data-role="count">{{ league_page_views.count }}</span>
      </div>
    {% endif %}
    <div>
      {% if can_add_game|default(True) %}
        <a class="btn primary" href="/schedule/new">Add game</a>
      {% endif %}
    </div>
  </div>
</div>

{% if league_view %}
  <div class="card" style="margin-bottom:1rem;">
    <form method="get" action="{{ base }}/schedule" style="display:flex;gap:1rem;flex-wrap:wrap;align-items:end;">
      <div class="form-row">
        <label class="muted">Division</label>
        <select name="division" id="division_select">
          <option value="">(All)</option>
          {% for d in divisions %}
            <option value="{{ d }}" {% if selected_division==d %}selected{% endif %}>{{ d }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="form-row">
        <label class="muted">Team</label>
        <select name="team_id" id="team_select">
          <option value="">(All)</option>
          {% for t in league_teams %}
            <option value="{{ t.id }}" {% if selected_team_id==(t.id|string) %}selected{% endif %}>{{ t.name }}</option>
          {% endfor %}
        </select>
      </div>
      <button class="btn" type="submit">Filter</button>
      <a class="btn" href="{{ base }}/schedule">Clear</a>
    </form>
    <script>
      (function() {
        var divSel = document.getElementById('division_select');
        var teamSel = document.getElementById('team_select');
        if (!divSel || !teamSel) return;
        divSel.addEventListener('change', function() {
          teamSel.value = '';
          divSel.form.submit();
        });
      })();
    </script>
  </div>
{% endif %}

<table class="table-no-scroll-mobile table-fit-always table-never-wrap">
  <thead>
    <tr>
      {% if league_view %}<th>Division</th>{% endif %}
      <th class="nowrap">Date</th>
      <th class="nowrap">Time</th>
      <th>Away</th>
      <th>Home</th>
      <th>Type</th>
      <th>Location</th>
      <th>Score</th>
      <th>Video</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    {% for g in games %}
      <tr>
        {% if league_view %}<td>{{ g.get('division_name') or '' }}</td>{% endif %}
        <td class="nowrap">{{ (g['starts_at'] or '')|fmt_date }}</td>
        <td class="nowrap">{{ (g['starts_at'] or '')|fmt_time }}</td>
        {% if public_league_id is defined %}
          {% set game_href = base ~ '/hky/games/' ~ g['id'] ~ return_to_q %}
        {% else %}
          {% set game_href = '/hky/games/' ~ g['id'] ~ return_to_q %}
        {% endif %}
        {% set s1 = g.get('team1_score') %}
        {% set s2 = g.get('team2_score') %}
        {% set has_score = (s1 is not none and s2 is not none) %}
        <td>
          {% if g.get('can_view_summary') %}<a href="{{ game_href }}" style="text-decoration:none;color:inherit;">{% endif %}
          <span style="display:inline-flex;align-items:center;gap:6px;">
            <img src="{{ base }}/media/team_logo/{{ g['team2_id'] }}" alt="" style="width:22px;height:22px;border-radius:6px;object-fit:cover;" onerror="this.style.display='none'" />
            {% if has_score and s2 > s1 %}
              <strong>{{ g['team2_name'] }}</strong>
            {% else %}
              <span>{{ g['team2_name'] }}</span>
            {% endif %}
          </span>
          {% if g.get('can_view_summary') %}</a>{% endif %}
        </td>
        <td>
          {% if g.get('can_view_summary') %}<a href="{{ game_href }}" style="text-decoration:none;color:inherit;">{% endif %}
          <span style="display:inline-flex;align-items:center;gap:6px;">
            <img src="{{ base }}/media/team_logo/{{ g['team1_id'] }}" alt="" style="width:22px;height:22px;border-radius:6px;object-fit:cover;" onerror="this.style.display='none'" />
            {% if has_score and s1 > s2 %}
              <strong>{{ g['team1_name'] }}</strong>
            {% else %}
              <span>{{ g['team1_name'] }}</span>
            {% endif %}
          </span>
          {% if g.get('can_view_summary') %}</a>{% endif %}
        </td>
      {% set gt = g.get('game_type_name') %}
      {% if not gt and (g.get('division_name') or '')|lower == 'external' %}
        {% set gt = 'Tournament' %}
      {% endif %}
      <td>{{ gt or '' }}</td>
      <td>{{ g['location'] or '' }}</td>
      <td>{% if g['team1_score'] is not none and g['team2_score'] is not none %}{{ g['team1_score'] }} - {{ g['team2_score'] }}{% else %}<span class="muted">—</span>{% endif %}</td>
      <td>
        {% if g.get('game_video_url') %}
          <a href="{{ g.get('game_video_url')|youtube_best_quality_url }}" target="_blank" rel="noopener noreferrer">Video</a>
        {% else %}
          <span class="muted">—</span>
        {% endif %}
      </td>
      <td>
        {% if g.get('can_view_summary') %}
          {% if public_league_id is defined %}
            <a class="btn" href="{{ game_href }}">View</a>
          {% else %}
            {% if g.get('can_edit') %}
              <a class="btn" href="{{ game_href }}{{ '&' if ('?' in game_href) else '?' }}edit=1">Edit</a>
            {% else %}
              <a class="btn" href="{{ game_href }}">View</a>
            {% endif %}
          {% endif %}
        {% else %}
          <span class="muted">—</span>
        {% endif %}
      </td>
      </tr>
    {% else %}
      <tr><td colspan="{% if league_view %}10{% else %}9{% endif %}" class="muted">No games yet.</td></tr>
    {% endfor %}
  </tbody>
</table>
{% endblock %}

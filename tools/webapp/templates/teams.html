{% extends "layout.html" %}
{% load webapp_tags %}
{% block content %}
<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem;">
  <h2>{% if league_view %}League Teams{% else %}Your Teams{% endif %}</h2>
  <div style="display:flex;flex-direction:column;align-items:flex-end;gap:.35rem;">
    {% if league_page_views %}
      <div
        data-hm-league-pageviews="1"
        data-league-id="{{ league_page_views.league_id }}"
        data-kind="{{ league_page_views.kind }}"
        data-entity-id="{{ league_page_views.entity_id }}"
        class="muted"
        style="font-size:.85rem;white-space:nowrap;"
        title="Live page views (excluding your own views as league owner)"
      >
        Views: <span data-role="count">{{ league_page_views.count }}</span>
      </div>
    {% endif %}
    <div>
      {% if league_view %}
        {% if public_league_id %}
          {% url "public_league_schedule" league_id=public_league_id as schedule_path %}
        {% else %}
          {% url "schedule" as schedule_path %}
        {% endif %}
        <a class="btn" href="{{ schedule_path }}">Schedule</a>
      {% endif %}
      {% if not league_view %}
        <a class="btn" href="/teams?all={% if include_external %}0{% else %}1{% endif %}">{% if include_external %}Hide{% else %}Show{% endif %} external</a>
        <a class="btn primary" href="/teams/new" style="margin-left:.5rem">New team</a>
      {% endif %}
    </div>
  </div>
</div>

{% if league_view and divisions %}
  {% for div in divisions %}
    <h3 style="margin-top:1rem;">{{ div.name }}</h3>
    <table class="table-no-scroll-mobile">
      <thead>
        <tr>
          <th>Name</th>
          <th>GP</th>
          <th>Record</th>
          <th>GF/GA</th>
          <th>Pts</th>
          <th>Pts (Total)</th>
          <th>Rating</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        {% for t in div.teams %}
          {% with s=stats|get_item:t.id %}
          <tr>
            <td>
              <span style="display:inline-flex;align-items:center;gap:10px;">
                {% if public_league_id %}
                  {% url "public_media_team_logo" league_id=public_league_id team_id=t.id as team_logo %}
                  {% url "public_league_team_detail" league_id=public_league_id team_id=t.id as team_href %}
                {% else %}
                  {% url "media_team_logo" team_id=t.id as team_logo %}
                  {% url "team_detail" team_id=t.id as team_href %}
                {% endif %}
                <img src="{{ team_logo }}" alt="" style="width:28px;height:28px;border-radius:8px;object-fit:cover;" onerror="this.style.display='none'" />
                <a class="btn secondary" href="{{ team_href }}">{{ t.name }}</a>
              </span>
            </td>
            <td>{{ s.gp|default:"0" }}</td>
            <td>{{ s.wins|default:"0" }}-{{ s.losses|default:"0" }}-{{ s.ties|default:"0" }}</td>
            <td>{{ s.gf|default:"0" }}/{{ s.ga|default:"0" }}</td>
            <td>{{ s.points|default:"0" }}</td>
            <td>{{ s.points_total|default:s.points|default:"0" }}</td>
            <td>
              {% if t.mhr_rating != None %}
                {{ t.mhr_rating|floatformat:2 }}
              {% else %}
                <span class="muted">—</span>
              {% endif %}
            </td>
            <td></td>
          </tr>
          {% endwith %}
        {% empty %}
          <tr><td colspan="8" class="muted">No teams yet.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  {% endfor %}
{% else %}
  <table class="table-no-scroll-mobile">
    <thead>
      <tr>
        <th>Name</th>
        <th>GP</th>
        <th>Record</th>
        <th>GF/GA</th>
        <th>Pts</th>
        <th>Pts (Total)</th>
        {% if league_view %}<th>Rating</th>{% endif %}
        <th></th>
      </tr>
    </thead>
    <tbody>
      {% for t in teams %}
        {% with s=stats|get_item:t.id %}
        <tr>
          <td>
            <span style="display:inline-flex;align-items:center;gap:10px;">
              {% url "media_team_logo" team_id=t.id as team_logo %}
              {% url "team_detail" team_id=t.id as team_href %}
              <img src="{{ team_logo }}" alt="" style="width:28px;height:28px;border-radius:8px;object-fit:cover;" onerror="this.style.display='none'" />
              <a class="btn secondary" href="{{ team_href }}">{{ t.name }}</a>
              {% if not league_view and t.is_external %}<span class="muted" title="Opponent/team not owned">(external)</span>{% endif %}
            </span>
          </td>
          <td>{{ s.gp|default:"0" }}</td>
          <td>{{ s.wins|default:"0" }}-{{ s.losses|default:"0" }}-{{ s.ties|default:"0" }}</td>
          <td>{{ s.gf|default:"0" }}/{{ s.ga|default:"0" }}</td>
          <td>{{ s.points|default:"0" }}</td>
          <td>{{ s.points_total|default:s.points|default:"0" }}</td>
          {% if league_view %}
            <td>
              {% if t.mhr_rating != None %}
                {{ t.mhr_rating|floatformat:2 }}
              {% else %}
                <span class="muted">—</span>
              {% endif %}
            </td>
          {% endif %}
          <td>
            {% if not public_league_id and not league_view and t.user_id == current_user_id %}
              <a class="btn" href="/teams/{{ t.id }}/edit">Edit</a>
            {% endif %}
          </td>
        </tr>
        {% endwith %}
      {% empty %}
        <tr><td colspan="{% if league_view %}8{% else %}7{% endif %}" class="muted">No teams yet.</td></tr>
      {% endfor %}
    </tbody>
  </table>
{% endif %}
{% endblock %}

{% extends "layout.html" %}
{% load webapp_tags %}
{% block content %}
{% with return_to_enc=return_to|urlencode %}

<h2>Game Summary</h2>

<div class="card">
  <div style="display:flex;justify-content:space-between;gap:1rem;flex-wrap:wrap;">
    <div>
      {% if public_league_id %}
        {% url "public_league_team_detail" league_id=public_league_id team_id=game.team2_id as away_team_url %}
        {% url "public_league_team_detail" league_id=public_league_id team_id=game.team1_id as home_team_url %}
        {% url "public_media_team_logo" league_id=public_league_id team_id=game.team2_id as away_logo_url %}
        {% url "public_media_team_logo" league_id=public_league_id team_id=game.team1_id as home_logo_url %}
        {% url "public_hky_game_detail" league_id=public_league_id game_id=game.id as game_self_url %}
      {% else %}
        {% url "team_detail" team_id=game.team2_id as away_team_url %}
        {% url "team_detail" team_id=game.team1_id as home_team_url %}
        {% url "media_team_logo" team_id=game.team2_id as away_logo_url %}
        {% url "media_team_logo" team_id=game.team1_id as home_logo_url %}
        {% url "hky_game_detail" game_id=game.id as game_self_url %}
      {% endif %}
      <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
        <a href="{{ away_team_url }}" style="display:inline-flex;align-items:center;gap:10px;text-decoration:none;color:inherit;">
          <img src="{{ away_logo_url }}" alt="" style="width:44px;height:44px;border-radius:10px;object-fit:cover;" onerror="this.style.display='none'" />
          <strong>{{ game.team2_name }}</strong>
        </a>
        <span class="muted">at</span>
        <a href="{{ home_team_url }}" style="display:inline-flex;align-items:center;gap:10px;text-decoration:none;color:inherit;">
          <img src="{{ home_logo_url }}" alt="" style="width:44px;height:44px;border-radius:10px;object-fit:cover;" onerror="this.style.display='none'" />
          <strong>{{ game.team1_name }}</strong>
        </a>
      </div>
        <div class="muted" style="margin-top:.5rem;">
          <span class="nowrap">{{ game.starts_at|fmt_date }}</span>
          <span class="nowrap">{{ game.starts_at|fmt_time }}</span>
          {% if game.location %}<span> | {{ game.location }}</span>{% endif %}
          {% if game.game_video_url %}<span> | Video: <a class="game-video-link" href="{{ game.game_video_url|youtube_best_quality_url }}" target="_blank" rel="noopener noreferrer">link</a></span>{% endif %}
        </div>
      <div style="margin-top:.5rem;font-size:1.1rem;">
        {% if game.team1_score != None and game.team2_score != None %}
          <strong>{{ game.team2_score }} - {{ game.team1_score }}</strong>
        {% else %}
          <span class="muted">Score: —</span>
        {% endif %}
        {% if game.is_final %}<span class="muted"> (Final)</span>{% endif %}
      </div>
    </div>
    <div style="display:flex;flex-direction:column;align-items:flex-end;gap:.5rem;">
	      {% if league_page_views %}
	        <div
	          data-hm-league-pageviews="1"
	          data-league-id="{{ league_page_views.league_id }}"
	          data-kind="{{ league_page_views.kind }}"
	          data-entity-id="{{ league_page_views.entity_id }}"
	          class="muted"
	          style="font-size:.85rem;white-space:nowrap;display:inline-flex;align-items:center;gap:.35rem;"
	          title="Live page views (excluding your own views as league owner)"
	        >
	          <span>Views: <span data-role="count">{{ league_page_views.count }}</span></span>
	          <span
	            data-role="delta"
	            class="muted"
	            {% if league_page_views.delta_count != None %}style="display:inline;"{% else %}style="display:none;"{% endif %}
	          >{% if league_page_views.delta_count != None %}(+{{ league_page_views.delta_count }}){% endif %}</span>
	          <button
	            type="button"
	            data-role="mark"
	            class="btn secondary"
	            style="padding:.18rem .45rem;font-size:.75rem;line-height:1;box-shadow:none;"
	            title="Mark current views as baseline"
	          >Mark</button>
	        </div>
	      {% endif %}
      <div style="display:flex;align-items:center;gap:.5rem;">
        {% if not public_league_id %}
          {% if can_edit and not edit_mode %}
            <a class="btn primary" href="{{ game_self_url }}?edit=1&return_to={{ return_to_enc }}">Edit</a>
          {% endif %}
          {% if edit_mode %}
            <a class="btn" href="{{ game_self_url }}?return_to={{ return_to_enc }}">Cancel</a>
          {% endif %}
        {% endif %}
        <a class="btn" href="{{ back_url|default:"/schedule" }}">Back</a>
      </div>
    </div>
  </div>
  </div>

  {% if game.game_video_url %}
      <div id="event-video-pane" class="card" style="margin-top:1rem; display:none;">
        <div style="display:flex; align-items:center; justify-content:space-between; gap:1rem; flex-wrap:wrap;">
          <div>
            <strong>Video Clip</strong>
            <span id="event-video-pane-meta" class="muted" style="margin-left:.5rem;"></span>
          </div>
          <div style="display:flex; align-items:center; gap:.5rem;">
            <a
              id="event-video-open-link"
              class="btn"
              href=""
              target="_blank"
              rel="noopener noreferrer"
              style="display:none;"
            >Open on YouTube</a>
            <button type="button" class="btn" id="event-video-pane-close">Close</button>
          </div>
        </div>
        <div style="margin-top:.75rem; width:100%; max-width: 980px;">
          <div style="position:relative; width:100%; aspect-ratio:16/9; background:#0b1220; border-radius:12px; overflow:hidden;">
            <iframe
              id="event-video-iframe"
            title="Game video clip"
            src=""
            style="position:absolute; inset:0; width:100%; height:100%; border:0;"
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
            allowfullscreen
          ></iframe>
        </div>
      </div>
      <div class="yt-quality-hint">
        <span class="yt-quality-text">Click the gear icon and select Highest quality</span>
        <span class="yt-quality-arrow" aria-hidden="true">↑</span>
      </div>
      <p class="muted" style="margin:.75rem 0 0 0;">Tip: double-click an event row, or open the timeline tooltip and press Video to view a clip (2/3 before, 1/3 after the event).</p>
    </div>
  {% endif %}
  
  {% if scoring_by_period_rows %}
    <div class="card" style="margin-top:1rem;">
    <h3 style="margin-top:0;">Scoring By Period</h3>
    <div class="table-scroll">
      <table class="table-grid table-nowrap">
        <thead>
          <tr>
            <th>Period</th>
            <th>{{ game.team1_name }}</th>
            <th>{{ game.team2_name }}</th>
          </tr>
        </thead>
        <tbody>
          {% for r in scoring_by_period_rows %}
            <tr>
              <td>{% if r.period == 4 %}OT{% else %}P{{ r.period }}{% endif %}</td>
              <td>{{ r.team1_gf|default_if_none:"0" }}</td>
              <td>{{ r.team2_gf|default_if_none:"0" }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <p class="muted" style="margin:.5rem 0 0 0;">Derived from goal events (TimeToScore / uploaded events), not shifts.</p>
  </div>
{% endif %}

{% if game_event_stats_rows %}
  <div class="card" style="margin-top:1rem;">
    <h3 style="margin-top:0">Game Stats</h3>
    <p class="muted" style="margin-top:0">
      Source:
      {% if events_meta and events_meta.sources %}
        {{ events_meta.sources|join:", " }}
      {% elif events_meta and events_meta.source_label %}
        {{ events_meta.source_label }}
      {% else %}
        —
      {% endif %}
      {% if events_meta and events_meta.updated_at %} | Updated: {{ events_meta.updated_at|fmt_date }}{% endif %}
    </p>
    <div class="table-scroll">
      <table class="table-grid table-sortable" data-sortable="1">
        <thead>
          <tr>
            <th>Event Type</th>
            <th>
              <div>Home</div>
              <div class="muted" style="font-weight:700;margin-top:.15rem;">{{ game.team1_name }}</div>
            </th>
            <th>
              <div>Away</div>
              <div class="muted" style="font-weight:700;margin-top:.15rem;">{{ game.team2_name }}</div>
            </th>
          </tr>
        </thead>
        <tbody>
          {% for r in game_event_stats_rows %}
            <tr>
              <td>{{ r.event_type|default_if_none:"" }}</td>
              <td>{{ r.home|default_if_none:"" }}</td>
              <td>{{ r.away|default_if_none:"" }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
{% endif %}

<div class="card">
  {% if edit_mode and not public_league_id %}
    <form method="post" action="{{ game_self_url }}?edit=1&return_to={{ return_to_enc }}">
      {% csrf_token %}
  {% endif %}

  {% if edit_mode and not public_league_id %}
    <h3 style="margin-top:0">Game Details</h3>
    <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 1rem;">
      <div class="form-row">
        <label class="muted">Team 1 Score</label>
        <input type="number" name="team1_score" value="{{ game.team1_score|default_if_none:"" }}" min="0">
      </div>
      <div class="form-row">
        <label class="muted">Team 2 Score</label>
        <input type="number" name="team2_score" value="{{ game.team2_score|default_if_none:"" }}" min="0">
      </div>
    </div>
    <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 1rem;">
      <div class="form-row">
        <label class="muted">Date/Time</label>
        <input type="datetime-local" name="starts_at" value="{{ game.starts_at|date:"Y-m-d\\TH:i" }}">
      </div>
      <div class="form-row">
        <label class="muted">Location</label>
        <input type="text" name="location" value="{{ game.location|default_if_none:"" }}">
      </div>
    </div>
    <div class="form-row">
      <label><input type="checkbox" name="is_final" {% if game.is_final %}checked{% endif %}> Final</label>
    </div>
  {% endif %}

  <h3>Rosters</h3>
  <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 1rem;">
    <div>
      <h4 style="display:flex;align-items:center;gap:8px;">
        <img src="{{ home_logo_url }}" alt="" style="width:26px;height:26px;border-radius:8px;object-fit:cover;" onerror="this.style.display='none'" />
        <span>{{ game.team1_name }}</span>
      </h4>
      <div class="table-scroll">
        <table class="table-nowrap table-grid table-sortable" data-sortable="1" data-freeze-cols="2">
          <thead><tr><th>#</th><th>Name</th><th>Pos</th></tr></thead>
          <tbody>
            {% for p in team1_roster %}
              <tr>
                <td>{{ p.jersey_number|default_if_none:"" }}</td>
                <td><span class="hm-player-name">{% include "_player_icon.html" with position=p.position %}<span>{{ p.name|default_if_none:"" }}</span></span></td>
                <td>{{ p.position|default_if_none:"" }}</td>
              </tr>
            {% empty %}
              <tr><td colspan="3" class="muted">No players</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <div>
      <h4 style="display:flex;align-items:center;gap:8px;">
        <img src="{{ away_logo_url }}" alt="" style="width:26px;height:26px;border-radius:8px;object-fit:cover;" onerror="this.style.display='none'" />
        <span>{{ game.team2_name }}</span>
      </h4>
      <div class="table-scroll">
        <table class="table-nowrap table-grid table-sortable" data-sortable="1" data-freeze-cols="2">
          <thead><tr><th>#</th><th>Name</th><th>Pos</th></tr></thead>
          <tbody>
            {% for p in team2_roster %}
              <tr>
                <td>{{ p.jersey_number|default_if_none:"" }}</td>
                <td><span class="hm-player-name">{% include "_player_icon.html" with position=p.position %}<span>{{ p.name|default_if_none:"" }}</span></span></td>
                <td>{{ p.position|default_if_none:"" }}</td>
              </tr>
            {% empty %}
              <tr><td colspan="3" class="muted">No players</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <h3 style="margin-top:1rem;">{% if player_stats_import_meta %}Imported Player Stats{% else %}Player Stats{% endif %}</h3>
  {% if player_stats_import_meta %}
    {# Source/updated lines below cover what the user needs here. #}
  {% endif %}
  {% if player_stats_import_meta %}
    <p class="muted" style="margin-top:0;">
      {% if player_stats_import_meta.source_label %}Source: {{ player_stats_import_meta.source_label }}{% endif %}
      {% if player_stats_import_meta.updated_at %} | Updated: {{ player_stats_import_meta.updated_at|fmt_date }}{% endif %}
    </p>
  {% endif %}
  {% if player_stats_import_warning %}
    <p class="muted" style="margin-top:0;">Warning: {{ player_stats_import_warning }}</p>
  {% endif %}

  <h4 style="display:flex;align-items:center;gap:8px;margin-top:0.75rem;">
    <img src="{{ home_logo_url }}" alt="" style="width:26px;height:26px;border-radius:8px;object-fit:cover;" onerror="this.style.display='none'" />
    <span>{{ game.team1_name }}</span>
  </h4>
  {% include "_player_stats_table.html" with rows=team1_player_stats_rows columns=game_player_stats_columns show_position=False table_sortable=True freeze_cols=2 player_stats_table=True team_side="home" include_stat_key_attrs=True events_button_kind="game" cell_conflicts_by_player_id=player_stats_cell_conflicts_by_pid edit_mode=edit_mode public_league_id=public_league_id empty_label="No players" %}

  <h4 style="display:flex;align-items:center;gap:8px;margin-top:0.75rem;">
    <img src="{{ away_logo_url }}" alt="" style="width:26px;height:26px;border-radius:8px;object-fit:cover;" onerror="this.style.display='none'" />
    <span>{{ game.team2_name }}</span>
  </h4>
  {% include "_player_stats_table.html" with rows=team2_player_stats_rows columns=game_player_stats_columns show_position=False table_sortable=True freeze_cols=2 player_stats_table=True team_side="away" include_stat_key_attrs=True events_button_kind="game" cell_conflicts_by_player_id=player_stats_cell_conflicts_by_pid edit_mode=edit_mode public_league_id=public_league_id empty_label="No players" %}

  {% if goalie_stats_has_sog %}
  <h3 style="margin-top:1.25rem;">Goalie Stats</h3>

  <h4 style="display:flex;align-items:center;gap:8px;margin-top:0.75rem;">
    <img src="{{ home_logo_url }}" alt="" style="width:26px;height:26px;border-radius:8px;object-fit:cover;" onerror="this.style.display='none'" />
    <span>{{ game.team1_name }}</span>
  </h4>
  <div class="table-scroll">
    <table class="table-nowrap table-grid table-sortable" data-sortable="1" data-freeze-cols="2">
      <thead>
        <tr>
          <th>#</th><th>Name</th><th>TOI</th><th>GA</th>
          {% if goalie_stats_has_xg %}
            <th>xGA</th><th>xGSV</th><th>xGSV%</th>
          {% endif %}
          <th>SA</th><th>SV</th><th>SV%</th>
        </tr>
      </thead>
      <tbody>
        {% for g in goalie_stats_home_rows %}
          <tr>
            <td>{{ g.jersey_number|default_if_none:"" }}</td>
            <td>{{ g.name|default_if_none:"" }}</td>
            <td>{{ g.toi_seconds|fmt_toi }}</td>
            <td>{{ g.ga|fmt_stat }}</td>
            {% if goalie_stats_has_xg %}
              <td>{{ g.xga|fmt_stat }}</td>
              <td>{{ g.xg_saves|fmt_stat }}</td>
              <td>{{ g.xg_sv_pct|fmt_stat }}</td>
            {% endif %}
            <td>{{ g.sa|fmt_stat }}</td>
            <td>{{ g.saves|fmt_stat }}</td>
            <td>{{ g.sv_pct|fmt_stat }}</td>
          </tr>
        {% empty %}
          <tr><td colspan="{% if goalie_stats_has_xg %}10{% else %}7{% endif %}" class="muted">No goalie stats.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <h4 style="display:flex;align-items:center;gap:8px;margin-top:0.75rem;">
    <img src="{{ away_logo_url }}" alt="" style="width:26px;height:26px;border-radius:8px;object-fit:cover;" onerror="this.style.display='none'" />
    <span>{{ game.team2_name }}</span>
  </h4>
  <div class="table-scroll">
    <table class="table-nowrap table-grid table-sortable" data-sortable="1" data-freeze-cols="2">
      <thead>
        <tr>
          <th>#</th><th>Name</th><th>TOI</th><th>GA</th>
          {% if goalie_stats_has_xg %}
            <th>xGA</th><th>xGSV</th><th>xGSV%</th>
          {% endif %}
          <th>SA</th><th>SV</th><th>SV%</th>
        </tr>
      </thead>
      <tbody>
        {% for g in goalie_stats_away_rows %}
          <tr>
            <td>{{ g.jersey_number|default_if_none:"" }}</td>
            <td>{{ g.name|default_if_none:"" }}</td>
            <td>{{ g.toi_seconds|fmt_toi }}</td>
            <td>{{ g.ga|fmt_stat }}</td>
            {% if goalie_stats_has_xg %}
              <td>{{ g.xga|fmt_stat }}</td>
              <td>{{ g.xg_saves|fmt_stat }}</td>
              <td>{{ g.xg_sv_pct|fmt_stat }}</td>
            {% endif %}
            <td>{{ g.sa|fmt_stat }}</td>
            <td>{{ g.saves|fmt_stat }}</td>
            <td>{{ g.sv_pct|fmt_stat }}</td>
          </tr>
        {% empty %}
          <tr><td colspan="{% if goalie_stats_has_xg %}10{% else %}7{% endif %}" class="muted">No goalie stats.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% endif %}

  {% if edit_mode and not public_league_id %}
    <div style="margin-top:.75rem;">
      <button class="btn primary" type="submit">Save</button>
    </div>
    </form>

    {# Roster/stats imports are event-driven via the import endpoints; no per-game player_stats.csv uploads. #}
  {% endif %}
</div>

<div class="card" style="margin-top:1rem;">
  <h3 style="margin-top:0;">Game Events</h3>
  {% if events_meta %}
    <p class="muted" style="margin-top:0;">
      {% if events_meta.sources %}Sources: {{ events_meta.sources|join:", " }}{% elif events_meta.source_label %}Source: {{ events_meta.source_label }}{% endif %}
      {% if events_meta.updated_at %} | Updated: {{ events_meta.updated_at|fmt_date }}{% endif %}
      {% if events_meta.count %} | Rows: {{ events_meta.count }}{% endif %}
    </p>
  {% endif %}
  {% if events_rows and events_headers %}
      <div id="timeline-clip-controls" class="muted" style="margin:.25rem 0 .5rem 0; display:none; align-items:center; gap:.35rem; flex-wrap:wrap;">
        <label for="timeline-clip-len" class="muted" style="font-size:.85rem;">Clip Length</label>
        <select id="timeline-clip-len" style="padding:.25rem .5rem;border-radius:10px;">
          <option value="15">15s</option>
          <option value="20">20s</option>
          <option value="30" selected>30s</option>
          <option value="45">45s</option>
          <option value="60">60s</option>
          <option value="90">90s</option>
        </select>
      </div>
    <div class="events-timeline">
      <div class="events-timeline-header">
        <div class="muted">Timeline</div>
        <div id="game-events-timeline-legend" class="events-timeline-legend"></div>
      </div>
      <div class="events-timeline-wrap">
        <svg id="game-events-timeline-svg" class="events-timeline-svg" role="img" aria-label="Game events timeline"></svg>
      </div>
      <script type="application/json" id="game-events-timeline-data">{{ events_rows|tojson }}</script>
      <script type="application/json" id="game-shifts-timeline-data">{{ shift_timeline_rows|tojson }}</script>
      <script>
        (function () {
          var dataEl = document.getElementById("game-events-timeline-data");
          var shiftEl = document.getElementById("game-shifts-timeline-data");
          var svg = document.getElementById("game-events-timeline-svg");
          var legendEl = document.getElementById("game-events-timeline-legend");
          var clipControlsEl = document.getElementById("timeline-clip-controls");
          var clipLenEl = document.getElementById("timeline-clip-len");
          if (!dataEl || !svg || !legendEl) return;
          var userClipLenS = {{ user_video_clip_len_s|tojson }};
          var userIsLoggedIn = {{ user_is_logged_in|tojson }};
          var showShiftData = {{ show_shift_data|tojson }};

            var homeTeamName = {{ game.team1_name|default:"Home"|tojson }};
            var awayTeamName = {{ game.team2_name|default:"Away"|tojson }};
            var gameVideoUrl = {{ game.game_video_url|default:""|tojson }};
            var hmPublicLeagueId = {{ public_league_id|default:"null"|tojson }};
            var hmSelectedLeagueId = {{ selected_league_id|tojson }};
  
              var videoPane = document.getElementById("event-video-pane");
              var videoIframe = document.getElementById("event-video-iframe");
              var videoMeta = document.getElementById("event-video-pane-meta");
              var videoOpen = document.getElementById("event-video-open-link");
              var videoClose = document.getElementById("event-video-pane-close");
              if (videoClose) {
                videoClose.addEventListener("click", function () {
                  if (videoIframe) videoIframe.src = "";
                  if (videoOpen) {
                    videoOpen.href = "";
                    videoOpen.style.display = "none";
                  }
                  if (videoPane) videoPane.style.display = "none";
                });
              }

          var eventsRows = [];
          try {
            eventsRows = JSON.parse(dataEl.textContent || "[]") || [];
          } catch (e) {
            eventsRows = [];
          }
          if (!Array.isArray(eventsRows)) eventsRows = [];
          // Shift on-ice/off-ice events are intentionally not shown on the game events timeline.
          if (eventsRows.length === 0) return;

          function parseTimeToSeconds(s) {
            s = (s || "").trim();
            if (!s) return null;
            var m = s.match(/^(\d+):(\d{2})(?::(\d{2}))?$/);
            if (!m) return null;
            var a = parseInt(m[1], 10);
            var b = parseInt(m[2], 10);
            var c = m[3] ? parseInt(m[3], 10) : null;
            if (c === null) return a * 60 + b; // mm:ss
            return a * 3600 + b * 60 + c; // h:mm:ss
          }

            function parseTimeToSecondsLoose(s) {
            var t = parseTimeToSeconds(s);
            if (t !== null && isFinite(t)) return t;
            s = String(s || "").trim();
            if (!s) return null;
            // Support TimeToScore dot formats:
            //  - "10.0" => 10:00 (mm:ss with '.' separator)
            //  - "54.8" => 54.8 seconds (scoreboard fractional seconds)
            var m = s.match(/^(\d+)\.(\d{1,2})$/);
            if (!m) return null;
            var a = parseInt(m[1], 10);
            var b = parseInt(m[2], 10);
            if (!isFinite(a) || !isFinite(b)) return null;
            if (a > 20) {
              var f = parseFloat(s);
              return isFinite(f) ? Math.floor(f) : null;
            }
            return a * 60 + b;
          }

    function getValue(row, keys) {
      if (!row) return "";
      for (var i = 0; i < keys.length; i++) {
        var k = keys[i];
        if (Object.prototype.hasOwnProperty.call(row, k)) return row[k];
        var kl = String(k).toLowerCase();
        for (var kk in row) {
          if (!Object.prototype.hasOwnProperty.call(row, kk)) continue;
          if (String(kk).toLowerCase() === kl) return row[kk];
        }
      }
      return "";
    }
          function parsePeriod(p) {
            var s = String(p || "").trim();
            if (!s) return null;
            var sl = s.toLowerCase();
            if (sl === "ot" || sl === "overtime") return 4;
            var m = sl.match(/(\d+)/);
            if (!m) return null;
            var n = parseInt(m[1], 10);
            return isFinite(n) && n > 0 ? n : null;
          }

          function normalizeTypeLabel(raw) {
            var s = String(raw || "").trim();
            if (!s) return "";
            var sl = s.toLowerCase();
            if (sl === "expectedgoal" || sl === "expected goal" || sl === "xg" || sl === "expected goal (xg)") return "Expected Goal (xG)";
            if (sl === "shots on goal" || sl === "shot on goal" || sl === "sog") return "SOG";
            if (sl === "shot") return "Shot";
            if (sl === "goal") return "Goal";
            if (sl === "assist") return "Assist";
            if (sl === "penalty") return "Penalty";
            if (sl === "penalty expired" || sl === "penaltyexpired") return "Penalty Expired";
            if (sl === "powerplay" || sl === "power play" || sl === "pp") return "Power Play";
            if (sl === "penaltykill" || sl === "penalty kill" || sl === "pk") return "Penalty Kill";
            if (sl === "completedpass" || sl === "completed pass" || sl === "completed passes") return "Completed Pass";
            if (sl === "on-ice" || sl === "on ice" || sl === "playeronice") return "On-Ice";
            if (sl === "off-ice" || sl === "off ice" || sl === "playeroffice") return "Off-Ice";
            if (sl.indexOf("rush") >= 0) return "Odd-Man Rushes";
            if (sl === "controlledentry" || sl === "controlled entry") return "Controlled Entry";
            if (sl === "controlledexit" || sl === "controlled exit") return "Controlled Exit";
            if (sl.indexOf("turnover") >= 0 && sl.indexOf("forced") >= 0) return "Turnovers (forced)";
            if (sl.indexOf("created") >= 0 && sl.indexOf("turnover") >= 0) return "Created Turnovers";
            if (sl === "giveaway") return "Giveaway";
            if (sl === "takeaway") return "Takeaway";
            return s;
          }

          function typeKey(label) {
            var sl = String(label || "").trim().toLowerCase();
            if (!sl) return "other";
            if (sl === "goal") return "goal";
            if (sl === "assist") return "assist";
            if (sl === "xg" || sl === "expected goal" || sl === "expectedgoal" || sl === "expected goal (xg)" || sl.indexOf("xg") >= 0) return "xg";
            if (sl === "sog") return "sog";
            if (sl === "shot") return "shot";
            if (sl === "penalty") return "penalty";
            if (sl === "penalty expired") return "penalty_expired";
            if (sl === "power play" || sl === "pp") return "pp";
            if (sl === "penalty kill" || sl === "pk") return "pk";
            if (sl === "controlled entry") return "controlled_entry";
            if (sl === "controlled exit") return "controlled_exit";
            if (sl === "completed pass" || sl === "completed passes") return "completed_pass";
            if (sl === "on-ice" || sl === "on ice") return "on_ice";
            if (sl === "off-ice" || sl === "off ice") return "off_ice";
            if (sl.indexOf("rush") >= 0) return "odd_man_rush";
            if (sl.indexOf("turnovers") >= 0 && sl.indexOf("forced") >= 0) return "turnover_forced";
            if (sl.indexOf("created") >= 0 && sl.indexOf("turnovers") >= 0) return "turnover_created";
            if (sl.indexOf("turnover") >= 0 && sl.indexOf("forced") >= 0) return "turnover_forced";
            if (sl.indexOf("created") >= 0 && sl.indexOf("turnover") >= 0) return "turnover_created";
            if (sl === "giveaway") return "giveaway";
            if (sl === "takeaway") return "takeaway";
            return "other";
          }

          function isFinishFamily(k) {
            return k === "shot" || k === "sog" || k === "xg" || k === "goal";
          }

          function finishPriority(k) {
            if (k === "goal") return 4;
            if (k === "xg") return 3;
            if (k === "sog") return 2;
            if (k === "shot") return 1;
            return 0;
          }

          function laneKey(iconKey) {
            if (iconKey === "penalty" || iconKey === "pp" || iconKey === "pk") return "special_teams";
            if (isFinishFamily(iconKey)) return "finish";
            if (iconKey === "controlled_entry" || iconKey === "controlled_exit") return "transition";
            if (iconKey === "completed_pass") return "completed_pass";
            if (iconKey === "on_ice" || iconKey === "off_ice") return "shift";
            return iconKey;
          }

            function parseSide(row) {
            // Absolute side (Home/Away). Do NOT treat For/Against as a team; it's only a relative
            // direction *with respect to* Home or Away.
            var tr = String(getValue(row, ["Team Side", "TeamSide", "Team Rel", "TeamRel", "Side", "Team", "Team Raw", "TeamRaw"]) || "").trim();
            var trl = tr.toLowerCase();
            if (trl === "home" || trl === "team1") return "Home";
            if (trl === "away" || trl === "team2") return "Away";
              return "Neutral";
            }
  
            function parseVideoSecondsFromRow(row) {
              var vs = String(getValue(row, ["Video Seconds", "VideoSeconds", "Video S", "VideoS"]) || "").trim();
              if (vs && vs.match(/^-?\d+$/)) {
                var n = parseInt(vs, 10);
                return isFinite(n) ? n : null;
              }
              var vt = String(getValue(row, ["Video Time", "VideoTime"]) || "").trim();
              var t = parseTimeToSeconds(vt);
              return t !== null && isFinite(t) ? t : null;
            }
  
            function extractYoutubeId(url) {
              if (!url) return null;
              try {
                var u = new URL(String(url));
                var host = String(u.hostname || "").toLowerCase();
                if (host === "youtu.be") {
                  var p = String(u.pathname || "").replace(/^\//, "");
                  return p ? p.split("/")[0] : null;
                }
                  if (host.indexOf("youtube.com") >= 0 || host.indexOf("youtube-nocookie.com") >= 0) {
                    var v = u.searchParams.get("v");
                    if (v) return v;
                    var path = String(u.pathname || "");
                    var m = path.match(/\/embed\/([^/?#]+)/) || path.match(/\/shorts\/([^/?#]+)/);
                    return m ? m[1] : null;
                  }
                } catch (e) {}
                return null;
              }

              function buildYoutubeWatchUrl(url, startSec) {
                var id = extractYoutubeId(url);
                if (!id) return null;
                var start = Math.max(0, Math.floor(startSec || 0));
                try {
                  var w = new URL("https://www.youtube.com/watch");
                  w.searchParams.set("v", String(id));
                  w.searchParams.set("t", String(start) + "s");
                  w.searchParams.set("autoplay", "1");
                  w.searchParams.set("vq", "highres");
                  return w.toString();
                } catch (e) {
                  return null;
                }
              }

              function buildYoutubeEmbedUrl(url, startSec, endSec) {
                var id = extractYoutubeId(url);
                if (!id) return null;
                var start = Math.max(0, Math.floor(startSec || 0));
                var end = Math.max(start + 1, Math.floor(endSec || 0));
                var params = new URLSearchParams();
                params.set("autoplay", "1");
                // Mobile browsers often block autoplay unless muted (even when initiated by a tap).
                params.set("mute", "1");
                // Enable JS API so we can request the highest available resolution.
                params.set("enablejsapi", "1");
                params.set("origin", String(window.location.origin || ""));
                params.set("start", String(start));
                params.set("end", String(end));
                // Best-effort quality hint (YouTube may ignore based on bandwidth/device/player size).
                params.set("vq", "highres");
                params.set("rel", "0");
              params.set("modestbranding", "1");
              params.set("playsinline", "1");
              return "https://www.youtube-nocookie.com/embed/" + encodeURIComponent(id) + "?" + params.toString();
            }

            function requestYouTubeBestQuality(iframeEl) {
              try {
                if (!iframeEl || !iframeEl.contentWindow) return;
                var cmds = [
                  { func: "setPlaybackQuality", args: ["highres"] },
                  { func: "setPlaybackQuality", args: ["hd2160"] },
                  { func: "setPlaybackQuality", args: ["hd1440"] },
                  { func: "setPlaybackQuality", args: ["hd1080"] },
                  { func: "setPlaybackQuality", args: ["hd720"] },
                  { func: "setPlaybackQuality", args: ["large"] },
                  { func: "setPlaybackQualityRange", args: ["highres", "hd1080"] },
                ];
                for (var i = 0; i < cmds.length; i++) {
                  iframeEl.contentWindow.postMessage(
                    JSON.stringify({ event: "command", func: cmds[i].func, args: cmds[i].args || [] }),
                    "*"
                  );
                }
              } catch (e) {}
            }

            function normTypeKey(s) {
              return String(s || "").trim().toLowerCase().replace(/[^a-z0-9]+/g, "");
            }
  
                function openVideoClipForRow(row, opts) {
                  opts = opts || {};
                  if (!gameVideoUrl || !videoPane || !videoIframe) return false;
                  var vs2 = parseVideoSecondsFromRow(row);
                  if (vs2 === null || !isFinite(vs2)) return false;
                try {
                  var leagueId = (hmPublicLeagueId !== null && hmPublicLeagueId !== undefined) ? hmPublicLeagueId : hmSelectedLeagueId;
                  var raw = row ? row["__hm_event_row_id"] : null;
                  var eid = null;
                  try { eid = parseInt(String(raw || "").trim(), 10); } catch (e) { eid = null; }
                  if (leagueId !== null && leagueId !== undefined && eid !== null && isFinite(eid) && eid > 0) {
                    fetch("/api/leagues/" + encodeURIComponent(String(leagueId)) + "/page_views/record", {
                      method: "POST",
                      credentials: "same-origin",
                      headers: { "Content-Type": "application/json" },
                      body: JSON.stringify({ kind: "event_clip", entity_id: eid }),
                    }).catch(function () {});
                  }
                } catch (e) {}
                var etKey = normTypeKey(getValue(row, ["Event Type", "Event"]));
                var totalClipS = 30;
                var preS = 20;
                var postS = 10;
                if (etKey === "completedpass") {
                  totalClipS = 10;
                  preS = 5;
                  postS = 5;
                } else {
                  totalClipS = (function () {
                    var v = 30;
                    try {
                      if (clipLenEl && String(clipLenEl.value || "").trim()) v = parseInt(String(clipLenEl.value || ""), 10);
                    } catch (e) {}
                    if (!isFinite(v) || v <= 0) v = 30;
                    if (v !== 15 && v !== 20 && v !== 30 && v !== 45 && v !== 60 && v !== 90) v = 30;
                    return v;
                  })();
                  preS = Math.max(0, Math.round(totalClipS * 2 / 3));
                  postS = Math.max(0, totalClipS - preS);
                }
                var start2 = Math.max(0, Math.floor(vs2 - preS));
                var end2 = Math.max(start2 + 1, Math.floor(vs2 + postS));
                var watchUrl = buildYoutubeWatchUrl(gameVideoUrl, start2);
                if (videoOpen) {
                  videoOpen.href = watchUrl || "";
                  videoOpen.style.display = watchUrl ? "" : "none";
                }
                var embed = buildYoutubeEmbedUrl(gameVideoUrl, start2, end2);
                if (!embed) {
                  try {
                    var u2 = new URL(String(gameVideoUrl));
                    u2.searchParams.set("t", String(start2) + "s");
                    u2.searchParams.set("autoplay", "1");
                    u2.searchParams.set("vq", u2.searchParams.get("vq") || "highres");
                    window.open(u2.toString(), "_blank", "noopener");
                  } catch (e) {
                    window.open(String(gameVideoUrl), "_blank", "noopener");
                  }
                return true;
              }
              videoIframe.src = embed;
              videoIframe.setAttribute("src", embed);
              // Best-effort: request highest available quality after navigation.
              try {
                requestYouTubeBestQuality(videoIframe);
                window.setTimeout(function () { requestYouTubeBestQuality(videoIframe); }, 250);
                window.setTimeout(function () { requestYouTubeBestQuality(videoIframe); }, 800);
              } catch (e) {}
              if (videoMeta) {
                var label = (opts.label ? String(opts.label) : "");
                var at = (opts.at ? String(opts.at) : "");
                var metaTxt = [];
                if (label) metaTxt.push(label);
                if (at) metaTxt.push(at);
                metaTxt.push(totalClipS + "s clip (" + preS + "s before, " + postS + "s after)");
                videoMeta.textContent = metaTxt.join(" • ");
              }
              videoPane.style.display = "block";
              try {
                videoPane.scrollIntoView({ behavior: "smooth", block: "start" });
              } catch (e) {}
              return true;
            }

            try { window.hmOpenVideoClipForRow = openVideoClipForRow; } catch (e) {}

          function svgEl(name, attrs) {
            var el = document.createElementNS("http://www.w3.org/2000/svg", name);
            if (attrs) {
              for (var k in attrs) {
                if (!Object.prototype.hasOwnProperty.call(attrs, k)) continue;
                el.setAttribute(k, String(attrs[k]));
              }
            }
            return el;
          }

          function iconGroup(icon, opts) {
            opts = opts || {};
            var size = opts.size || 16;
            var s = size / 24;
            var g = svgEl("g", { transform: "scale(" + s + ") translate(-12,-12)" });
            var stroke = opts.stroke || "rgba(255,255,255,0.6)";

            function circle(cx, cy, r, fill, st, sw) {
              g.appendChild(
                svgEl("circle", {
                  cx: cx,
                  cy: cy,
                  r: r,
                  fill: fill,
                  stroke: st || "none",
                  "stroke-width": sw || 0,
                })
              );
            }
            function path(d, fill, st, sw, linecap, linejoin) {
              var p = svgEl("path", {
                d: d,
                fill: fill || "none",
                stroke: st || "none",
                "stroke-width": sw || 0,
              });
              if (linecap) p.setAttribute("stroke-linecap", linecap);
              if (linejoin) p.setAttribute("stroke-linejoin", linejoin);
              g.appendChild(p);
            }
            function rect(x, y, w, h, rx, fill, st, sw) {
              g.appendChild(
                svgEl("rect", {
                  x: x,
                  y: y,
                  width: w,
                  height: h,
                  rx: rx || 0,
                  fill: fill || "none",
                  stroke: st || "none",
                  "stroke-width": sw || 0,
                })
              );
            }
            function text(x, y, txt, fill, fs, fw) {
              var t = svgEl("text", {
                x: x,
                y: y,
                fill: fill || "#fff",
                "font-size": fs || 10,
                "font-weight": fw || 800,
                "text-anchor": "middle",
                "dominant-baseline": "central",
                "font-family": "Inter, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial",
              });
              t.appendChild(document.createTextNode(txt));
              g.appendChild(t);
            }

            if (icon === "goal") {
              // Symmetric flashing red light (siren).
              // Make the red light occupy most of the icon for visibility.
              rect(4.5, 10, 15, 10.5, 5.2, "#ff2d2d", "rgba(0,0,0,0.30)", 1);
              path("M8 10a4 4 0 0 1 8 0v2H8z", "#ff2d2d", "rgba(0,0,0,0.30)", 1, "round", "round");
              path("M9 10a3 3 0 0 1 6 0", "none", "#ffe2e2", 2.4, "round", "round");
              rect(10.8, 7.6, 2.4, 3.4, 1.2, "#ffe2e2", "none", 0);
              path("M3.6 15h3.2", "none", "#ffb3b3", 2.4, "round", "round");
              path("M17.2 15H20.4", "none", "#ffb3b3", 2.4, "round", "round");
              path("M4.6 10.6l2.3 1.8", "none", "#ffb3b3", 2.4, "round", "round");
              path("M19.4 10.6l-2.3 1.8", "none", "#ffb3b3", 2.4, "round", "round");
              path("M12 5.2v2.8", "none", "#ffb3b3", 2.4, "round", "round");
            } else if (icon === "xg") {
              // Transparent crosshairs + purple "X" overlay (no outside circle).
              // Symmetric crosshair arms that do NOT enter the inner circle.
              var ch = "rgba(255,255,255,0.85)";
              var sw = 2.0;
              // Arms (with a small gap before the circle).
              path("M12 3.8V7.0", "none", ch, sw, "round", "round");
              path("M12 17.0V20.2", "none", ch, sw, "round", "round");
              path("M3.8 12H7.0", "none", ch, sw, "round", "round");
              path("M17.0 12H20.2", "none", ch, sw, "round", "round");
              // Inner circle (larger, as requested).
              circle(12, 12, 4.2, "none", ch, sw);
              // X is prominent but still inside the crosshairs.
              path("M8.8 8.8l6.4 6.4", "none", "#7c4dff", 2.8, "round", "round");
              path("M15.2 8.8l-6.4 6.4", "none", "#7c4dff", 2.8, "round", "round");
            } else if (icon === "sog") {
              // Transparent crosshairs only (no outside circle).
              var ch2 = "rgba(255,255,255,0.85)";
              var sw2 = 2.0;
              path("M12 3.8V7.0", "none", ch2, sw2, "round", "round");
              path("M12 17.0V20.2", "none", ch2, sw2, "round", "round");
              path("M3.8 12H7.0", "none", ch2, sw2, "round", "round");
              path("M17.0 12H20.2", "none", ch2, sw2, "round", "round");
              circle(12, 12, 4.2, "none", ch2, sw2);
            } else if (icon === "shot") {
              circle(9.5, 14.5, 3.8, "#111827", "rgba(255,255,255,0.2)", 1);
              path("M13 12l8-6", "none", stroke, 2, "round", "round");
              path("M15 14l6-4", "none", stroke, 2, "round", "round");
            } else if (icon === "assist") {
              // Assist: simple hand.
              var skin2 = "rgba(230,232,236,0.92)";
              var edge2 = "rgba(0,0,0,0.42)";
              // Palm + thumb.
              rect(7.2, 10.2, 8.8, 9.0, 2.2, skin2, edge2, 1.0);
              rect(5.0, 12.0, 3.0, 5.2, 1.6, skin2, edge2, 1.0);
              // Fingers.
              rect(7.0, 6.0, 2.2, 5.0, 1.1, skin2, edge2, 1.0);
              rect(9.4, 5.6, 2.2, 5.4, 1.1, skin2, edge2, 1.0);
              rect(11.8, 5.8, 2.2, 5.2, 1.1, skin2, edge2, 1.0);
              rect(14.2, 6.4, 2.2, 4.6, 1.1, skin2, edge2, 1.0);
            } else if (icon === "penalty") {
              // Penalty: yellow striped box (transparent background).
              rect(6.3, 6.6, 11.4, 14.2, 2.2, "#fbbf24", "rgba(0,0,0,0.55)", 1.2);
              path("M8.2 9.0l7.6 0", "none", "rgba(0,0,0,0.35)", 2.2, "round", "round");
              path("M8.2 12.0l7.6 0", "none", "rgba(0,0,0,0.35)", 2.2, "round", "round");
              path("M8.2 15.0l7.6 0", "none", "rgba(0,0,0,0.35)", 2.2, "round", "round");
            } else if (icon === "controlled_entry") {
              // Arrow into a "zone" bracket.
              rect(15.5, 7, 4.5, 10, 2, "rgba(0,0,0,0.0)", "#29c7a9", 2.2);
              path("M4.5 12h10", "none", "#29c7a9", 3, "round", "round");
              path("M11.5 8.5l4 3.5-4 3.5", "none", "#29c7a9", 3, "round", "round");
            } else if (icon === "controlled_exit") {
              // Arrow out of a "zone" bracket.
              rect(4, 7, 4.5, 10, 2, "rgba(0,0,0,0.0)", "#43b3ff", 2.2);
              path("M9.5 12h10", "none", "#43b3ff", 3, "round", "round");
              path("M16.5 8.5l4 3.5-4 3.5", "none", "#43b3ff", 3, "round", "round");
            } else if (icon === "completed_pass") {
              // Completed pass: bold yellow "C".
              text(12, 12, "C", "#fbbf24", 14, 900);
            } else if (icon === "on_ice") {
              // Shift: on-ice marker (green up triangle).
              path("M12 5l7 10H5z", "#22c55e", "rgba(0,0,0,0.40)", 1.1, "round", "round");
            } else if (icon === "off_ice") {
              // Shift: off-ice marker (red down triangle).
              path("M5 9h14L12 19z", "#ef4444", "rgba(0,0,0,0.40)", 1.1, "round", "round");
            } else if (icon === "odd_man_rush") {
              // 3 arrows rushing vs 2 defenders (dots): "3-on-2".
              path("M4 9h7", "none", "#f59e0b", 2.8, "round", "round");
              path("M9.3 6.8l3 2.2-3 2.2", "none", "#f59e0b", 2.8, "round", "round");
              path("M4 12h7", "none", "#f59e0b", 2.8, "round", "round");
              path("M9.3 9.8l3 2.2-3 2.2", "none", "#f59e0b", 2.8, "round", "round");
              path("M4 15h7", "none", "#f59e0b", 2.8, "round", "round");
              path("M9.3 12.8l3 2.2-3 2.2", "none", "#f59e0b", 2.8, "round", "round");
              circle(17.2, 11.2, 2.0, "#111827", "rgba(255,255,255,0.25)", 1);
              circle(19.2, 13.6, 2.0, "#111827", "rgba(255,255,255,0.25)", 1);
            } else if (icon === "turnover_forced") {
              // Turnover: frying pan flipping a pancake (transparent background).
              // Pan body (skillet)
              path("M6.2 15.5c0-2.2 3.0-3.9 6.7-3.9s6.7 1.7 6.7 3.9-3.0 3.9-6.7 3.9-6.7-1.7-6.7-3.9z", "#374151", "rgba(0,0,0,0.55)", 1.1, "round", "round");
              path("M7.6 15.3c0-1.4 2.3-2.5 5.3-2.5s5.3 1.1 5.3 2.5-2.3 2.5-5.3 2.5-5.3-1.1-5.3-2.5z", "rgba(255,255,255,0.08)", "none", 0, "round", "round");
              // Handle
              path("M18.3 14.9h4.6", "none", "#4b5563", 3.2, "round", "round");
              path("M18.3 14.9h4.6", "none", "rgba(0,0,0,0.45)", 1.0, "round", "round");
              // Pancake arc + pancake
              path("M8.0 10.2c1.8-2.6 4.2-3.9 6.6-3.9 2.0 0 3.8.8 5.3 2.4", "none", "rgba(255,255,255,0.55)", 1.7, "round", "round");
              circle(11.2, 7.7, 2.8, "#fbbf24", "rgba(0,0,0,0.45)", 1.0);
              circle(11.2, 7.7, 1.6, "rgba(255,255,255,0.25)", "none", 0);
            } else if (icon === "turnover_created") {
              // Created turnover: purple "spark" + swirl (no background circle).
              path("M8.0 14.5c.8 2 2.7 3.3 4.9 3.3 3.0 0 5.5-2.5 5.5-5.5 0-2.4-1.4-4.5-3.4-5.3", "none", "#7c4dff", 2.6, "round", "round");
              path("M17.9 11.3l.6 3.0-3 .4", "none", "#7c4dff", 2.6, "round", "round");
              path(
                "M10.4 6.2l1.0 2.6 2.8.2-2.3 1.6.8 2.7-2.3-1.6-2.3 1.6.8-2.7-2.3-1.6 2.8-.2z",
                "#7c4dff",
                "rgba(0,0,0,0.35)",
                1.0
              );
            } else if (icon === "giveaway") {
              // Gift/present (transparent background).
              rect(6.3, 11.0, 11.4, 9.6, 1.6, "#ff4d7a", "rgba(0,0,0,0.55)", 1.2);
              rect(6.0, 9.3, 12.0, 2.6, 1.2, "#ff6b93", "rgba(0,0,0,0.55)", 1.2);
              // Ribbon
              rect(11.0, 9.3, 2.0, 11.3, 1.0, "#f7c6a5", "rgba(0,0,0,0.45)", 1.0);
              rect(6.0, 13.1, 12.0, 1.7, 0.8, "#f7c6a5", "rgba(0,0,0,0.0)", 0);
              // Bow: two loops + center knot.
              rect(11.0, 6.4, 2.0, 2.2, 0.8, "#f7c6a5", "rgba(0,0,0,0.45)", 1.0);
              path("M12 8.2c-2.6-3.0-6.2-2.7-6.7-1.0-.6 1.8 2.3 3.2 6.7 3.7", "none", "rgba(0,0,0,0.55)", 1.2, "round", "round");
              path("M12 8.2c2.6-3.0 6.2-2.7 6.7-1.0.6 1.8-2.3 3.2-6.7 3.7", "none", "rgba(0,0,0,0.55)", 1.2, "round", "round");
              path("M12 8.2c-1.8 0-3.6-.3-5.0-1.0", "none", "#f7c6a5", 2.2, "round", "round");
              path("M12 8.2c1.8 0 3.6-.3 5.0-1.0", "none", "#f7c6a5", 2.2, "round", "round");
            } else if (icon === "takeaway") {
              // Takeaway: simple revolver pictogram (non-violent, no muzzle flash).
              var gunFill = "rgba(230,232,236,0.92)";
              var gunEdge = "rgba(0,0,0,0.42)";
              // Frame/body.
              rect(5.8, 9.4, 7.4, 4.6, 1.6, gunFill, gunEdge, 1.0);
              // Cylinder.
              circle(14.1, 11.7, 2.3, gunFill, gunEdge, 1.0);
              circle(14.1, 11.7, 0.7, "rgba(255,255,255,0.35)", "none", 0);
              // Barrel + muzzle.
              rect(15.9, 10.5, 6.1, 2.4, 1.2, gunFill, gunEdge, 1.0);
              rect(21.6, 10.9, 1.3, 1.6, 0.7, gunFill, gunEdge, 1.0);
              // Hammer.
              rect(8.1, 7.8, 3.2, 1.6, 0.8, gunFill, gunEdge, 1.0);
              // Grip.
              path("M7.2 14.0h4.7v7.1c0 .7-.6 1.3-1.3 1.3H8.5c-.7 0-1.3-.6-1.3-1.3z", gunFill, gunEdge, 1.0, "round", "round");
              // Trigger guard + trigger (subtle outline).
              path("M12.7 14.1c1.6.1 2.6 1.3 2.6 2.7 0 1.7-1.4 3.1-3.1 3.1h-1.0", "none", gunEdge, 1.0, "round", "round");
              path("M13.0 15.8c-.4.5-.4 1.2 0 1.6", "none", gunEdge, 1.0, "round", "round");
            } else {
              rect(5.5, 5.5, 13, 13, 3, "rgba(0,0,0,0.0)", "rgba(255,255,255,0.35)", 1.2);
              var t = String(opts.label || "?").trim();
              text(12, 12.2, t ? t.slice(0, 1).toUpperCase() : "?", "#ffffff", 12, 900);
            }
            return g;
          }

          // Reuse these icon helpers in other scripts on this page (e.g., Player Events headings).
          try {
            window.HM_EVENT_ICONS = window.HM_EVENT_ICONS || {};
            window.HM_EVENT_ICONS.typeKey = typeKey;
            window.HM_EVENT_ICONS.iconGroup = iconGroup;
            window.HM_EVENT_ICONS.normalizeTypeLabel = normalizeTypeLabel;
          } catch (e) {}

          function clearSvg(el) {
            while (el.firstChild) el.removeChild(el.firstChild);
          }

          function render() {
            clearSvg(svg);
            while (legendEl.firstChild) legendEl.removeChild(legendEl.firstChild);

            var parsed = [];
            var spans = [];
            var penaltyStarts = [];
            var penaltyEnds = [];

            function extractPenaltyJersey(row) {
              var j = String(
                getValue(row, ["Attributed Jerseys", "AttributedJerseys", "Jersey #", "Jersey", "Jersey No", "JerseyNo", "Jersey Number"]) || ""
              ).trim();
              if (j && j.match(/^\d+$/)) return j;
              var det = String(getValue(row, ["Details", "Detail"]) || "").trim();
              var m = det.match(/#\s*(\d+)/);
              if (m) return m[1];
              return "";
            }

            function parseEndWithinFromRow(row) {
              var endRaw = String(getValue(row, ["Game Seconds End", "GameSecondsEnd", "End Game Seconds", "EndGameSeconds"]) || "").trim();
              var endWithin = null;
              if (endRaw && endRaw.match(/^-?\d+$/)) {
                endWithin = parseInt(endRaw, 10);
              } else {
                endWithin = parseTimeToSecondsLoose(getValue(row, ["Game Time End", "GameTimeEnd", "End Time", "EndTime"]));
              }
              if (endWithin !== null && isFinite(endWithin) && endWithin > 1500) {
                var endAlt = parseTimeToSecondsLoose(getValue(row, ["Game Time End", "GameTimeEnd", "End Time", "EndTime"]));
                if (endAlt !== null && isFinite(endAlt)) endWithin = endAlt;
                if (endWithin !== null && isFinite(endWithin) && endWithin > 1500) return null;
              }
              return endWithin !== null && isFinite(endWithin) ? endWithin : null;
            }

              for (var i = 0; i < eventsRows.length; i++) {
                var r = eventsRows[i] || {};
                r.__rowIndex = i;
                var period = parsePeriod(getValue(r, ["Period"]));
                if (period === null) continue;

              var gs = String(getValue(r, ["Game Seconds", "GameSeconds"]) || "").trim();
              var tWithin = null;
              if (gs && gs.match(/^-?\d+$/)) {
                tWithin = parseInt(gs, 10);
              } else {
                tWithin = parseTimeToSecondsLoose(getValue(r, ["Game Time", "GameTime", "Time"]));
              }
              if (tWithin !== null && isFinite(tWithin) && tWithin > 1500) {
                var tAlt = parseTimeToSecondsLoose(getValue(r, ["Game Time", "GameTime", "Time"]));
                if (tAlt !== null && isFinite(tAlt)) tWithin = tAlt;
                if (tWithin !== null && isFinite(tWithin) && tWithin > 1500) continue;
              }
              if (tWithin === null || !isFinite(tWithin)) continue;
              if (tWithin < 0) tWithin = 0;

              var label = normalizeTypeLabel(getValue(r, ["Event Type", "EventType", "Event", "Type"]));
              if (!label) continue;
              if (String(label).trim().toLowerCase() === "assist") continue;

              var side = parseSide(r);
              var ik = typeKey(label);
              if (ik === "on_ice" || ik === "off_ice") continue; // never show shift markers on this timeline
              var ll = String(label).trim().toLowerCase();
              if (ll === "penalty expired") {
                penaltyEnds.push({
                  period: period,
                  tWithin: tWithin,
                  side: side,
                  jersey: extractPenaltyJersey(r),
                  row: r,
                });
                continue; // don't draw an icon for expiry markers
              }
              if (ll === "penalty") {
                penaltyStarts.push({
                  period: period,
                  tWithin: tWithin,
                  side: side,
                  jersey: extractPenaltyJersey(r),
                  endWithin: parseEndWithinFromRow(r),
                  row: r,
                });
              }
              parsed.push({
                period: period,
                tWithin: tWithin,
                typeLabel: label,
                iconKey: ik,
                laneKey: laneKey(ik),
                side: side,
                row: r,
              });
            }
            if (parsed.length === 0 && spans.length === 0) return;

            // Suppress Shot/SOG/xG/Goal duplicates at the same instant and side (show best icon).
            var bestFinishByKey = {};
            for (var j = 0; j < parsed.length; j++) {
              var ev = parsed[j];
              if (!isFinishFamily(ev.iconKey)) continue;
              var k = ev.period + "|" + ev.tWithin + "|" + ev.side;
              var cur = bestFinishByKey[k];
              if (!cur || finishPriority(ev.iconKey) > finishPriority(cur)) bestFinishByKey[k] = ev.iconKey;
            }
            var filtered = [];
            for (var k2 = 0; k2 < parsed.length; k2++) {
              var ev2 = parsed[k2];
              if (isFinishFamily(ev2.iconKey)) {
                var sk = ev2.period + "|" + ev2.tWithin + "|" + ev2.side;
                if (bestFinishByKey[sk] && bestFinishByKey[sk] !== ev2.iconKey) continue;
              }
              filtered.push(ev2);
            }
            if (filtered.length === 0) return;

            // Period model: 3 periods by default; OT (period 4) defaults to 5:00 unless events exceed it.
            var maxPeriod = 0;
            var maxTWithinP4 = 0;
            var maxWithinAll = 0;
            var minWithinByPeriod = {};
            var maxWithinByPeriod = {};
            for (var q = 0; q < filtered.length; q++) {
              maxPeriod = Math.max(maxPeriod, filtered[q].period);
              if (filtered[q].period === 4) maxTWithinP4 = Math.max(maxTWithinP4, filtered[q].tWithin);
              if (isFinite(filtered[q].tWithin)) {
                maxWithinAll = Math.max(maxWithinAll, filtered[q].tWithin);
                var pp = filtered[q].period;
                if (minWithinByPeriod[pp] === undefined || filtered[q].tWithin < minWithinByPeriod[pp]) minWithinByPeriod[pp] = filtered[q].tWithin;
                if (maxWithinByPeriod[pp] === undefined || filtered[q].tWithin > maxWithinByPeriod[pp]) maxWithinByPeriod[pp] = filtered[q].tWithin;
              }
            }
            maxPeriod = Math.max(3, maxPeriod);
            // Heuristic: treat times as absolute game seconds only when periods look like
            // disjoint, increasing time ranges (avoids a single bad row collapsing all periods).
            var looksAbsolute = (function () {
              if (maxPeriod <= 1) return false;
              var comparisons = 0;
              var jumps = 0;
              for (var pAbs = 2; pAbs <= maxPeriod; pAbs++) {
                if (minWithinByPeriod[pAbs] === undefined) continue;
                if (maxWithinByPeriod[pAbs - 1] === undefined) continue;
                comparisons++;
                if (minWithinByPeriod[pAbs] > (maxWithinByPeriod[pAbs - 1] + 60)) jumps++;
              }
              if (comparisons > 0) {
                return jumps >= Math.max(1, Math.ceil(comparisons * 0.6));
              }
              return maxWithinAll > 3600;
            })();
            function roundUp(n, step) {
              if (!isFinite(n) || n <= 0) return 0;
              return Math.ceil(n / step) * step;
            }

            var durations = [];
            if (looksAbsolute) {
              for (var p = 1; p <= maxPeriod; p++) {
                var lo = minWithinByPeriod[p];
                var hi = maxWithinByPeriod[p];
                var raw = isFinite(lo) && isFinite(hi) && hi > lo ? (hi - lo) : 0;
                var dAbs = roundUp(raw, 60);
                if (!dAbs || dAbs < 300) dAbs = 1200;
                if (p === 4 && dAbs > 900) dAbs = 300;
                durations.push(dAbs);
              }
            } else {
              var typicalRaw = 0;
              for (var pT = 1; pT <= Math.min(3, maxPeriod); pT++) {
                typicalRaw = Math.max(typicalRaw, maxWithinByPeriod[pT] || 0);
              }
              var typical = roundUp(typicalRaw, 60);
              if (!typical || typical < 600 || typical > 1500) typical = 1200;
              for (var p = 1; p <= maxPeriod; p++) {
                if (p === 4) {
                  var otRaw = maxWithinByPeriod[p] || 0;
                  var ot = roundUp(Math.max(otRaw, 300), 60);
                  if (!ot || ot < 300) ot = 300;
                  if (ot > typical) ot = Math.min(typical, 1200);
                  durations.push(ot);
                } else {
                  durations.push(typical);
                }
              }
            }
            var offsets = [0];
            for (var p2 = 0; p2 < durations.length; p2++) offsets.push(offsets[p2] + durations[p2]);
            var totalDuration = offsets[offsets.length - 1] || 1;

            // Hockey game clocks typically count DOWN within each period ("remaining" time).
            // Use that convention for timeline placement so events flow left-to-right in game order
            // (i.e., decreasing Game Time from left to right).
            //
            // Note: earlier heuristics attempted to infer elapsed-vs-remaining per period, but that
            // can flip in periods that only have late events, which makes a period appear reversed.
            var timeModeByPeriod = {};
            if (!looksAbsolute) {
              for (var pInf = 1; pInf <= maxPeriod; pInf++) {
                timeModeByPeriod[pInf] = "remaining";
              }
            }

            // Infer PP/PK spans from penalty windows: only when penalty counts differ (4v4 etc -> no span).
            spans = [];
              (function inferSpansFromPenalties() {
                if (!penaltyStarts.length) return;

                var penaltyWindowsByPS = {};
                var goalsByPeriod = {};

                function keyPS(p, s) { return String(p) + "|" + String(s); }

                for (var g0 = 0; g0 < filtered.length; g0++) {
                  var evg = filtered[g0];
                  if (!evg || evg.iconKey !== "goal") continue;
                  var p0 = evg.period;
                  var el = withinToElapsed(p0, evg.tWithin);
                  if (!isFinite(el)) continue;
                  if (!goalsByPeriod[p0]) goalsByPeriod[p0] = [];
                  goalsByPeriod[p0].push({ elapsed: el, side: evg.side });
                }
                for (var gp in goalsByPeriod) {
                  if (!Object.prototype.hasOwnProperty.call(goalsByPeriod, gp)) continue;
                  goalsByPeriod[gp].sort(function (a, b) { return a.elapsed - b.elapsed; });
                }

                function parsePenaltyMinutes(row) {
                  var det = String(getValue(row, ["Details", "Detail"]) || "").trim();
                  var m = det.match(/\b(\d+)\s*m\b/i);
                  if (m) {
                    var v = parseInt(m[1], 10);
                    return isFinite(v) ? v : null;
                  }
                  return null;
                }

                function parsePenaltyInfraction(row) {
                  var det = String(getValue(row, ["Details", "Detail"]) || "").trim();
                  if (!det) return "";
                  det = det.replace(/^Expired\b\s*/i, "");
                  det = det.replace(/#\s*\d+\s*/g, "");
                  det = det.replace(/\b\d+\s*m\b/gi, "");
                  det = det.replace(/\(\s*end\s+[^\)]+\)/gi, "");
                  det = det.replace(/\s+/g, " ").trim();
                  return det;
                }

                function findGoalNear(period, otherSide, elapsed, tolS) {
                  tolS = tolS || 2.0;
                  var arr = goalsByPeriod[period] || [];
                  for (var i = 0; i < arr.length; i++) {
                    var g = arr[i];
                    if (g.side !== otherSide) continue;
                    if (Math.abs(g.elapsed - elapsed) <= tolS) return true;
                  }
                  return false;
                }

                function firstGoalBetween(period, otherSide, aEl, bEl) {
                  var arr = goalsByPeriod[period] || [];
                  for (var i = 0; i < arr.length; i++) {
                    var g = arr[i];
                    if (g.side !== otherSide) continue;
                    if (g.elapsed >= aEl - 0.5 && g.elapsed <= bEl + 0.5) return g.elapsed;
                  }
                  return null;
                }

                var allPenaltyWindowsBuilt = false;
                function buildAllPenaltyWindows() {
                  if (allPenaltyWindowsBuilt) return;
                  allPenaltyWindowsBuilt = true;

                  // Init empty lists for each period+side so callers can always rely on an array.
                  for (var pInit = 1; pInit <= maxPeriod; pInit++) {
                    penaltyWindowsByPS[keyPS(pInit, "Home")] = [];
                    penaltyWindowsByPS[keyPS(pInit, "Away")] = [];
                  }

                  // Flatten goals to absolute game seconds so we can end penalties by goal even
                  // when they carry over to the next period.
                  var goalsAbs = [];
                  for (var pG = 1; pG <= maxPeriod; pG++) {
                    var arr = goalsByPeriod[pG] || [];
                    for (var gi = 0; gi < arr.length; gi++) {
                      var g = arr[gi];
                      goalsAbs.push({ abs: (offsets[pG - 1] || 0) + (g.elapsed || 0), side: g.side });
                    }
                  }
                  goalsAbs.sort(function (a, b) { return a.abs - b.abs; });

                  function findGoalNearAbs(otherSide, abs, tolS) {
                    tolS = tolS || 2.0;
                    for (var i = 0; i < goalsAbs.length; i++) {
                      var g = goalsAbs[i];
                      if (g.side !== otherSide) continue;
                      if (Math.abs(g.abs - abs) <= tolS) return true;
                    }
                    return false;
                  }

                  function firstGoalBetweenAbs(otherSide, aAbs, bAbs) {
                    for (var i = 0; i < goalsAbs.length; i++) {
                      var g = goalsAbs[i];
                      if (g.side !== otherSide) continue;
                      if (g.abs >= aAbs - 0.5 && g.abs <= bAbs + 0.5) return g.abs;
                    }
                    return null;
                  }

                  var gameEndAbs = offsets[maxPeriod] || totalDuration;

                  for (var s0 = 0; s0 < penaltyStarts.length; s0++) {
                    var st = penaltyStarts[s0];
                    var pRow = st.row || {};
                    var minutes = parsePenaltyMinutes(pRow);
                    if (minutes === null || !isFinite(minutes)) continue;

                    var startAbs = (offsets[st.period - 1] || 0) + withinToElapsed(st.period, st.tWithin);
                    if (!isFinite(startAbs)) continue;
                    if (startAbs < 0) startAbs = 0;

                    var scheduledEndAbs = startAbs + minutes * 60;
                    var endAbs = Math.min(gameEndAbs, scheduledEndAbs);
                    var reason = "";
                    var affectsManpower = minutes === 2;

                    // Minor penalties end early on a goal by the other team (modelled approximately).
                    if (affectsManpower) {
                      var otherSide = st.side === "Home" ? "Away" : "Home";
                      var gEndAbs = firstGoalBetweenAbs(otherSide, startAbs, endAbs);
                      if (gEndAbs !== null && isFinite(gEndAbs) && gEndAbs < endAbs - 0.1) endAbs = Math.max(startAbs, gEndAbs);
                      if (Math.abs(endAbs - scheduledEndAbs) <= 2) {
                        reason = "Timed out";
                      } else if (findGoalNearAbs(otherSide, endAbs, 2.0)) {
                        reason = "Ended by goal";
                      } else if (endAbs >= gameEndAbs - 1) {
                        reason = "End of game";
                      } else if (endAbs < scheduledEndAbs - 2) {
                        reason = "Ended early";
                      }
                    } else if (endAbs >= gameEndAbs - 1) {
                      reason = "End of game";
                    } else if (Math.abs(endAbs - scheduledEndAbs) <= 2) {
                      reason = "Timed out";
                    }

                    if (!isFinite(endAbs) || endAbs <= startAbs + 0.1) continue;

                    var infraction = parsePenaltyInfraction(pRow);
                    var player = String(getValue(pRow, ["Attributed Players", "Player", "Name"]) || "").trim();
                    var jersey = String(st.jersey || extractPenaltyJersey(pRow) || "").trim();

                    // Split across periods so PP/PK spans visually carry over.
                    for (var p = st.period; p <= maxPeriod; p++) {
                      var pStartAbs = offsets[p - 1] || 0;
                      var pEndAbs = offsets[p] || (pStartAbs + (durations[p - 1] || 1200));
                      if (endAbs <= pStartAbs + 1e-6) break;

                      var segStartAbs = Math.max(startAbs, pStartAbs);
                      var segEndAbs = Math.min(endAbs, pEndAbs);
                      if (segEndAbs <= segStartAbs + 1e-6) continue;

                      var lo = segStartAbs - pStartAbs;
                      var hi = segEndAbs - pStartAbs;
                      if (hi <= lo + 1e-6) continue;

                      var startWithin = elapsedToWithin(p, lo);
                      var endWithin = elapsedToWithin(p, hi);
                      var segReason = segEndAbs < endAbs - 0.5 ? "Carryover" : reason;

                      var startLabel = secondsToLabel(startWithin);
                      var endLabel = secondsToLabel(endWithin);
                      var lineParts = [];
                      if (jersey) lineParts.push("#" + jersey);
                      if (player) lineParts.push(player);
                      if (infraction) lineParts.push("— " + infraction);
                      lineParts.push("(" + minutes + "m)");
                      lineParts.push(startLabel + "–" + endLabel);
                      lineParts.push("dur " + secondsToLabel(Math.max(0, hi - lo)));
                      if (segReason) lineParts.push("[" + segReason + "]");

                      penaltyWindowsByPS[keyPS(p, st.side)].push({
                        period: p,
                        side: st.side,
                        lo: lo,
                        hi: hi,
                        startWithin: startWithin,
                        endWithin: endWithin,
                        affectsManpower: affectsManpower,
                        row: pRow,
                        endRow: null,
                        line: lineParts.join(" "),
                      });
                    }
                  }

                  for (var pSort = 1; pSort <= maxPeriod; pSort++) {
                    ["Home", "Away"].forEach(function (s) {
                      var k = keyPS(pSort, s);
                      var wins = penaltyWindowsByPS[k] || [];
                      wins.sort(function (a, b) { return a.lo - b.lo; });
                    });
                  }
                }

                function buildPenaltyWindows(period, side) {
                  buildAllPenaltyWindows();
                  var k = keyPS(period, side);
                  return penaltyWindowsByPS[k] || [];
                }

                function buildIntervals(period, side) {
                  var wins = buildPenaltyWindows(period, side);
                  var ints = [];
                  for (var i = 0; i < wins.length; i++) {
                    if (!wins[i].affectsManpower) continue;
                    ints.push([wins[i].lo, wins[i].hi]);
                  }
                  return ints;
                }

                function penaltiesTextForSpan(period, penalizedSide, aEl, bEl) {
                  var wins = buildPenaltyWindows(period, penalizedSide) || [];
                  var lines = [];
                  for (var i = 0; i < wins.length; i++) {
                    var w = wins[i];
                    if (!w.affectsManpower) continue;
                    if (w.lo < bEl && w.hi > aEl) lines.push(w.line);
                  }
                  return lines.join("\\n");
                }

                function countActive(ints, t) {
                  var c = 0;
                for (var i = 0; i < ints.length; i++) {
                  if (ints[i][0] <= t && t < ints[i][1]) c++;
                }
                return c;
              }

              for (var p = 1; p <= maxPeriod; p++) {
                if (looksAbsolute) continue; // spans only supported in within-period mode
                var d = durations[p - 1] || 1200;
                var forInts = buildIntervals(p, "Home");
                var againstInts = buildIntervals(p, "Away");
                if (!forInts.length && !againstInts.length) continue;

                var boundsObj = { 0: true };
                boundsObj[String(d)] = true;
                for (var ii = 0; ii < forInts.length; ii++) { boundsObj[String(forInts[ii][0])] = true; boundsObj[String(forInts[ii][1])] = true; }
                for (var jj = 0; jj < againstInts.length; jj++) { boundsObj[String(againstInts[jj][0])] = true; boundsObj[String(againstInts[jj][1])] = true; }
                var bounds = Object.keys(boundsObj).map(function (x) { return parseFloat(x); });
                bounds.sort(function (a, b) { return a - b; });
                if (bounds.length < 2) continue;

                for (var bi = 0; bi < bounds.length - 1; bi++) {
                  var a0 = bounds[bi];
                  var b0 = bounds[bi + 1];
                  if (b0 <= a0) continue;
                  var mid = (a0 + b0) / 2.0;
                  var forPen = countActive(forInts, mid);
                  var againstPen = countActive(againstInts, mid);
                  if (forPen === againstPen) continue;
                    var forSk = Math.max(3, 5 - forPen);
                    var againstSk = Math.max(3, 5 - againstPen);
                    var penalizedSide = forPen < againstPen ? "Away" : "Home";
                    var penaltiesText = penaltiesTextForSpan(p, penalizedSide, a0, b0);
                    if (forPen < againstPen) {
                      spans.push({
                        period: p,
                        startWithin: elapsedToWithin(p, a0),
                        endWithin: elapsedToWithin(p, b0),
                        typeLabel: "Power Play",
                        iconKey: "pp",
                        laneKey: "special_teams",
                        side: "Home",
                        row: { Details: forSk + "v" + againstSk },
                        penaltiesText: penaltiesText,
                      });
                      spans.push({
                        period: p,
                        startWithin: elapsedToWithin(p, a0),
                        endWithin: elapsedToWithin(p, b0),
                        typeLabel: "Penalty Kill",
                        iconKey: "pk",
                        laneKey: "special_teams",
                        side: "Away",
                        row: { Details: againstSk + "v" + forSk },
                        penaltiesText: penaltiesText,
                      });
                    } else {
                      spans.push({
                        period: p,
                        startWithin: elapsedToWithin(p, a0),
                        endWithin: elapsedToWithin(p, b0),
                        typeLabel: "Power Play",
                        iconKey: "pp",
                        laneKey: "special_teams",
                        side: "Away",
                        row: { Details: againstSk + "v" + forSk },
                        penaltiesText: penaltiesText,
                      });
                      spans.push({
                        period: p,
                        startWithin: elapsedToWithin(p, a0),
                        endWithin: elapsedToWithin(p, b0),
                        typeLabel: "Penalty Kill",
                        iconKey: "pk",
                        laneKey: "special_teams",
                        side: "Home",
                        row: { Details: forSk + "v" + againstSk },
                        penaltiesText: penaltiesText,
                      });
                    }
                  }
                }
            })();

            // Determine type ordering and side-specific row maps.
            var laneOrder = [
              "special_teams",
              "finish",
              "transition",
              "completed_pass",
              "shift",
              "odd_man_rush",
              "takeaway",
              "giveaway",
              "turnover_created",
              "turnover_forced",
              "other",
            ];
            var iconOrder = [
              "goal",
              "penalty",
              "xg",
              "sog",
              "shot",
              "controlled_entry",
              "controlled_exit",
              "completed_pass",
              "on_ice",
              "off_ice",
              "odd_man_rush",
              "takeaway",
              "giveaway",
              "turnover_created",
              "turnover_forced",
              "other",
            ];
            var byIconKey = {};
            for (var s0 = 0; s0 < filtered.length; s0++) {
              var e0 = filtered[s0];
              if (!byIconKey[e0.iconKey]) byIconKey[e0.iconKey] = { label: e0.typeLabel, iconKey: e0.iconKey };
            }
            var presentKeys = Object.keys(byIconKey);
            presentKeys.sort(function (a, b) {
              var ai = iconOrder.indexOf(a);
              var bi = iconOrder.indexOf(b);
              if (ai === -1) ai = 999;
              if (bi === -1) bi = 999;
              if (ai !== bi) return ai - bi;
              var al = (byIconKey[a].label || a).toLowerCase();
              var bl = (byIconKey[b].label || b).toLowerCase();
              if (al < bl) return -1;
              if (al > bl) return 1;
              return 0;
            });

            var typesFor = [];
            var typesAgainst = [];
            var seenFor = {};
            var seenAgainst = {};
            for (var t0 = 0; t0 < filtered.length; t0++) {
              var e1 = filtered[t0];
              if (e1.side === "Home" && !seenFor[e1.laneKey]) {
                seenFor[e1.laneKey] = true;
              }
              if (e1.side === "Away" && !seenAgainst[e1.laneKey]) {
                seenAgainst[e1.laneKey] = true;
              }
            }
            for (var t1 = 0; t1 < spans.length; t1++) {
              var s1 = spans[t1];
              if (s1.side === "Home" && !seenFor[s1.laneKey]) {
                seenFor[s1.laneKey] = true;
              }
              if (s1.side === "Away" && !seenAgainst[s1.laneKey]) {
                seenAgainst[s1.laneKey] = true;
              }
            }
            for (var u = 0; u < laneOrder.length; u++) {
              var kk = laneOrder[u];
              if (seenFor[kk]) typesFor.push(kk);
              if (seenAgainst[kk]) typesAgainst.push(kk);
            }
            var yIndexFor = {};
            for (var yf = 0; yf < typesFor.length; yf++) yIndexFor[typesFor[yf]] = yf;
            var yIndexAgainst = {};
            for (var ya = 0; ya < typesAgainst.length; ya++) yIndexAgainst[typesAgainst[ya]] = ya;

            var isMobile = window.matchMedia && window.matchMedia("(max-width: 720px)").matches;
            var iconSize = isMobile ? 28 : 24;

            // Legend (top-right).
            for (var li = 0; li < presentKeys.length; li++) {
              var lk = presentKeys[li];
              var item = document.createElement("div");
              item.className = "events-timeline-legend-item";
              var iconSvg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
              iconSvg.setAttribute("viewBox", "0 0 24 24");
              iconSvg.setAttribute("aria-hidden", "true");
              iconSvg.style.width = iconSize + "px";
              iconSvg.style.height = iconSize + "px";
              var iconWrap = document.createElementNS("http://www.w3.org/2000/svg", "g");
              iconWrap.setAttribute("transform", "translate(12,12)");
              iconWrap.appendChild(iconGroup(lk, { size: 24, label: (byIconKey[lk].label || "?").slice(0, 1) }));
              iconSvg.appendChild(iconWrap);
              var labelSpan = document.createElement("span");
              labelSpan.appendChild(document.createTextNode(byIconKey[lk].label || lk));
              item.appendChild(iconSvg);
              item.appendChild(labelSpan);
              legendEl.appendChild(item);
            }

            // Add legend markers for PP/PK spans when present.
            var hasPP = false;
            var hasPK = false;
            for (var si = 0; si < spans.length; si++) {
              if (spans[si].iconKey === "pp") hasPP = true;
              if (spans[si].iconKey === "pk") hasPK = true;
            }
            function addSpanLegend(label, color) {
              var item = document.createElement("div");
              item.className = "events-timeline-legend-item";
              var iconSvg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
              iconSvg.setAttribute("viewBox", "0 0 24 24");
              iconSvg.setAttribute("aria-hidden", "true");
              iconSvg.style.width = iconSize + "px";
              iconSvg.style.height = iconSize + "px";
              iconSvg.appendChild(svgEl("line", { x1: 2, y1: 12, x2: 22, y2: 12, stroke: color, "stroke-width": 5, "stroke-linecap": "round" }));
              var labelSpan = document.createElement("span");
              labelSpan.appendChild(document.createTextNode(label));
              item.appendChild(iconSvg);
              item.appendChild(labelSpan);
              legendEl.appendChild(item);
            }
            if (hasPP) addSpanLegend("Power Play", "#22c55e");
            if (hasPK) addSpanLegend("Penalty Kill", "#ef4444");

            // Layout
            var minW = isMobile ? 840 : 900;
            var containerW = svg.parentElement ? svg.parentElement.clientWidth : 0;
            var W = Math.max(minW, containerW || minW);
            var leftPad = 16;
            var rightPad = 16;
            var topPad = 10 + 18;
            var bottomPad = 14 + 18;
            var axisGap = isMobile ? 12 : 10;
            var rowSpacing = iconSize + (isMobile ? 14 : 12);
            var axisY = topPad + typesFor.length * rowSpacing + axisGap;
            var H = axisY + axisGap + typesAgainst.length * rowSpacing + bottomPad;
            if (H < 90) H = 90;

            svg.setAttribute("viewBox", "0 0 " + W + " " + H);
            svg.style.width = W + "px";
            svg.style.height = H + "px";
            svg.setAttribute("width", String(W));
            svg.setAttribute("height", String(H));
            svg.setAttribute("preserveAspectRatio", "xMinYMin meet");

            var innerW = W - leftPad - rightPad;
            function withinToElapsed(period, tWithin) {
              var d = durations[period - 1] || 1200;
              var mode = timeModeByPeriod[period] || "elapsed";
              var elapsed = mode === "remaining" ? d - tWithin : tWithin;
              if (!isFinite(elapsed)) elapsed = 0;
              if (elapsed < 0) elapsed = 0;
              if (elapsed > d) elapsed = d;
              return elapsed;
            }
            function elapsedToWithin(period, elapsed) {
              var d = durations[period - 1] || 1200;
              var mode = timeModeByPeriod[period] || "elapsed";
              var tWithin = mode === "remaining" ? d - elapsed : elapsed;
              if (!isFinite(tWithin)) tWithin = 0;
              if (tWithin < 0) tWithin = 0;
              if (tWithin > d) tWithin = d;
              return tWithin;
            }
            function xForTime(period, tWithin) {
              var t = looksAbsolute ? tWithin : (offsets[period - 1] || 0) + withinToElapsed(period, tWithin);
              if (t < 0) t = 0;
              if (t > totalDuration) t = totalDuration;
              return leftPad + (t / totalDuration) * innerW;
            }

            // Background
            svg.appendChild(
              svgEl("rect", {
                x: 0,
                y: 0,
                width: W,
                height: H,
                fill: "rgba(0,0,0,0.12)",
                rx: 10,
              })
            );

            // Axis
            svg.appendChild(
              svgEl("line", {
                x1: leftPad,
                y1: axisY,
                x2: W - rightPad,
                y2: axisY,
                stroke: "rgba(255,255,255,0.35)",
                "stroke-width": 2,
              })
            );

            // Home/Away labels (outside the row regions so they never overlap icons)
            if (typesFor.length > 0) {
              var forText = svgEl("text", {
                x: leftPad,
                y: topPad - 6,
                fill: "rgba(255,255,255,0.75)",
                "font-size": 12,
                "font-weight": 800,
                "text-anchor": "start",
                "font-family": "Inter, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial",
              });
              forText.appendChild(document.createTextNode("Home — " + (homeTeamName || "Home")));
              svg.appendChild(forText);
            }
            if (typesAgainst.length > 0) {
              var againstText = svgEl("text", {
                x: leftPad,
                y: H - bottomPad + 14,
                fill: "rgba(255,255,255,0.75)",
                "font-size": 12,
                "font-weight": 800,
                "text-anchor": "start",
                "font-family": "Inter, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial",
              });
              againstText.appendChild(document.createTextNode("Away — " + (awayTeamName || "Away")));
              svg.appendChild(againstText);
            }

            // Period ticks + labels
            for (var p3 = 1; p3 <= maxPeriod; p3++) {
              var xStart = leftPad + ((offsets[p3 - 1] || 0) / totalDuration) * innerW;
              var xEnd = leftPad + ((offsets[p3] || 0) / totalDuration) * innerW;
              if (p3 > 1) {
                svg.appendChild(
                  svgEl("line", {
                    x1: xStart,
                    y1: axisY - 9,
                    x2: xStart,
                    y2: axisY + 9,
                    stroke: "rgba(255,255,255,0.35)",
                    "stroke-width": 2,
                  })
                );
              }
              var label = p3 === 4 ? "OT" : "P" + p3;
              var tx = (xStart + xEnd) / 2;
              var tEl = svgEl("text", {
                x: tx,
                y: axisY + 18,
                fill: "rgba(255,255,255,0.65)",
                "font-size": 12,
                "font-weight": 700,
                "text-anchor": "middle",
                "font-family": "Inter, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial",
              });
              tEl.appendChild(document.createTextNode(label));
              svg.appendChild(tEl);
            }

            // Event markers
            function drawPriority(iconKey) {
              if (iconKey === "shot") return 10;
              if (iconKey === "sog") return 20;
              if (iconKey === "xg") return 30;
              if (iconKey === "goal") return 40;
              return 0;
            }
            var drawList = filtered.slice().sort(function (a, b) {
              var ap = drawPriority(a.iconKey);
              var bp = drawPriority(b.iconKey);
              if (ap !== bp) return ap - bp;
              // Stable-ish fallback by time.
              if (a.period !== b.period) return a.period - b.period;
              if (a.tWithin !== b.tWithin) return a.tWithin - b.tWithin;
              return 0;
            });

            // Enable clip-length control when at least one event has a video time.
            var hasAnyVideo = false;
            var isTouchDevice = (function () {
              try {
                if (window.matchMedia && window.matchMedia("(hover: none)").matches) return true;
              } catch (e) {}
              try {
                return ("ontouchstart" in window) || (navigator && navigator.maxTouchPoints && navigator.maxTouchPoints > 0);
              } catch (e) {
                return false;
              }
            })();
            try {
              for (var vi = 0; vi < eventsRows.length; vi++) {
                var vrow = eventsRows[vi] || {};
                var vs = parseVideoSecondsFromRow(vrow);
                if (vs !== null && isFinite(vs)) { hasAnyVideo = true; break; }
              }
            } catch (e) {}
                if (clipControlsEl && clipLenEl && gameVideoUrl && hasAnyVideo) {
                  clipControlsEl.style.display = "flex";
                  try {
                    var sv = null;
                    if (userClipLenS === 15 || userClipLenS === 20 || userClipLenS === 30 || userClipLenS === 45 || userClipLenS === 60 || userClipLenS === 90) {
                      sv = userClipLenS;
                    } else {
                      var saved = localStorage.getItem("hm_clip_len_s");
                      if (saved) {
                        var lv = parseInt(String(saved), 10);
                        if (lv === 15 || lv === 20 || lv === 30 || lv === 45 || lv === 60 || lv === 90) sv = lv;
                      }
                    }
                    if (sv === 15 || sv === 20 || sv === 30 || sv === 45 || sv === 60 || sv === 90) clipLenEl.value = String(sv);
                  } catch (e) {}
                  if (clipLenEl) {
                    clipLenEl.addEventListener("change", function () {
                      var v = 30;
                      try { v = parseInt(String(clipLenEl.value || "30"), 10); } catch (e) { v = 30; }
                      if (v !== 15 && v !== 20 && v !== 30 && v !== 45 && v !== 60 && v !== 90) v = 30;
                      if (!userIsLoggedIn) {
                        try { localStorage.setItem("hm_clip_len_s", String(v)); } catch (e) {}
                        return;
                      }
                  try {
                    fetch("/api/user/video_clip_len", {
                      method: "POST",
                      headers: { "Content-Type": "application/json" },
                      body: JSON.stringify({ clip_len_s: v }),
                      credentials: "same-origin",
                    })
                      .then(function (r) { return r.json().catch(function () { return {}; }); })
                      .then(function (j) { if (j && j.ok) userClipLenS = v; })
                      .catch(function () {});
                  } catch (e) {}
                });
              }
            }

            var wrapEl = svg.parentElement || null;
            var tooltipEl = wrapEl ? wrapEl.querySelector(".events-timeline-tooltip") : null;
            var tooltipHideTimer = null;
            if (wrapEl && !tooltipEl) {
              tooltipEl = document.createElement("div");
              tooltipEl.className = "events-timeline-tooltip";
              tooltipEl.style.display = "none";
              // Append to <body> and use `position: fixed` so the tooltip is never clipped by
              // the timeline scroll container (common on mobile when the timeline is partially off-screen).
              try { document.body.appendChild(tooltipEl); } catch (e) { wrapEl.appendChild(tooltipEl); }
              tooltipEl.dataset.pinned = "0";
              tooltipEl.dataset.hovering = "0";
              tooltipEl.addEventListener("mouseenter", function () {
                tooltipEl.dataset.hovering = "1";
              });
              tooltipEl.addEventListener("mouseleave", function () {
                tooltipEl.dataset.hovering = "0";
                if (tooltipEl.dataset.pinned !== "1") tooltipEl.style.display = "none";
              });
              ["click", "mousedown", "touchstart", "pointerdown"].forEach(function (evt) {
                tooltipEl.addEventListener(evt, function (e) {
                  // Prevent underlying SVG icons from receiving the interaction.
                  e.stopPropagation();
                });
              });
              wrapEl.addEventListener("mouseleave", function () {
                if (!tooltipEl) return;
                if (tooltipEl.dataset.pinned === "1") return;
                scheduleHideTooltip();
              });
              wrapEl.addEventListener("scroll", function () {
                if (!tooltipEl) return;
                tooltipEl.style.display = "none";
                tooltipEl.dataset.pinned = "0";
              }, { passive: true });
              window.addEventListener("scroll", function () {
                if (!tooltipEl) return;
                tooltipEl.style.display = "none";
                tooltipEl.dataset.pinned = "0";
              }, { passive: true });
              document.addEventListener("click", function (e) {
                if (!tooltipEl || tooltipEl.style.display === "none") return;
                if (tooltipEl.dataset.pinned !== "1") return;
                if (tooltipEl && tooltipEl.contains(e.target)) return;
                if (wrapEl && wrapEl.contains(e.target)) return;
                tooltipEl.style.display = "none";
                tooltipEl.dataset.pinned = "0";
              });
            }

            function scheduleHideTooltip() {
              if (!tooltipEl) return;
              if (tooltipHideTimer) clearTimeout(tooltipHideTimer);
              tooltipHideTimer = setTimeout(function () {
                if (!tooltipEl) return;
                if (tooltipEl.dataset.pinned === "1") return;
                if (tooltipEl.dataset.hovering === "1") return;
                tooltipEl.style.display = "none";
              }, 140);
            }

            function isDoubleTap(el) {
              var now = Date.now();
              var last = 0;
              try { last = parseInt(String(el.getAttribute("data-last-tap") || "0"), 10) || 0; } catch (e) { last = 0; }
              el.setAttribute("data-last-tap", String(now));
              return last && (now - last) <= 350;
            }

            function setTooltipContent(ev) {
              if (!tooltipEl) return;
              while (tooltipEl.firstChild) tooltipEl.removeChild(tooltipEl.firstChild);

              var atTxt = "";
              var header = document.createElement("div");
              header.className = "events-timeline-tooltip-header";

              var iconSvg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
              iconSvg.setAttribute("viewBox", "0 0 48 48");
              iconSvg.setAttribute("aria-hidden", "true");
              iconSvg.classList.add("events-timeline-tooltip-icon");
              var iconWrap = document.createElementNS("http://www.w3.org/2000/svg", "g");
              iconWrap.setAttribute("transform", "translate(24,24)");
              iconWrap.appendChild(iconGroup(ev.iconKey, { size: 48, label: ev.typeLabel }));
              iconSvg.appendChild(iconWrap);
              header.appendChild(iconSvg);

              var title = document.createElement("div");
              title.className = "events-timeline-tooltip-title";
              title.appendChild(document.createTextNode(ev.typeLabel + (ev.side ? " (" + ev.side + ")" : "")));
              header.appendChild(title);
              tooltipEl.appendChild(header);

                var meta = document.createElement("div");
                meta.className = "events-timeline-tooltip-meta";
                var pLabel = ev.period === 4 ? "OT" : "P" + ev.period;
                if (ev.startWithin !== undefined && ev.endWithin !== undefined && ev.startWithin !== null && ev.endWithin !== null) {
                  atTxt = pLabel + " " + secondsToLabel(ev.startWithin);
                  meta.appendChild(
                    document.createTextNode(pLabel + " " + secondsToLabel(ev.startWithin) + "–" + secondsToLabel(ev.endWithin))
                  );
                } else {
                  var timeTxt = String(getValue(ev.row, ["Game Time", "GameTime", "Time"]) || "").trim();
                  if (!timeTxt) timeTxt = secondsToLabel(ev.tWithin);
                  atTxt = pLabel + " " + timeTxt;
                  meta.appendChild(document.createTextNode(pLabel + " @ " + timeTxt));
                }
                tooltipEl.appendChild(meta);

              function addLine(label, v) {
                var s = String(v || "").trim();
                if (!s) return;
                if (s.length > 180) s = s.slice(0, 177) + "...";
                var line = document.createElement("div");
                line.className = "events-timeline-tooltip-line";
                line.appendChild(document.createTextNode(label + ": " + s));
                tooltipEl.appendChild(line);
              }

              function splitList(v) {
                var s = String(v || "").trim();
                if (!s) return [];
                // Accept comma-separated or newline-separated.
                s = s.replace(/\r/g, "\n");
                s = s.replace(/\n+/g, ",");
                var parts = s.split(",").map(function (x) { return String(x || "").trim(); }).filter(Boolean);
                return parts;
              }

              function addMultiline(label, v) {
                var items = splitList(v);
                if (!items.length) return;
                var text = label + ":\n" + items.join("\n");
                if (text.length > 700) text = text.slice(0, 697) + "...";
                var line = document.createElement("div");
                line.className = "events-timeline-tooltip-line events-timeline-tooltip-pre";
                line.textContent = text;
                tooltipEl.appendChild(line);
              }

              function addSectionBlock(label, v) {
                var items = splitList(v);
                if (!items.length) return;
                var wrap = document.createElement("div");
                wrap.className = "events-timeline-tooltip-section";
                var lab = document.createElement("div");
                lab.className = "events-timeline-tooltip-section-label";
                lab.textContent = String(label || "").trim() || "";
                wrap.appendChild(lab);
                var body = document.createElement("div");
                body.className = "events-timeline-tooltip-line events-timeline-tooltip-pre";
                var text = items.join("\n");
                if (text.length > 700) text = text.slice(0, 697) + "...";
                body.textContent = text;
                wrap.appendChild(body);
                tooltipEl.appendChild(wrap);
                }

                addLine("Event ID", getValue(ev.row, ["Event ID", "EventID", "EventId"]));
                (function () {
                  var vt = String(getValue(ev.row, ["Video Time", "VideoTime"]) || "").trim();
                  var vsn = parseVideoSecondsFromRow(ev.row || {});
                  var hasVs = (vsn !== null && isFinite(vsn));
                  if (!vt && hasVs) vt = secondsToLabel(vsn);
                  if (vt || hasVs) {
                    addLine("Video Time", vt);
                    if (hasVs) addLine("Video Seconds", String(Math.floor(vsn)));
                    if (!gameVideoUrl) addLine("Video URL", "missing");
                  }
                })();
                addLine("Players", getValue(ev.row, ["Attributed Players"]));
                addLine("Jerseys", getValue(ev.row, ["Attributed Jerseys"]));
                addLine("Details", getValue(ev.row, ["Details"]));
                (function () {
                  var onIceHome = getValue(ev.row, ["On-Ice Players (Home)", "On-Ice Home", "OnIceHome"]);
                  var onIceAway = getValue(ev.row, ["On-Ice Players (Away)", "On-Ice Away", "OnIceAway"]);
                  var onIceLegacy = getValue(ev.row, ["On-Ice Players", "OnIcePlayers"]);
                  var hasSplit = String(onIceHome || "").trim() || String(onIceAway || "").trim();
                  if (!hasSplit) {
                    addSectionBlock("On-Ice", onIceLegacy);
                    return;
                  }
                  var homeLabel = "On-Ice (Home — " + (homeTeamName || "Home") + ")";
                  var awayLabel = "On-Ice (Away — " + (awayTeamName || "Away") + ")";
                  if (String(ev.side || "") === "Away") {
                    addSectionBlock(awayLabel, onIceAway);
                    addSectionBlock(homeLabel, onIceHome);
                  } else {
                    addSectionBlock(homeLabel, onIceHome);
                    addSectionBlock(awayLabel, onIceAway);
                  }
                })();
                if (ev.penaltiesText) addMultiline("Penalties", ev.penaltiesText);

                // Action buttons (mobile-friendly: tap icon to show tooltip, then press Video).
                try {
                  if (gameVideoUrl && videoPane && videoIframe) {
                    var vs3 = parseVideoSecondsFromRow(ev.row || {});
                    if (vs3 !== null && isFinite(vs3)) {
                      var actions = document.createElement("div");
                      actions.className = "events-timeline-tooltip-line";
                      actions.style.marginTop = "0.35rem";
                      var btn = document.createElement("button");
                      btn.type = "button";
                      btn.className = "btn secondary";
                      btn.textContent = "Video";
                      btn.style.padding = ".35rem .6rem";
                      btn.style.borderRadius = "10px";
                      btn.addEventListener("click", function (e) {
                        e.preventDefault();
                        e.stopPropagation();
                        openVideoClipForRow(ev.row || {}, { label: ev.typeLabel, at: atTxt });
                      });
                      actions.appendChild(btn);
                      tooltipEl.appendChild(actions);
                    }
                  }
                } catch (e) {}
              }

            function positionTooltip(clientX, clientY) {
              if (!tooltipEl) return;
              var x = clientX;
              var y = clientY;
              tooltipEl.style.display = "block";
              tooltipEl.style.left = x + "px";
              tooltipEl.style.top = y + "px";
              try {
                var mh = Math.max(80, Math.floor((window.innerHeight || 0) * 0.70));
                if (isFinite(mh) && mh > 0) {
                  tooltipEl.style.maxHeight = mh + "px";
                  tooltipEl.style.overflowY = "auto";
                  tooltipEl.style.webkitOverflowScrolling = "touch";
                }
              } catch (e) {}
              // Clamp after layout.
              var tw = tooltipEl.offsetWidth || 0;
              var th = tooltipEl.offsetHeight || 0;
              var maxX = (window.innerWidth || 0) - 8;
              var maxY = (window.innerHeight || 0) - 8;
              var left = Math.min(Math.max(8, x + 12), maxX - tw);
              // Prefer showing below the cursor/tap; if it would overflow, flip above.
              var preferredTop = y + 12;
              if (preferredTop + th + 8 > (window.innerHeight || 0)) {
                preferredTop = y - 12 - th;
              }
              var top = Math.min(Math.max(8, preferredTop), maxY - th);
              tooltipEl.style.left = left + "px";
              tooltipEl.style.top = top + "px";
            }

            var countsByKey = {};

            // Draw PP/PK spans (behind icons).
            function spanDrawY(side, laneKeyValue) {
              var y = axisY;
              if (side === "Home") {
                var iy = yIndexFor[laneKeyValue];
                if (iy === undefined) return null;
                return axisY - axisGap - (iy + 0.5) * rowSpacing;
              } else if (side === "Away") {
                var ia = yIndexAgainst[laneKeyValue];
                if (ia === undefined) return null;
                return axisY + axisGap + (ia + 0.5) * rowSpacing;
              }
              return null;
            }
              for (var sp = 0; sp < spans.length; sp++) {
                var sEv = spans[sp];
                var yS = spanDrawY(sEv.side, sEv.laneKey);
                if (yS === null) continue;
                var x1 = xForTime(sEv.period, sEv.startWithin);
                var x2 = xForTime(sEv.period, sEv.endWithin);
                var xa = Math.min(x1, x2);
                var xb = Math.max(x1, x2);
                if (!isFinite(xa) || !isFinite(xb) || xb <= xa) continue;
                var col = sEv.iconKey === "pp" ? "#22c55e" : "#ef4444";
                var ln = svgEl("line", { x1: xa, y1: yS, x2: xb, y2: yS, stroke: col, "stroke-width": 6, "stroke-linecap": "round", opacity: 0.85 });
                ln.style.cursor = "pointer";
                var spTitle = svgEl("title");
                var pLbl = sEv.period === 4 ? "OT" : "P" + sEv.period;
                spTitle.appendChild(document.createTextNode(sEv.typeLabel + " (" + sEv.side + ") • " + pLbl + " " + secondsToLabel(sEv.startWithin) + "–" + secondsToLabel(sEv.endWithin)));
                ln.appendChild(spTitle);
                (function (evCopy) {
                  ln.addEventListener("mouseenter", function (e) {
                    if (!tooltipEl) return;
                    if (tooltipEl.dataset.pinned === "1") return;
                    setTooltipContent(evCopy);
                    positionTooltip(e.clientX, e.clientY);
                  });
                  ln.addEventListener("mousemove", function (e) {
                    if (!tooltipEl) return;
                    if (tooltipEl.dataset.pinned === "1") return;
                    positionTooltip(e.clientX, e.clientY);
                  });
                  ln.addEventListener("mouseleave", function () {
                    if (!tooltipEl) return;
                    if (tooltipEl.dataset.pinned === "1") return;
                    scheduleHideTooltip();
                  });
                    ln.addEventListener("click", function (e) {
                      if (isTouchDevice) {
                        var atTap = (evCopy.period === 4 ? "OT" : "P" + evCopy.period) + " " + secondsToLabel(evCopy.startWithin || evCopy.tWithin);
                        if (isDoubleTap(ln) && openVideoClipForRow(evCopy.row, { label: evCopy.typeLabel, at: atTap })) {
                          if (tooltipEl) {
                            tooltipEl.style.display = "none";
                            tooltipEl.dataset.pinned = "0";
                          }
                          e.stopPropagation();
                          return;
                        }
                      }
                      if (!isTouchDevice) {
                        var atTxt = (evCopy.period === 4 ? "OT" : "P" + evCopy.period) + " " + secondsToLabel(evCopy.startWithin || evCopy.tWithin);
                        if (openVideoClipForRow(evCopy.row, { label: evCopy.typeLabel, at: atTxt })) {
                          if (tooltipEl) {
                            tooltipEl.style.display = "none";
                            tooltipEl.dataset.pinned = "0";
                          }
                          e.stopPropagation();
                          return;
                        }
                      }
                      if (!tooltipEl) return;
                      if (tooltipEl.style.display === "none" || tooltipEl.dataset.pinned !== "1") {
                        tooltipEl.dataset.pinned = "1";
                        setTooltipContent(evCopy);
                        positionTooltip(e.clientX, e.clientY);
                    } else {
                      tooltipEl.style.display = "none";
                      tooltipEl.dataset.pinned = "0";
                    }
                    e.stopPropagation();
                  });
                  ln.addEventListener("dblclick", function (e) {
                    var atTxt = (evCopy.period === 4 ? "OT" : "P" + evCopy.period) + " " + secondsToLabel(evCopy.startWithin || evCopy.tWithin);
                    openVideoClipForRow(evCopy.row, { label: evCopy.typeLabel, at: atTxt });
                    e.preventDefault();
                    e.stopPropagation();
                  });
                })(sEv);
                svg.appendChild(ln);
              }
            for (var e2 = 0; e2 < drawList.length; e2++) {
              var ev3 = drawList[e2];
              var x = xForTime(ev3.period, ev3.tWithin);

              var y = axisY;
              if (ev3.side === "Home") {
                var iy = yIndexFor[ev3.laneKey];
                if (iy === undefined) continue;
                y = axisY - axisGap - (iy + 0.5) * rowSpacing;
              } else if (ev3.side === "Away") {
                var ia = yIndexAgainst[ev3.laneKey];
                if (ia === undefined) continue;
                y = axisY + axisGap + (ia + 0.5) * rowSpacing;
              }

              var jitterKey = ev3.side + "|" + ev3.laneKey + "|" + ev3.period + "|" + ev3.tWithin;
              countsByKey[jitterKey] = (countsByKey[jitterKey] || 0) + 1;
              var idx = countsByKey[jitterKey] - 1;
              var dx = (idx % 5) * 4; // small spread when multiple events are identical
              x = Math.min(W - rightPad, x + dx);

              var g = svgEl("g", { transform: "translate(" + x + "," + y + ")" });
              var icon = iconGroup(ev3.iconKey, { size: iconSize, label: ev3.typeLabel });
              g.appendChild(icon);
              g.style.cursor = "pointer";

              var title = [];
              title.push(ev3.typeLabel);
              if (ev3.side === "Home" || ev3.side === "Away") title.push(ev3.side);
              var timeTxt2 = String(getValue(ev3.row, ["Game Time", "GameTime", "Time"]) || "").trim();
              if (!timeTxt2) timeTxt2 = secondsToLabel(ev3.tWithin);
              title.push((ev3.period === 4 ? "OT" : "P" + ev3.period) + " @ " + timeTxt2);
              var tTitle = svgEl("title");
              tTitle.appendChild(document.createTextNode(title.join(" • ")));
              g.appendChild(tTitle);

              (function (evCopy) {
                g.addEventListener("mouseenter", function (e) {
                  if (!tooltipEl) return;
                  if (tooltipEl.dataset.pinned === "1") return;
                  setTooltipContent(evCopy);
                  positionTooltip(e.clientX, e.clientY);
                });
                g.addEventListener("mousemove", function (e) {
                  if (!tooltipEl) return;
                  if (tooltipEl.dataset.pinned === "1") return;
                  positionTooltip(e.clientX, e.clientY);
                });
                  g.addEventListener("mouseleave", function () {
                    if (!tooltipEl) return;
                    if (tooltipEl.dataset.pinned === "1") return;
                    scheduleHideTooltip();
                  });
                    g.addEventListener("click", function (e) {
                      if (isTouchDevice) {
                        var atTap = (evCopy.period === 4 ? "OT" : "P" + evCopy.period) + " " + secondsToLabel(evCopy.tWithin);
                        if (isDoubleTap(g) && openVideoClipForRow(evCopy.row, { label: evCopy.typeLabel, at: atTap })) {
                          if (tooltipEl) {
                            tooltipEl.style.display = "none";
                            tooltipEl.dataset.pinned = "0";
                          }
                          e.stopPropagation();
                          return;
                        }
                      }
                      if (!isTouchDevice) {
                        var atTxt = (evCopy.period === 4 ? "OT" : "P" + evCopy.period) + " " + secondsToLabel(evCopy.tWithin);
                        if (openVideoClipForRow(evCopy.row, { label: evCopy.typeLabel, at: atTxt })) {
                          if (tooltipEl) {
                            tooltipEl.style.display = "none";
                            tooltipEl.dataset.pinned = "0";
                          }
                          e.stopPropagation();
                          return;
                        }
                      }
                      if (!tooltipEl) return;
                      if (tooltipEl.style.display === "none" || tooltipEl.dataset.pinned !== "1") {
                        tooltipEl.dataset.pinned = "1";
                        setTooltipContent(evCopy);
                        positionTooltip(e.clientX, e.clientY);
                  } else {
                    tooltipEl.style.display = "none";
                    tooltipEl.dataset.pinned = "0";
                  }
                  e.stopPropagation();
                });
                  g.addEventListener("dblclick", function (e) {
                    var atTxt = (evCopy.period === 4 ? "OT" : "P" + evCopy.period) + " " + secondsToLabel(evCopy.tWithin);
                    openVideoClipForRow(evCopy.row, { label: evCopy.typeLabel, at: atTxt });
                    e.preventDefault();
                    e.stopPropagation();
                  });
              })(ev3);

              svg.appendChild(g);
            }

            function secondsToLabel(sec) {
              sec = Math.max(0, Math.floor(sec || 0));
              var m = Math.floor(sec / 60);
              var s = sec % 60;
              return m + ":" + (s < 10 ? "0" + s : "" + s);
            }
          }

          render();
          var resizeTimer = null;
            window.addEventListener("resize", function () {
              if (resizeTimer) window.clearTimeout(resizeTimer);
              resizeTimer = window.setTimeout(render, 120);
            });

            function attachEventsTableVideoHandlers() {
              if (!gameVideoUrl || !videoPane || !videoIframe) return;
              var tbl = document.getElementById("game-events-table");
              if (!tbl) return;
              var trs = tbl.querySelectorAll("tbody tr[data-event-row-index]");
              for (var i = 0; i < trs.length; i++) {
                (function (tr) {
                  tr.addEventListener("dblclick", function () {
                    var idx = parseInt(String(tr.getAttribute("data-event-row-index") || ""), 10);
                    if (!isFinite(idx) || idx < 0 || idx >= eventsRows.length) return;
                    var r = eventsRows[idx] || {};
                    var et = String(getValue(r, ["Event Type", "EventType", "Event", "Type"]) || "").trim();
                    var per = String(getValue(r, ["Period"]) || "").trim();
                    var gt = String(getValue(r, ["Game Time", "GameTime", "Time"]) || "").trim();
                    openVideoClipForRow(r, { label: et, at: (per ? ("P" + per + (gt ? (" " + gt) : "")) : "") });
                  });
                })(trs[i]);
              }
            }
            if (document.readyState === "loading") {
              document.addEventListener("DOMContentLoaded", attachEventsTableVideoHandlers);
            } else {
              attachEventsTableVideoHandlers();
            }

            function decorateEventTypeCells() {
              var tbl = document.getElementById("game-events-table");
              if (!tbl) return;
              var headRow = tbl.querySelector("thead tr");
              if (!headRow) return;
              var ths = headRow.querySelectorAll("th");
              var targetIdx = -1;
              for (var i = 0; i < ths.length; i++) {
                var txt = (ths[i].textContent || "").trim().toLowerCase();
                if (txt === "event type" || txt === "event" || txt === "type") {
                  targetIdx = i;
                  break;
                }
              }
              if (targetIdx === -1) return;
              var rows = tbl.querySelectorAll("tbody tr");
              for (var r = 0; r < rows.length; r++) {
                var cells = rows[r].children;
                if (targetIdx >= cells.length) continue;
                var cell = cells[targetIdx];
                if (!cell || cell.getAttribute("data-iconified") === "1") continue;
                var label = (cell.textContent || "").trim();
                if (!label) continue;
                var normalizedLabel = normalizeTypeLabel(label) || label;
                var iconKey = typeKey(normalizedLabel);
                var svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
                svg.setAttribute("viewBox", "0 0 24 24");
                svg.setAttribute("aria-hidden", "true");
                svg.classList.add("event-type-icon");
                var gWrap = document.createElementNS("http://www.w3.org/2000/svg", "g");
                gWrap.setAttribute("transform", "translate(12,12)");
                gWrap.appendChild(iconGroup(iconKey, { size: 20, label: normalizedLabel }));
                svg.appendChild(gWrap);
                var wrap = document.createElement("div");
                wrap.className = "event-type-cell";
                wrap.appendChild(svg);
                var txtNode = document.createElement("span");
                txtNode.textContent = normalizedLabel;
                wrap.appendChild(txtNode);
                while (cell.firstChild) cell.removeChild(cell.firstChild);
                cell.appendChild(wrap);
                cell.setAttribute("data-iconified", "1");
              }
            }
            if (document.readyState === "loading") {
              document.addEventListener("DOMContentLoaded", decorateEventTypeCells);
            } else {
              decorateEventTypeCells();
            }
          })();
        </script>
    </div>
      <div class="table-scroll table-scroll-y">
        <table id="game-events-table" class="table-nowrap table-grid table-sortable" data-sortable="1" data-freeze-cols="1">
          <thead>
          <tr>
            {% for h in events_headers %}
              {% if h != 'Video Seconds' and h != 'VideoSeconds' and h != 'Game Seconds' and h != 'GameSeconds' and h != 'Game Seconds End' and h != 'GameSecondsEnd' %}
                {% if "On-Ice Players (Home)" in events_headers or "On-Ice Players (Away)" in events_headers %}
                  {% if h == "On-Ice Players" or h == "On-Ice Players (PM)" %}
                    {# Hide legacy on-ice column when split Home/Away columns exist. #}
                  {% elif h == "On-Ice Players (Home)" %}
                    <th><div>On-Ice</div><div class="th-subnote">Home — {{ game.team1_name }}</div></th>
                  {% elif h == "On-Ice Players (Away)" %}
                    <th><div>On-Ice</div><div class="th-subnote">Away — {{ game.team2_name }}</div></th>
                  {% else %}
                    <th>{{ h }}</th>
                  {% endif %}
                {% else %}
                  <th>{{ h }}</th>
                {% endif %}
              {% endif %}
            {% endfor %}
          </tr>
        </thead>
          <tbody>
            {% for r in events_rows %}
              <tr data-event-row-index="{{ forloop.counter0 }}">
                {% for h in events_headers %}
                  {% if h != 'Video Seconds' and h != 'VideoSeconds' and h != 'Game Seconds' and h != 'GameSeconds' and h != 'Game Seconds End' and h != 'GameSecondsEnd' %}
                    {% if "On-Ice Players (Home)" in events_headers or "On-Ice Players (Away)" in events_headers %}
                      {% if h == "On-Ice Players" or h == "On-Ice Players (PM)" %}
                        {# Hide legacy on-ice column when split Home/Away columns exist. #}
                      {% elif h == "On-Ice Players" or h == "On-Ice Players (PM)" or h == "On-Ice Players (Home)" or h == "On-Ice Players (Away)" %}
                        <td class="cell-pre">{{ r|get_item:h|commas_to_newlines }}</td>
                      {% else %}
                        <td>{{ r|get_item:h }}</td>
                      {% endif %}
                    {% else %}
                      {% if h == "On-Ice Players" or h == "On-Ice Players (PM)" or h == "On-Ice Players (Home)" or h == "On-Ice Players (Away)" %}
                        <td class="cell-pre">{{ r|get_item:h|commas_to_newlines }}</td>
                      {% else %}
                        <td>{{ r|get_item:h }}</td>
                      {% endif %}
                    {% endif %}
                  {% endif %}
              {% endfor %}
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <p class="muted">No game events uploaded yet.</p>
  {% endif %}
</div>

<dialog id="events-drilldown-modal" style="max-width:900px;width:95vw;border:none;border-radius:16px;padding:0;box-shadow:0 20px 80px rgba(0,0,0,.35);">
  <div style="padding:12px 14px;border-bottom:1px solid rgba(255,255,255,.08);display:flex;align-items:center;justify-content:space-between;gap:12px;background:rgba(0,0,0,.18);">
	    <div>
	      <div id="events-drilldown-title" style="font-weight:700;"></div>
	      <div id="events-drilldown-subtitle" class="muted-strong" style="font-size:.9rem;"></div>
	    </div>
	    <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:flex-end;">
        <div id="events-drilldown-pageviews"></div>
        <button
          id="events-drilldown-mark-clips"
          type="button"
          class="btn secondary"
          style="padding:.18rem .45rem;font-size:.75rem;line-height:1;box-shadow:none;display:none;"
          title="Mark all visible clip view counts as baseline"
        >Mark clips</button>
        <button id="events-drilldown-close" class="btn" type="button">Close</button>
      </div>
	  </div>
	  <div id="events-drilldown-video-pane" style="display:none;padding:12px 14px;border-bottom:1px solid rgba(255,255,255,.08);background:rgba(0,0,0,.12);">
    <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;">
      <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
        <span style="font-weight:600;">Video clip</span>
        <span id="events-drilldown-video-meta" class="muted" style="margin-left:.5rem;"></span>
      </div>
      <div style="display:flex;align-items:center;gap:10px;">
        <a
          id="events-drilldown-video-open-link"
          class="btn secondary"
          target="_blank"
          rel="noopener noreferrer"
          style="display:none;"
        >Open</a>
        <button type="button" class="btn" id="events-drilldown-video-close">Close</button>
      </div>
    </div>
    <div style="margin-top:10px;aspect-ratio:16/9;max-width:100%;">
      <iframe
        id="events-drilldown-video-iframe"
        title="Game video clip"
        style="border:0;width:100%;height:100%;background:#000;"
        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
        allowfullscreen
      ></iframe>
    </div>
    <div class="yt-quality-hint">
      <span class="yt-quality-text">Click the gear icon and select Highest quality</span>
      <span class="yt-quality-arrow" aria-hidden="true">↑</span>
    </div>
  </div>
  <div id="events-drilldown-body" style="padding:12px 14px;max-height:70vh;overflow:auto;"></div>
</dialog>

<style>
  #events-drilldown-body table.events-drilldown-table th,
  #events-drilldown-body table.events-drilldown-table td {
    padding: .45rem .65rem;
    font-size: .88rem;
  }
</style>

<script>
  (function () {
    function normTypeKey(s) {
      return String(s || "").trim().toLowerCase().replace(/[^a-z0-9]+/g, "");
    }
    function normName(s) {
      return String(s || "").trim().toLowerCase().replace(/[^a-z0-9]+/g, "");
    }
    function extractJersey(s) {
      var m = String(s || "").match(/(\d+)/);
      if (!m) return "";
      var n = parseInt(m[1], 10);
      return isFinite(n) ? String(n) : m[1];
    }
      function parseTimeToSeconds(s) {
        s = String(s || "").trim();
        if (!s) return null;
        var m = s.match(/^(\d+):(\d{2})(?::(\d{2}))?$/);
      if (!m) return null;
      var a = parseInt(m[1], 10);
      var b = parseInt(m[2], 10);
      var c = m[3] ? parseInt(m[3], 10) : null;
      if (!isFinite(a) || !isFinite(b)) return null;
        if (c === null) return a * 60 + b;
        if (!isFinite(c)) return null;
        return a * 3600 + b * 60 + c;
      }
      function fmtSecondsToTime(seconds) {
        var sec = parseInt(String(seconds), 10);
        if (!isFinite(sec) || sec < 0) return "";
        var h = Math.floor(sec / 3600);
        var m = Math.floor((sec % 3600) / 60);
        var s = sec % 60;
        if (h > 0) {
          return (
            String(h) +
            ":" +
            (m < 10 ? "0" + String(m) : String(m)) +
            ":" +
            (s < 10 ? "0" + String(s) : String(s))
          );
        }
        return String(m) + ":" + (s < 10 ? "0" + String(s) : String(s));
      }
    function getValue(row, keys) {
        if (!row) return "";
        for (var i = 0; i < keys.length; i++) {
          var k = keys[i];
        if (Object.prototype.hasOwnProperty.call(row, k)) return row[k];
        var kl = String(k).toLowerCase();
        for (var kk in row) {
          if (!Object.prototype.hasOwnProperty.call(row, kk)) continue;
          if (String(kk).toLowerCase() === kl) return row[kk];
        }
      }
      return "";
    }

    function headingIconKey(label) {
      var sl = String(label || "").trim().toLowerCase();
      if (!sl) return "other";
      if (sl.indexOf("goals") === 0 || sl.indexOf("goal") === 0) return "goal";
      if (sl.indexOf("xg") === 0) return "xg";
      if (sl.indexOf("sog") === 0) return "sog";
      if (sl.indexOf("shot") === 0) return "shot";
      if (sl.indexOf("assists") === 0 || sl === "assist") return "assist";
      if (sl.indexOf("completed pass") === 0) return "completed_pass";
      if (sl.indexOf("controlled entry") === 0) return "controlled_entry";
      if (sl.indexOf("controlled exit") === 0) return "controlled_exit";
      if (sl.indexOf("odd-man") === 0 || sl.indexOf("odd man") === 0 || sl.indexOf("rush") >= 0) return "odd_man_rush";
      if (sl.indexOf("turnover") >= 0 && sl.indexOf("forced") >= 0) return "turnover_forced";
      if (sl.indexOf("created") >= 0 && sl.indexOf("turnover") >= 0) return "turnover_created";
      if (sl.indexOf("giveaway") === 0) return "giveaway";
      if (sl.indexOf("takeaway") === 0) return "takeaway";
      if (sl.indexOf("penalty expired") === 0) return "penalty_expired";
      if (sl.indexOf("penalty") === 0) return "penalty";
      var icons = window.HM_EVENT_ICONS || {};
      if (typeof icons.typeKey === "function") return icons.typeKey(label);
      return "other";
    }

    function makeHeadingIcon(label) {
      var icons = window.HM_EVENT_ICONS || {};
      if (typeof icons.iconGroup !== "function") return null;
      var iconKey = headingIconKey(label);
      if (!iconKey) return null;
      var svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
      svg.setAttribute("viewBox", "0 0 24 24");
      svg.setAttribute("aria-hidden", "true");
      svg.classList.add("event-type-icon");
      var gWrap = document.createElementNS("http://www.w3.org/2000/svg", "g");
      gWrap.setAttribute("transform", "translate(12,12)");
      gWrap.appendChild(icons.iconGroup(iconKey, { size: 18, label: label }));
      svg.appendChild(gWrap);
      return svg;
    }

    function makeEventsHeading(tagName, label) {
      var h = document.createElement(tagName || "h4");
      h.style.margin = "0.75rem 0 0.35rem 0";
      var wrap = document.createElement("span");
      wrap.className = "event-type-cell";
      var icon = makeHeadingIcon(label);
      if (icon) wrap.appendChild(icon);
      var txt = document.createElement("span");
      txt.textContent = String(label || "");
      wrap.appendChild(txt);
      h.appendChild(wrap);
      return h;
    }
    var gameVideoUrl = {{ game.game_video_url|default:""|tojson }};
    var drilldownClipLenEl = document.getElementById("timeline-clip-len");

    function parseVideoSecondsFromRow(row) {
      var vsTxt = String(
        getValue(row, ["Video Seconds", "VideoSeconds", "Video S", "VideoS"]) || ""
      ).trim();
      if (vsTxt) {
        if (vsTxt.match(/^-?\d+(\.\d+)?$/)) {
          var f = parseFloat(vsTxt);
          return isFinite(f) ? Math.floor(f) : null;
        }
        var t = parseTimeToSeconds(vsTxt);
        if (t !== null && isFinite(t)) return Math.floor(t);
      }
      var vt = String(getValue(row, ["Video Time", "VideoTime"]) || "").trim();
      var vtS = parseTimeToSeconds(vt);
      return vtS !== null && isFinite(vtS) ? Math.floor(vtS) : null;
    }

    function extractYoutubeId(url) {
      if (!url) return null;
      try {
        var u = new URL(String(url), window.location.origin);
        var host = String(u.hostname || "").toLowerCase();
        if (host === "youtu.be") {
          var p = String(u.pathname || "").replace(/^\//, "");
          return p ? p.split("/")[0] : null;
        }
        var v = u.searchParams.get("v");
        if (v) return v;
        var path = String(u.pathname || "");
        var m = path.match(/\/embed\/([^/?#]+)/) || path.match(/\/shorts\/([^/?#]+)/);
        return m ? m[1] : null;
      } catch (e) {}
      return null;
    }

      function buildYoutubeWatchUrl(url, startSec) {
      var id = extractYoutubeId(url);
      if (!id) return null;
      var start = Math.max(0, Math.floor(startSec || 0));
      try {
        var w = new URL("https://www.youtube.com/watch");
        w.searchParams.set("v", String(id));
        w.searchParams.set("t", String(start) + "s");
        w.searchParams.set("autoplay", "1");
        w.searchParams.set("vq", "highres");
        return w.toString();
      } catch (e) {
        return null;
      }
    }

    function buildYoutubeEmbedUrl(url, startSec, endSec) {
      var id = extractYoutubeId(url);
      if (!id) return null;
      var start = Math.max(0, Math.floor(startSec || 0));
      var end = Math.max(start + 1, Math.floor(endSec || 0));
      var params = new URLSearchParams();
      params.set("autoplay", "1");
      params.set("mute", "1");
      params.set("enablejsapi", "1");
      params.set("origin", String(window.location.origin || ""));
      params.set("start", String(start));
      params.set("end", String(end));
      params.set("vq", "highres");
      params.set("rel", "0");
      params.set("modestbranding", "1");
      params.set("playsinline", "1");
      return "https://www.youtube-nocookie.com/embed/" + encodeURIComponent(id) + "?" + params.toString();
    }

    function requestYouTubeBestQuality(iframeEl) {
      try {
        if (!iframeEl || !iframeEl.contentWindow) return;
        var cmds = [
          { func: "setPlaybackQuality", args: ["highres"] },
          { func: "setPlaybackQuality", args: ["hd2160"] },
          { func: "setPlaybackQuality", args: ["hd1440"] },
          { func: "setPlaybackQuality", args: ["hd1080"] },
          { func: "setPlaybackQuality", args: ["hd720"] },
          { func: "setPlaybackQuality", args: ["large"] },
          { func: "setPlaybackQualityRange", args: ["highres", "highres"] },
          { func: "setPlaybackQualityRange", args: ["highres", "hd1080"] },
        ];
        for (var i = 0; i < cmds.length; i++) {
          iframeEl.contentWindow.postMessage(
            JSON.stringify({ event: "command", func: cmds[i].func, args: cmds[i].args || [] }),
            "https://www.youtube-nocookie.com"
          );
        }
      } catch (e) {}
    }

    function closeDrilldownVideo() {
      var pane = document.getElementById("events-drilldown-video-pane");
      var iframe = document.getElementById("events-drilldown-video-iframe");
      var meta = document.getElementById("events-drilldown-video-meta");
      var open = document.getElementById("events-drilldown-video-open-link");
      if (iframe) iframe.src = "";
      if (open) {
        open.href = "";
        open.style.display = "none";
      }
      if (pane) pane.style.display = "none";
      if (meta) meta.textContent = "";
    }

    var drilldownVideoClose = document.getElementById("events-drilldown-video-close");
    if (drilldownVideoClose) {
      drilldownVideoClose.addEventListener("click", closeDrilldownVideo);
    }

    function openDrilldownVideoClipForRow(row, opts) {
      opts = opts || {};
      if (!gameVideoUrl) return false;
      var pane = document.getElementById("events-drilldown-video-pane");
      var iframe = document.getElementById("events-drilldown-video-iframe");
      var meta = document.getElementById("events-drilldown-video-meta");
      var open = document.getElementById("events-drilldown-video-open-link");
      if (!pane || !iframe) return false;
      var vs2 = parseVideoSecondsFromRow(row);
      if (vs2 === null || !isFinite(vs2)) return false;

      try {
        var eid = hmEventRowIdFromRow(row);
        if (eid !== null) hmRecordLeaguePageView("event_clip", eid);
      } catch (e) {}

      var totalClipS = 30;
      try {
        var v = parseInt(String(drilldownClipLenEl && drilldownClipLenEl.value || "").trim(), 10);
        if (isFinite(v) && v > 0) totalClipS = v;
      } catch (e) {}
      var etKey = normTypeKey(getValue(row, ["Event Type", "Event"]));
      var preS = 20;
      var postS = 10;
      if (etKey === "completedpass") {
        totalClipS = 10;
        preS = 5;
        postS = 5;
      } else {
        if (totalClipS !== 15 && totalClipS !== 20 && totalClipS !== 30 && totalClipS !== 45 && totalClipS !== 60 && totalClipS !== 90) {
          totalClipS = 30;
        }
        preS = Math.max(0, Math.round(totalClipS * 2 / 3));
        postS = Math.max(0, totalClipS - preS);
      }
      var start2 = Math.max(0, Math.floor(vs2 - preS));
      var end2 = Math.max(start2 + 1, Math.floor(vs2 + postS));

      var watchUrl = buildYoutubeWatchUrl(gameVideoUrl, start2);
      if (open) {
        open.href = watchUrl || "";
        open.style.display = watchUrl ? "" : "none";
      }
      var embed = buildYoutubeEmbedUrl(gameVideoUrl, start2, end2);
      if (!embed) return false;
      iframe.src = embed;
      iframe.setAttribute("src", embed);
      // Best-effort: request highest available quality after navigation.
      try {
        if (!iframe._hmYtQualityHookInstalled) {
          iframe._hmYtQualityHookInstalled = true;
          iframe.addEventListener("load", function () { requestYouTubeBestQuality(iframe); });
        }
        requestYouTubeBestQuality(iframe);
        window.setTimeout(function () { requestYouTubeBestQuality(iframe); }, 250);
        window.setTimeout(function () { requestYouTubeBestQuality(iframe); }, 800);
        window.setTimeout(function () { requestYouTubeBestQuality(iframe); }, 1600);
      } catch (e) {}
      if (meta) {
        var label = (opts.label ? String(opts.label) : "");
        var at = (opts.at ? String(opts.at) : "");
        var metaTxt = [];
        if (label) metaTxt.push(label);
        if (at) metaTxt.push(at);
        metaTxt.push(totalClipS + "s clip (" + preS + "s before, " + postS + "s after)");
        meta.textContent = metaTxt.join(" • ");
      }
      pane.style.display = "block";
      try {
        pane.scrollIntoView({ behavior: "smooth", block: "start" });
      } catch (e) {}
      return true;
    }
    function rowSide(row) {
      var s = String(getValue(row, ["Team Side", "TeamSide", "Side", "Team Rel", "TeamRel", "Team"])).trim().toLowerCase();
      if (s === "home" || s === "team1") return "home";
      if (s === "away" || s === "team2") return "away";
      return "";
    }
    function rowPeriod(row) {
      var p = parseInt(String(getValue(row, ["Period"])).trim(), 10);
      return isFinite(p) ? p : null;
    }
    function rowGameSeconds(row) {
      var gs = parseInt(String(getValue(row, ["Game Seconds", "GameSeconds"])).trim(), 10);
      if (isFinite(gs)) return gs;
      return parseTimeToSeconds(getValue(row, ["Game Time", "GameTime", "Time"]));
    }

    var dataEl = document.getElementById("game-events-timeline-data");
    if (!dataEl) return;
    var eventsRows = [];
    try {
      eventsRows = JSON.parse(dataEl.textContent || "[]") || [];
    } catch (e) {
      eventsRows = [];
    }
    if (!Array.isArray(eventsRows) || eventsRows.length === 0) return;

    var _assistsByTime = {};
    var _assistsBySideTime = {};
    function _pushUniqueAssist(list, jersey, name) {
      if (!list) return;
      var j = String(jersey || "").trim();
      if (!j) return;
      var nm = String(name || "").trim();
      for (var i = 0; i < list.length; i++) {
        var cur = list[i] || {};
        if (String(cur.jersey || "") === j) {
          if (!String(cur.name || "").trim() && nm) cur.name = nm;
          return;
        }
      }
      list.push({ jersey: j, name: nm });
    }
    eventsRows.forEach(function (row) {
      if (normTypeKey(getValue(row, ["Event Type", "Event"])) !== "assist") return;
      var period = rowPeriod(row);
      if (period === null) return;
      var gs = rowGameSeconds(row);
      if (gs === null) return;
      var jersey = extractJersey(getValue(row, ["Attributed Jerseys", "AttributedJerseys"]));
      if (!jersey) return;
      var assistName = String(getValue(row, ["Attributed Players", "AttributedPlayers"]) || "").trim();
      var k0 = String(period) + "|" + String(gs);
      if (!_assistsByTime[k0]) _assistsByTime[k0] = [];
      _pushUniqueAssist(_assistsByTime[k0], jersey, assistName);
      var side = rowSide(row);
      if (side) {
        var k1 = k0 + "|" + String(side);
        if (!_assistsBySideTime[k1]) _assistsBySideTime[k1] = [];
        _pushUniqueAssist(_assistsBySideTime[k1], jersey, assistName);
      }
    });

    function _assistJerseysForGoalRow(row) {
      var period = rowPeriod(row);
      if (period === null) return [];
      var gs = rowGameSeconds(row);
      if (gs === null) return [];
      var k0 = String(period) + "|" + String(gs);
      var side = rowSide(row);
      var k1 = side ? (k0 + "|" + String(side)) : "";
      return (k1 && _assistsBySideTime[k1]) || _assistsByTime[k0] || [];
    }

    function _stripGoalScorerFromDetails(rawDetails, scorerName) {
      var s = String(rawDetails || "").trim();
      if (!s) return "";

      // If this was prefixed by withDetailsTag("Goal"), keep the tag but operate on the base.
      var tag = "";
      if (s === "Goal") {
        tag = "Goal";
        s = "";
      } else if (s.indexOf("Goal — ") === 0) {
        tag = "Goal";
        s = String(s.slice("Goal — ".length) || "").trim();
      }

      // Remove the common "(A: ...)" suffix from TimeToScore goals; assists are shown separately.
      s = s.replace(/\(\s*A\s*:\s*[^)]*\)\s*$/i, "").trim();

      var name = String(scorerName || "").trim();
      if (name) {
        var esc = String(name).replace(/[.*+?^${}()|[\]\\]/g, "\\$&");

        // Handle strings like "#9 Ethan L Olivier" / "9Ethan L Olivier" / "#9Ethan L Olivier".
        var reJerseyName = new RegExp("^#?\\s*\\d+\\s*" + esc + "(\\b|$)", "i");
        if (reJerseyName.test(s)) {
          s = String(s.replace(reJerseyName, "") || "").trim();
          s = s.replace(/^[\\s\\-–—:]+/, "").trim();
        }

        var sLower = s.toLowerCase();
        var nameLower = name.toLowerCase();
        if (sLower === nameLower) s = "";
        else if (sLower.indexOf(nameLower) === 0) {
          s = String(s.slice(name.length) || "").trim();
          s = s.replace(/^[\s\-–—:]+/, "").trim();
        }
      }

      return tag ? (tag + (s ? (" — " + s) : "")) : s;
    }

    var STAT_TO_EVENT_TYPE_KEYS = {
      goals: ["goal"],
      assists: ["assist"],
      expected_goals: ["xg", "expectedgoal", "goal"],
      sog: ["sog", "xg", "expectedgoal", "goal"],
      shots: ["shot", "sog", "xg", "expectedgoal", "goal"],
      pim: ["penalty"],
      completed_passes: ["completedpass"],
      plus_minus: ["goal"],
      gf_counted: ["goal"],
      ga_counted: ["goal"],
    };
    var PLAYER_EVENT_TYPE_EXCLUDE = {
      controlledentry: true,
      controlledexit: true,
      oddmanrush: true,
    };

    var PLAYER_EVENTS_SCOPE_LABEL = String("{{ game.team2_name|escapejs }} at {{ game.team1_name|escapejs }}{% if game.starts_at %} {{ game.starts_at|date:'Y-m-d' }}{% endif %}" || "").trim();

    var hmPublicLeagueId = {{ public_league_id|default:"null"|tojson }};
    var hmSelectedLeagueId = {{ selected_league_id|tojson }};
    var hmIsLeagueOwner = {% if league_page_views %}true{% else %}false{% endif %};

    function hmPv() {
      try { return window.hmLeaguePageViews || null; } catch (e) { return null; }
    }

    function hmLeagueIdNow() {
      var pv = hmPv();
      if (!pv || !pv.activeLeagueId) return null;
      try {
        return pv.activeLeagueId({ publicLeagueId: hmPublicLeagueId, selectedLeagueId: hmSelectedLeagueId });
      } catch (e) {
        return null;
      }
    }

    function hmEventRowIdFromRow(row) {
      var pv = hmPv();
      if (pv && pv.eventRowIdFromRow) {
        try { return pv.eventRowIdFromRow(row); } catch (e) {}
      }
      try {
        var raw = row ? row["__hm_event_row_id"] : null;
        var v = parseInt(String(raw || "").trim(), 10);
        return isFinite(v) && v > 0 ? v : null;
      } catch (e) {
        return null;
      }
    }

    function hmRecordLeaguePageView(kind, entityId) {
      var pv = hmPv();
      if (!pv || !pv.record) return;
      var leagueId = hmLeagueIdNow();
      if (leagueId === null || leagueId === undefined) return;
      pv.record(leagueId, kind, entityId);
    }

    function hmRenderPlayerEventsPageViews(playerId) {
      var pvWrap = document.getElementById("events-drilldown-pageviews");
      if (!pvWrap) return;
      pvWrap.innerHTML = "";
      if (!hmIsLeagueOwner) return;
      var pv = hmPv();
      if (!pv || !pv.renderPlayerEventsPageViews) return;
      var leagueId = hmLeagueIdNow();
      if (leagueId === null || leagueId === undefined) return;
      pv.renderPlayerEventsPageViews(pvWrap, leagueId, playerId);
    }

    function hmRefreshClipViewCounts(container) {
      if (!hmIsLeagueOwner) return;
      var pv = hmPv();
      if (!pv || !pv.refreshClipViewCounts) return;
      var leagueId = hmLeagueIdNow();
      if (leagueId === null || leagueId === undefined) return;
      var markBtn = document.getElementById("events-drilldown-mark-clips");
      pv.refreshClipViewCounts(container, leagueId, { markButton: markBtn });
    }

    function hmMarkClipBaselines(container) {
      if (!hmIsLeagueOwner) return;
      var pv = hmPv();
      if (!pv || !pv.markClipBaselines) return;
      var leagueId = hmLeagueIdNow();
      if (leagueId === null || leagueId === undefined) return;
      var markBtn = document.getElementById("events-drilldown-mark-clips");
      pv.markClipBaselines(container, leagueId, { markButton: markBtn });
    }

    var _tableFitQueued = false;
    function queueTableFit() {
      if (_tableFitQueued) return;
      _tableFitQueued = true;
      window.requestAnimationFrame(function () {
        _tableFitQueued = false;
        try {
          window.dispatchEvent(new Event("resize"));
        } catch (e) {}
      });
    }

    function buildEventsTable(container, rows) {
      var tableCtx = arguments.length > 2 && arguments[2] ? arguments[2] : {};
      var wrap = document.createElement("div");
      wrap.className = "table-fit-wrap";
      var table = document.createElement("table");
      table.className =
        "table-no-scroll-mobile table-fit-force table-never-wrap table-grid events-drilldown-table";
      var thead = document.createElement("thead");
      var trh = document.createElement("tr");
      ["P", "Time", "Video", "Details", "Source"].forEach(function (h) {
        var th = document.createElement("th");
        th.textContent = h;
        trh.appendChild(th);
      });
      thead.appendChild(trh);
      table.appendChild(thead);
      var tbody = document.createElement("tbody");
        rows.forEach(function (row) {
          var tr = document.createElement("tr");
          var period = String(getValue(row, ["Period"]) || "").trim();
          var tGame = String(getValue(row, ["Game Time", "GameTime", "Time"]) || "").trim();
          var tVideo = String(getValue(row, ["Video Time", "VideoTime"]) || "").trim();
          if (!tVideo) {
            var vsTxt = String(
              getValue(row, ["Video Seconds", "VideoSeconds", "Video S", "VideoS"]) || ""
            ).trim();
            var vs2 = null;
            if (vsTxt) {
              if (vsTxt.match(/^-?\d+(\.\d+)?$/)) {
                var f = parseFloat(vsTxt);
                vs2 = isFinite(f) ? Math.floor(f) : null;
              } else {
                var t = parseTimeToSeconds(vsTxt);
                vs2 = t !== null && isFinite(t) ? Math.floor(t) : null;
              }
            }
          if (vs2 !== null && vs2 >= 0) {
              tVideo = fmtSecondsToTime(vs2);
            }
          }
          var details = String(getValue(row, ["Details"]) || "").trim();
          if (tableCtx && tableCtx.hideGoalScorer) {
            var typeKey = normTypeKey(getValue(row, ["Event Type", "Event"]));
            if (typeKey === "goal") {
              var baseTag = "";
              var baseDetails = details;
              if (details === "Goal") {
                baseTag = "Goal";
                baseDetails = "";
              } else if (details.indexOf("Goal — ") === 0) {
                baseTag = "Goal";
                baseDetails = String(details.slice("Goal — ".length) || "").trim();
              }

              var assists = _assistJerseysForGoalRow(row);
              var assistLines = [];
              function _fmtAssist(a) {
                if (!a) return "";
                var j = String(a.jersey || "").trim();
                if (!j) return "";
                var nm = String(a.name || "").trim();
                return "#" + j + (nm ? (" " + nm) : "");
              }
              if (assists && assists.length === 1) assistLines.push("A: " + _fmtAssist(assists[0]));
              else if (assists && assists.length >= 2) {
                assistLines.push("A1: " + _fmtAssist(assists[0]));
                assistLines.push("A2: " + _fmtAssist(assists[1]));
              }

              var extra = _stripGoalScorerFromDetails(baseDetails, tableCtx.scorerName || "");
              if (extra && (extra === "Goal" || extra.indexOf("Goal — ") === 0)) {
                // _stripGoalScorerFromDetails can re-apply a Goal tag; don't double-tag.
                extra = String(extra.replace(/^Goal\s*(—\s*)?/, "") || "").trim();
              }

              var outLines = assistLines.slice();
              if (extra) outLines.push(extra);
              if (baseTag && outLines.length) outLines[0] = baseTag + " — " + outLines[0];
              details = outLines.length ? outLines.join("\n") : (baseTag || "");
            }
          }
          var src = String(getValue(row, ["Source"]) || "").trim();

        var tdP = document.createElement("td");
        tdP.textContent = period;
        tr.appendChild(tdP);

        var tdT = document.createElement("td");
        tdT.textContent = tGame;
        tr.appendChild(tdT);

        var tdV = document.createElement("td");
        if (tVideo && typeof openDrilldownVideoClipForRow === "function") {
          var btn = document.createElement("button");
          btn.type = "button";
          btn.className = "btn secondary";
          btn.style.padding = ".25rem .55rem";
          btn.style.fontSize = ".85rem";
          btn.style.display = "inline-flex";
          btn.style.alignItems = "center";
          btn.style.gap = ".35rem";
          var tSpan = document.createElement("span");
          tSpan.className = "hm-clip-time";
          tSpan.textContent = tVideo;
          btn.appendChild(tSpan);
          var eid = hmEventRowIdFromRow(row);
          if (hmIsLeagueOwner && hmLeagueIdNow() && eid !== null) {
            var vSpan = document.createElement("span");
            vSpan.className = "muted";
            vSpan.style.fontSize = ".82rem";
            vSpan.style.fontWeight = "600";
            vSpan.setAttribute("data-hm-clip-views", "1");
            vSpan.setAttribute("data-event-row-id", String(eid));
            btn.appendChild(vSpan);
          }
          btn.addEventListener("click", function () {
            var et = String(getValue(row, ["Event Type", "Event"]) || "").trim();
            var atTxt = "";
            if (period) atTxt = "P" + period + (tGame ? (" " + tGame) : "");
            else if (tGame) atTxt = tGame;
            try { openDrilldownVideoClipForRow(row, { label: et, at: atTxt }); } catch (e) {}
          });
          tdV.appendChild(btn);
        } else {
          tdV.textContent = tVideo || "";
        }
        tr.appendChild(tdV);

        var tdD = document.createElement("td");
        tdD.textContent = details;
        if (details.indexOf("\n") >= 0) tdD.className = "cell-pre";
        tr.appendChild(tdD);

        var tdS = document.createElement("td");
        tdS.textContent = src;
        tr.appendChild(tdS);

        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
      wrap.appendChild(table);
      container.appendChild(wrap);
      queueTableFit();
    }

	    function sortRowsByPeriodAndGameClockDesc(rows) {
	      // Chronological within a game:
	      //   - period asc,
	      //   - time within period desc (clock counts down).
	      var decorated = [];
	      for (var i = 0; i < (rows || []).length; i++) {
	        decorated.push({ idx: i, row: rows[i] });
	      }
	      decorated.sort(function (aa, bb) {
	        var a = aa.row;
	        var b = bb.row;
	        var pa = rowPeriod(a);
	        var pb = rowPeriod(b);
	        pa = pa === null ? 999 : pa;
	        pb = pb === null ? 999 : pb;
	        if (pa !== pb) return pa - pb;
	        var ga = rowGameSeconds(a);
	        var gb = rowGameSeconds(b);
	        ga = ga === null ? -1 : ga;
	        gb = gb === null ? -1 : gb;
	        if (ga !== gb) return gb - ga;
	        return aa.idx - bb.idx;
	      });
	      for (var j = 0; j < decorated.length; j++) {
	        rows[j] = decorated[j].row;
	      }
	    }

      function groupRows(rows, labelFn) {
        var order = [];
        var groups = {};
        (rows || []).forEach(function (r) {
          var label = String(labelFn(r) || "").trim() || "Unknown";
        var k = label.toLowerCase();
        if (!Object.prototype.hasOwnProperty.call(groups, k)) {
          groups[k] = { label: label, rows: [] };
          order.push(k);
        }
        groups[k].rows.push(r);
      });
        return { order: order, groups: groups };
      }

      function moveGroupToEnd(grouped, labelLower) {
        try {
          if (!grouped || !grouped.order || !grouped.groups) return grouped;
          var k = String(labelLower || "").trim().toLowerCase();
          if (!k) return grouped;
          if (!grouped.groups[k]) return grouped;
          var out = [];
          for (var i = 0; i < grouped.order.length; i++) {
            if (grouped.order[i] !== k) out.push(grouped.order[i]);
          }
          out.push(k);
          grouped.order = out;
          return grouped;
        } catch (e) {
          return grouped;
        }
      }

      function withDetailsTag(row, tag) {
        var copy = Object.assign({}, row);
        var base = String(getValue(row, ["Details"]) || "").trim();
        var t = String(tag || "").trim();
        if (!t) return copy;
        copy["Details"] = base ? (t + " — " + base) : t;
        return copy;
      }

      function buildShotChainTables(rows) {
        var goals = [];
        var assists = [];
        var xg = [];
        var sog = [];
        var shot = [];
        (rows || []).forEach(function (row) {
          var k = normTypeKey(getValue(row, ["Event Type", "Event"]));
          if (k === "goal") {
            goals.push(row);
            xg.push(withDetailsTag(row, "Goal"));
            sog.push(withDetailsTag(row, "Goal"));
            shot.push(withDetailsTag(row, "Goal"));
          } else if (k === "assist") {
            assists.push(row);
          } else if (k === "xg" || k === "expectedgoal") {
            xg.push(withDetailsTag(row, "xG"));
            sog.push(withDetailsTag(row, "xG"));
            shot.push(withDetailsTag(row, "xG"));
          } else if (k === "sog") {
            sog.push(withDetailsTag(row, "SOG"));
            shot.push(withDetailsTag(row, "SOG"));
          } else if (k === "shot") {
            shot.push(row);
          }
        });
        return { goals: goals, assists: assists, xg: xg, sog: sog, shot: shot };
      }

      function extractNumberSet(raw) {
        var s = String(raw || "");
        var out = {};
        var m = s.match(/(\d+)/g);
      if (!m) return out;
      m.forEach(function (v) {
        try {
          var n = parseInt(v, 10);
          if (isFinite(n)) out[String(n)] = true;
        } catch (e) {}
      });
      return out;
    }

    function openDrilldown(opts) {
      opts = opts || {};
      var playerName = String(opts.playerName || "").trim();
      var playerJersey = String(opts.playerJersey || "").trim();
      var playerId = opts.playerId;
      var playerNameNorm = normName(playerName);
      var side = String(opts.teamSide || "").trim().toLowerCase();
      var statKey = String(opts.statKey || "").trim();
      var statLabel = String(opts.statLabel || "").trim();

      var isOnIceGoalStat = statKey === "plus_minus" || statKey === "gf_counted" || statKey === "ga_counted";
      var showOnIceGoals = !statKey || isOnIceGoalStat;
      var showAttributedEvents = !statKey || !isOnIceGoalStat;

      var allowedTypeKeys = null;
      if (statKey && showAttributedEvents && STAT_TO_EVENT_TYPE_KEYS[statKey]) {
        allowedTypeKeys = {};
        STAT_TO_EVENT_TYPE_KEYS[statKey].forEach(function (k) {
          allowedTypeKeys[normTypeKey(k)] = true;
        });
      }

      var filtered = [];
        if (showAttributedEvents) {
          filtered = eventsRows.filter(function (row) {
            if (side) {
              var rs = rowSide(row);
            if (rs && rs !== side) return false;
          }
          var etKey = normTypeKey(getValue(row, ["Event Type", "Event"]));
          if (PLAYER_EVENT_TYPE_EXCLUDE[etKey]) return false;
          // Only show Completed Passes from shift spreadsheets (not TimeToScore) on the per-game page.
          if (etKey === "completedpass") {
            var src = String(getValue(row, ["Source", "source"]) || "").trim().toLowerCase();
            if (src && src.indexOf("shift") < 0 && src.indexOf("long") < 0) return false;
          }
          if (allowedTypeKeys && !allowedTypeKeys[etKey]) return false;

          var rowJ = extractJersey(getValue(row, ["Attributed Jerseys", "AttributedJerseys"]));
          if (playerJersey && rowJ && rowJ === extractJersey(playerJersey)) return true;
          var rowP = normName(getValue(row, ["Attributed Players", "AttributedPlayers", "Player", "Name"]));
          if (playerNameNorm && rowP && rowP === playerNameNorm) return true;
            return false;
          });
          sortRowsByPeriodAndGameClockDesc(filtered);
          filtered = filtered.filter(function (row) {
            return normTypeKey(getValue(row, ["Event Type", "Event"])) !== "penaltyexpired";
          });
        }

      var onIceGoals = [];
      var playerJerseyNorm = extractJersey(playerJersey);
      if (showOnIceGoals && side && playerJerseyNorm) {
        eventsRows.forEach(function (row) {
          if (normTypeKey(getValue(row, ["Event Type", "Event"])) !== "goal") return;
          var onIceRaw = "";
          if (side === "home") {
            onIceRaw =
              String(getValue(row, ["On-Ice Players (Home)", "On-Ice Players Home"]) || "").trim() ||
              String(getValue(row, ["On-Ice Players", "On-Ice Players (PM)"]) || "").trim();
          } else if (side === "away") {
            onIceRaw =
              String(getValue(row, ["On-Ice Players (Away)", "On-Ice Players Away"]) || "").trim() ||
              String(getValue(row, ["On-Ice Players", "On-Ice Players (PM)"]) || "").trim();
          }
          var nums = extractNumberSet(onIceRaw);
          if (!nums[playerJerseyNorm]) return;
          var scoringSide = rowSide(row);
          var fa = "";
          if (scoringSide === "home" || scoringSide === "away") {
            fa = scoringSide === side ? "For" : "Against";
          }
          var copy = Object.assign({}, row);
          copy.__forAgainst = fa;
          onIceGoals.push(copy);
        });
        sortRowsByPeriodAndGameClockDesc(onIceGoals);
        if (statKey === "gf_counted") {
          onIceGoals = onIceGoals.filter(function (r) { return String(r.__forAgainst || "") === "For"; });
        } else if (statKey === "ga_counted") {
          onIceGoals = onIceGoals.filter(function (r) { return String(r.__forAgainst || "") === "Against"; });
        }
      }

      var dlg = document.getElementById("events-drilldown-modal");
      var titleEl = document.getElementById("events-drilldown-title");
      var subtitleEl = document.getElementById("events-drilldown-subtitle");
      var bodyEl = document.getElementById("events-drilldown-body");
      var markClipsBtn = document.getElementById("events-drilldown-mark-clips");
      if (!dlg || !titleEl || !subtitleEl || !bodyEl) return;

      titleEl.textContent = "Player Events — " + (PLAYER_EVENTS_SCOPE_LABEL || "Game");
      var pLabel = playerName + (playerJersey ? " (#" + extractJersey(playerJersey) + ")" : "");
      subtitleEl.textContent = statLabel ? (pLabel + " • " + statLabel) : pLabel;
      bodyEl.innerHTML = "";
      closeDrilldownVideo();
      hmRenderPlayerEventsPageViews(playerId);
      hmRecordLeaguePageView("player_events", playerId);
      if (markClipsBtn) {
        markClipsBtn.style.display = "none";
        markClipsBtn.disabled = false;
        markClipsBtn.onclick = function (e) {
          try { e.preventDefault(); } catch (e2) {}
          hmMarkClipBaselines(bodyEl);
        };
      }

      if (!filtered.length && !onIceGoals.length) {
        var p = document.createElement("p");
        p.className = "muted";
        p.textContent = "No events matched this selection.";
        bodyEl.appendChild(p);
      } else {
          if (filtered.length) {
            if (!statKey) {
              var chain = buildShotChainTables(filtered);
              [
                ["Goals", chain.goals],
                ["Assists", chain.assists],
                ["xG (Expected Goal)", chain.xg],
                ["SOG", chain.sog],
                ["Shot", chain.shot],
              ].forEach(function (pair) {
                var label = pair[0];
                var rows = pair[1] || [];
                if (!rows.length) return;
                bodyEl.appendChild(makeEventsHeading("h4", label));
                buildEventsTable(bodyEl, rows, { hideGoalScorer: true, scorerName: playerName });
              });

              var chainKeys = { goal: true, assist: true, expectedgoal: true, xg: true, sog: true, shot: true };
              var remaining = filtered.filter(function (row) {
                return !chainKeys[normTypeKey(getValue(row, ["Event Type", "Event"]))];
              });
              if (remaining.length) {
                var byType = groupRows(remaining, function (r) {
                  return getValue(r, ["Event Type", "Event"]);
                });
                byType = moveGroupToEnd(byType, "completed pass");
                byType.order.forEach(function (k) {
                  bodyEl.appendChild(makeEventsHeading("h4", byType.groups[k].label));
                  buildEventsTable(bodyEl, byType.groups[k].rows, { hideGoalScorer: true, scorerName: playerName });
                });
              }
            } else if (statKey === "expected_goals") {
              var xgRows = buildShotChainTables(filtered).xg;
              if (xgRows.length) {
                bodyEl.appendChild(makeEventsHeading("h4", "xG (Expected Goal)"));
                buildEventsTable(bodyEl, xgRows, { hideGoalScorer: true, scorerName: playerName });
              }
            } else if (statKey === "sog") {
              var sogRows = buildShotChainTables(filtered).sog;
              if (sogRows.length) {
                bodyEl.appendChild(makeEventsHeading("h4", "SOG"));
                buildEventsTable(bodyEl, sogRows, { hideGoalScorer: true, scorerName: playerName });
              }
            } else if (statKey === "shots") {
              var shotRows = buildShotChainTables(filtered).shot;
              if (shotRows.length) {
                bodyEl.appendChild(makeEventsHeading("h4", "Shot"));
                buildEventsTable(bodyEl, shotRows, { hideGoalScorer: true, scorerName: playerName });
              }
            } else if (statKey === "goals") {
              var goalRows = buildShotChainTables(filtered).goals;
              if (goalRows.length) {
                bodyEl.appendChild(makeEventsHeading("h4", "Goals"));
                buildEventsTable(bodyEl, goalRows, { hideGoalScorer: true, scorerName: playerName });
              }
            } else {
              var byType = groupRows(filtered, function (r) {
                return getValue(r, ["Event Type", "Event"]);
              });
              byType = moveGroupToEnd(byType, "completed pass");
              byType.order.forEach(function (k) {
                bodyEl.appendChild(makeEventsHeading("h4", byType.groups[k].label));
                buildEventsTable(bodyEl, byType.groups[k].rows, { hideGoalScorer: true, scorerName: playerName });
              });
            }
          }

        // Keep derived On-Ice Goals (For/Against) at the bottom.
        if (onIceGoals.length) {
          var byFA = groupRows(onIceGoals, function (r) {
            var fa = String(r.__forAgainst || "").trim();
            return fa ? ("Goals " + fa) : "Goals";
          });
          ["goals for", "goals against"].forEach(function (k) {
            if (!byFA.groups[k]) return;
            bodyEl.appendChild(makeEventsHeading("h4", byFA.groups[k].label));
            buildEventsTable(bodyEl, byFA.groups[k].rows);
          });
          byFA.order.forEach(function (k) {
            if (k === "goals for" || k === "goals against") return;
            bodyEl.appendChild(makeEventsHeading("h4", byFA.groups[k].label));
            buildEventsTable(bodyEl, byFA.groups[k].rows);
          });
        }
        }

      try {
        hmRefreshClipViewCounts(bodyEl);
        dlg.showModal();
      } catch (e) {
        dlg.open = true;
      }
    }

    var closeBtn = document.getElementById("events-drilldown-close");
    if (closeBtn) {
      closeBtn.addEventListener("click", function () {
        var dlg = document.getElementById("events-drilldown-modal");
        if (!dlg) return;
        closeDrilldownVideo();
        try { dlg.close(); } catch (e) { dlg.open = false; }
      });
    }
    var drilldownDlg = document.getElementById("events-drilldown-modal");
    if (drilldownDlg) {
      drilldownDlg.addEventListener("close", closeDrilldownVideo);
    }

    document.querySelectorAll('table[data-player-stats-table="1"]').forEach(function (table) {
      var side = String(table.getAttribute("data-team-side") || "").trim().toLowerCase();
      var headerByKey = {};
      table.querySelectorAll("thead th[data-stat-key]").forEach(function (th) {
        var k = String(th.getAttribute("data-stat-key") || "").trim();
        if (k) headerByKey[k] = String(th.textContent || "").trim();
      });

      table.querySelectorAll("tbody tr").forEach(function (tr) {
        var tds = tr.querySelectorAll("td");
        if (tds.length < 2) return;
        var jerseyTxt = String(tds[0].textContent || "").trim();
        var nameCell = tr.querySelector('td[data-player-cell="name"]') || tds[1];
        var nameTxt = String(nameCell.textContent || "").trim();
        if (!nameTxt) return;

        if (nameCell) {
          var btn = nameCell.querySelector("button.player-events-btn");
          if (btn) {
            btn.addEventListener("click", function (e) {
              e.preventDefault();
              var pid = btn.getAttribute("data-player-id") || tr.getAttribute("data-player-id") || "";
              openDrilldown({ playerId: pid, playerName: nameTxt, playerJersey: jerseyTxt, teamSide: side, statKey: "", statLabel: "" });
            });
          }
        }

        tr.querySelectorAll("td[data-stat-key]").forEach(function (td) {
          var statKey = String(td.getAttribute("data-stat-key") || "").trim();
          if (!statKey) return;
          if (!STAT_TO_EVENT_TYPE_KEYS[statKey]) return;
          td.title = "Double-click to show events";
          td.style.cursor = "pointer";
          td.addEventListener("dblclick", function () {
            var pid = tr.getAttribute("data-player-id") || "";
            openDrilldown({
              playerId: pid,
              playerName: nameTxt,
              playerJersey: jerseyTxt,
              teamSide: side,
              statKey: statKey,
              statLabel: headerByKey[statKey] || statKey,
            });
          });
        });
      });
    });
  })();
</script>
{% endwith %}
{% endblock %}

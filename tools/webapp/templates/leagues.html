{% extends "layout.html" %}
{% block content %}
<h2>Leagues</h2>

{% if active_league and active_league.is_admin %}
  <div class="card" style="margin-bottom:1rem;">
    <h3>Active League Actions</h3>
    <p style="margin:.25rem 0 .75rem 0;"><strong>{{ active_league.name }}</strong></p>
    <form method="post" action="/leagues/recalc_div_ratings" style="display:inline;">
      {% csrf_token %}
      <button class="btn" type="submit">Recalc Ratings (All Teams)</button>
    </form>
    <p class="muted" style="margin:.75rem 0 0;">Updates Ratings. Auto-recalculates weekly (Wed midnight) once the timer is installed.</p>
  </div>
{% endif %}

<div class="card">
  <h3>Your Leagues</h3>
  {% if leagues %}
    <ul>
      {% for L in leagues %}
        <li>
          <strong>{{ L.name }}</strong>
          {% if L.is_shared %}<em>(shared)</em>{% endif %}
          {% if L.is_public %}<em>(public)</em>{% endif %}
          {% if L.is_admin %} — <a href="/leagues/{{ L.id }}/members">Manage Members</a>{% endif %}
          {% if L.is_admin %}
            — <form method="post" action="/leagues/{{ L.id }}/update" style="display:inline-block; margin-left:6px; vertical-align:top;">
                {% csrf_token %}
                <div style="display:flex; flex-direction:column; gap:.15rem; margin:.25rem 0;">
                  <div class="muted" style="font-size:.85rem; margin:.15rem 0 .1rem 0;">Visibility</div>
                  <label style="display:block;"><input type="checkbox" name="is_shared" value="1" {% if L.is_shared %}checked{% endif %}> Shared</label>
                  <label style="display:block;"><input type="checkbox" name="is_public" value="1" {% if L.is_public %}checked{% endif %}> Public</label>
                  <div class="muted" style="font-size:.85rem; margin:.35rem 0 .1rem 0;">Stats</div>
                  <label style="display:block;"><input type="checkbox" name="show_goalie_stats" value="1" {% if L.show_goalie_stats %}checked{% endif %}> Show goalie stats</label>
                  <label style="display:block;"><input type="checkbox" name="show_shift_data" value="1" {% if L.show_shift_data %}checked{% endif %}> Show shift data (TOI/Shifts)</label>
                </div>
                <button type="submit" class="btn" style="margin-top:.15rem;">Save</button>
              </form>
            — <form method="post" action="/leagues/{{ L.id }}/delete" style="display:inline" onsubmit="return confirm('This will delete the league and its data. Continue?')">
                {% csrf_token %}
                <button type="submit">Delete League</button>
              </form>
          {% endif %}
        </li>
      {% endfor %}
    </ul>
  {% else %}
    <p>No leagues yet.</p>
  {% endif %}
</div>

<div class="card">
  <h3>Create League</h3>
  <form method="post" action="/leagues/new">
    {% csrf_token %}
    <label>Name</label>
    <input type="text" name="name" required />
    <div class="muted" style="font-size:.85rem; margin:.5rem 0 .1rem 0;">Visibility</div>
    <label style="display:block;"><input type="checkbox" name="is_shared" value="1" /> Shared league</label>
    <label style="display:block;"><input type="checkbox" name="is_public" value="1" /> Public (viewable without login)</label>
    <div class="muted" style="font-size:.85rem; margin:.35rem 0 .1rem 0;">Stats</div>
    <label style="display:block;"><input type="checkbox" name="show_goalie_stats" value="1" /> Show goalie stats</label>
    <label style="display:block;"><input type="checkbox" name="show_shift_data" value="1" /> Show shift data (TOI/Shifts)</label>
    <button class="btn primary" type="submit">Create</button>
  </form>
  <p class="muted">You will be the administrator and can grant access to others.</p>
  <p class="muted">Use the League selector in the header to switch active context.</p>
  <p><a href="/leagues">Refresh</a></p>
  <form method="post" action="/league/select" style="margin-top:8px;">
    {% csrf_token %}
    <label>Switch Active League</label>
    <select name="league_id">
      <option value="">(My Data)</option>
      {% for L in leagues %}
        <option value="{{ L.id }}" {% if selected_league_id == L.id %}selected{% endif %}>{{ L.name }}</option>
      {% endfor %}
    </select>
    <button type="submit">Switch</button>
  </form>
</div>

{% endblock %}
